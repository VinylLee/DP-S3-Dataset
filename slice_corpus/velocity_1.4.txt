public interface Context Object put String key Object value Object get String key boolean containsKey Object key Object getKeys Object remove Object key public class NodeException extends Exception public NodeException String exceptionMessage Node node super exceptionMessage node literal node getLine node getColumn public class VelocityAppTestCase extends BaseTestCase implements TemplateTestBase private StringWriter compare1 new StringWriter private String input1 private String result1 public VelocityAppTestCase super try Velocity setProperty Velocity FILE_RESOURCE_LOADER_PATH FILE_RESOURCE_LOADER_PATH Velocity init catch Exception System err println printStackTrace System exit public static junit framework Test suite return new VelocityAppTestCase public void runTest VelocityContext context new VelocityContext context put context put try Velocity evaluate context compare1 input1 if result1 equals compare1 toString fail catch Exception fail getMessage public class UberspectImpl implements Uberspect UberspectLoggable private RuntimeLogger rlog private static Introspector introspector public void init throws Exception public void setRuntimeLogger RuntimeLogger runtimeLogger rlog runtimeLogger introspector new Introspector rlog public Iterator getIterator Object obj Info throws Exception if obj getClass isArray return new ArrayIterator obj else if obj instanceof Collection return Collection obj iterator else if obj instanceof Map return Map obj values iterator else if obj instanceof Iterator rlog warn getLine getColumn getTemplateName return Iterator obj else if obj instanceof Enumeration rlog warn getLine getColumn getTemplateName return new EnumerationIterator Enumeration obj rlog warn getLine getColumn getTemplateName return null public VelMethod getMethod Object obj String methodName Object args Info throws Exception if obj null return null Method introspector getMethod obj getClass methodName args return null new VelMethodImpl null public VelPropertyGet getPropertyGet Object obj String identifier Info throws Exception AbstractExecutor executor Class claz obj getClass executor new PropertyExecutor rlog introspector claz identifier if executor isAlive false executor new GetExecutor rlog introspector claz identifier if executor isAlive false executor new BooleanPropertyExecutor rlog introspector claz identifier return executor null new VelGetterImpl executor null public VelPropertySet getPropertySet Object obj String identifier Object arg Info throws Exception Class claz obj getClass VelPropertySet vs null VelMethod vm null try Object params arg try vm getMethod obj identifier params if vm null throw new NoSuchMethodException catch NoSuchMethodException nsme2 StringBuffer sb new StringBuffer sb append identifier if Character isLowerCase sb charAt sb setCharAt Character toUpperCase sb charAt else sb setCharAt Character toLowerCase sb charAt vm getMethod obj sb toString params if vm null throw new NoSuchMethodException catch NoSuchMethodException nsme if Map class isAssignableFrom claz Object params new Object new Object vm getMethod obj params if vm null return new VelSetterImpl vm identifier return vm null new VelSetterImpl vm null public class VelMethodImpl implements VelMethod Method method null public VelMethodImpl Method method private VelMethodImpl public Object invoke Object Object params throws Exception return method invoke params public boolean isCacheable return true public String getMethodName return method getName public Class getReturnType return method getReturnType public class VelGetterImpl implements VelPropertyGet AbstractExecutor ae null public VelGetterImpl AbstractExecutor exec ae exec private VelGetterImpl public Object invoke Object throws Exception return ae execute public boolean isCacheable return true public String getMethodName return ae getMethod getName public class VelSetterImpl implements VelPropertySet VelMethod vm null String putKey null public VelSetterImpl VelMethod velmethod this vm velmethod public VelSetterImpl VelMethod velmethod String key this vm velmethod putKey key private VelSetterImpl public Object invoke Object Object value throws Exception ArrayList al new ArrayList if putKey null al add putKey al add value else al add value return vm invoke al toArray public boolean isCacheable return true public String getMethodName return vm getMethodName public class ASTIncludeStatement extends SimpleNode public ASTIncludeStatement int id super id public ASTIncludeStatement Parser int id super id public Object jjtAccept ParserVisitor visitor Object data return visitor visit this data public class IntrospectorBase protected Map classMethodMaps new HashMap protected Set cachedClassNames new HashSet public Method getMethod Class String name Object params throws Exception if null throw new Exception name ClassMap classMap null synchronized classMethodMaps classMap ClassMap classMethodMaps get if classMap null if cachedClassNames contains getName clearCache classMap createClassMap return classMap findMethod name params protected ClassMap createClassMap Class ClassMap classMap new ClassMap classMethodMaps put classMap cachedClassNames add getName return classMap protected void clearCache classMethodMaps clear cachedClassNames new HashSet public class ASTIfStatement extends SimpleNode public ASTIfStatement int id super id public ASTIfStatement Parser int id super id public Object jjtAccept ParserVisitor visitor Object data return visitor visit this data public boolean render InternalContextAdapter context Writer writer throws IOException MethodInvocationException ResourceNotFoundException ParseErrorException if jjtGetChild evaluate context jjtGetChild render context writer return true int totalNodes jjtGetNumChildren for int totalNodes if jjtGetChild evaluate context jjtGetChild render context writer return true return true public void process InternalContextAdapter context ParserVisitor visitor public class EventCartridge implements ReferenceInsertionEventHandler NullSetEventHandler MethodExceptionEventHandler private ReferenceInsertionEventHandler rieh null private NullSetEventHandler nseh null private MethodExceptionEventHandler meeh null public boolean addEventHandler EventHandler ev if ev null return false boolean found false if ev instanceof ReferenceInsertionEventHandler rieh ReferenceInsertionEventHandler ev found true if ev instanceof NullSetEventHandler nseh NullSetEventHandler ev found true if ev instanceof MethodExceptionEventHandler meeh MethodExceptionEventHandler ev found true return found public boolean removeEventHandler EventHandler ev if ev null return false boolean found false if ev rieh rieh null found true if ev nseh nseh null found true if ev meeh meeh null found true return found public Object referenceInsert String reference Object value if rieh null return value return rieh referenceInsert reference value public boolean shouldLogOnNullSet String lhs String rhs if nseh null return true return nseh shouldLogOnNullSet lhs rhs public Object methodException Class claz String method Exception throws Exception if meeh null throw return meeh methodException claz method public final boolean attachToContext Context context if context instanceof InternalEventContext InternalEventContext iec InternalEventContext context iec attachEventCartridge this return true else return false public class MethodInvocationException extends VelocityException private String methodName private String referenceName private Throwable wrapped null public MethodInvocationException String message Throwable String methodName super message this wrapped this methodName methodName public String getMethodName return methodName public Throwable getWrappedThrowable return wrapped public void setReferenceName String ref referenceName ref public String getReferenceName return referenceName public class EventHandlingTestCase extends TestCase implements ReferenceInsertionEventHandler NullSetEventHandler MethodExceptionEventHandler LogSystem private String logString null private boolean exceptionSwitch true private static String NO_REFERENCE_VALUE private static String REFERENCE_VALUE public EventHandlingTestCase super try Velocity setProperty Velocity RUNTIME_LOG_LOGSYSTEM this Velocity init catch Exception System err println System exit public void init RuntimeServices rs public static junit framework Test suite return new EventHandlingTestCase public void runTest VelocityContext inner new VelocityContext EventCartridge ec new EventCartridge ec addEventHandler this ec attachToContext inner VelocityContext context new VelocityContext inner context put try String StringWriter new StringWriter Velocity evaluate context if toString equals REFERENCE_VALUE fail new StringWriter Velocity evaluate context if toString equals NO_REFERENCE_VALUE fail new StringWriter logString null Velocity evaluate context if logString null fail new StringWriter logString null Velocity evaluate context if logString null fail exceptionSwitch true context put this new StringWriter try Velocity evaluate context catch MethodInvocationException mee fail catch Exception fail exceptionSwitch false new StringWriter try Velocity evaluate context fail catch MethodInvocationException mee catch Exception fail catch ParseErrorException pee fail pee catch MethodInvocationException mee fail mee catch Exception fail public void throwException throws Exception throw new Exception public Object referenceInsert String reference Object value String null if value null REFERENCE_VALUE else if reference equals NO_REFERENCE_VALUE return public boolean shouldLogOnNullSet String lhs String rhs if lhs equals return false return true public Object methodException Class claz String method Exception throws Exception if exceptionSwitch method equals return throw public void logVelocityMessage int level String message logString message public class ClassMap private static final class CacheMiss private static final CacheMiss CACHE_MISS new CacheMiss private static final Object OBJECT new Object private Class clazz private Map methodCache new Hashtable private MethodMap methodMap new MethodMap public ClassMap Class clazz this clazz clazz populateMethodCache private ClassMap Class getCachedClass return clazz public Method findMethod String name Object params throws MethodMap AmbiguousException String methodKey makeMethodKey name params Object cacheEntry methodCache get methodKey if cacheEntry CACHE_MISS return null if cacheEntry null try cacheEntry methodMap find name params catch MethodMap AmbiguousException ae methodCache put methodKey CACHE_MISS throw ae if cacheEntry null methodCache put methodKey CACHE_MISS else methodCache put methodKey cacheEntry return Method cacheEntry private void populateMethodCache StringBuffer methodKey Method methods getAccessibleMethods clazz for int methods length Method method methods Method publicMethod getPublicMethod method if publicMethod null methodMap add publicMethod methodCache put makeMethodKey publicMethod publicMethod private String makeMethodKey Method method Class parameterTypes method getParameterTypes StringBuffer methodKey new StringBuffer method getName for int parameterTypes length if parameterTypes isPrimitive if parameterTypes equals Boolean TYPE methodKey append else if parameterTypes equals Byte TYPE methodKey append else if parameterTypes equals Character TYPE methodKey append else if parameterTypes equals Double TYPE methodKey append else if parameterTypes equals Float TYPE methodKey append else if parameterTypes equals Integer TYPE methodKey append else if parameterTypes equals Long TYPE methodKey append else if parameterTypes equals Short TYPE methodKey append else methodKey append parameterTypes getName return methodKey toString private static String makeMethodKey String method Object params StringBuffer methodKey new StringBuffer append method for int params length Object arg params if arg null arg OBJECT methodKey append arg getClass getName return methodKey toString private static Method getAccessibleMethods Class clazz Method methods clazz getMethods if Modifier isPublic clazz getModifiers return methods MethodInfo methodInfos new MethodInfo methods length for int methods length methodInfos new MethodInfo methods int upcastCount getAccessibleMethods clazz methodInfos if upcastCount methods length methods new Method upcastCount int for int methodInfos length MethodInfo methodInfo methodInfos if methodInfo upcast methods methodInfo method return methods private static int getAccessibleMethods Class clazz MethodInfo methodInfos int upcastCount int methodInfos length if Modifier isPublic clazz getModifiers for int upcastCount try MethodInfo methodInfo methodInfos if methodInfo upcast methodInfo tryUpcasting clazz upcastCount catch NoSuchMethodException if upcastCount return upcastCount Class superclazz clazz getSuperclass if superclazz null upcastCount getAccessibleMethods superclazz methodInfos upcastCount if upcastCount return upcastCount Class interfaces clazz getInterfaces for int interfaces length upcastCount getAccessibleMethods interfaces methodInfos upcastCount if upcastCount return upcastCount return upcastCount public static Method getPublicMethod Method method Class clazz method getDeclaringClass if clazz getModifiers Modifier PUBLIC return method return getPublicMethod clazz method getName method getParameterTypes private static Method getPublicMethod Class clazz String name Class paramTypes if clazz getModifiers Modifier PUBLIC try return clazz getMethod name paramTypes catch NoSuchMethodException return null Class superclazz clazz getSuperclass if superclazz null Method superclazzMethod getPublicMethod superclazz name paramTypes if superclazzMethod null return superclazzMethod Class interfaces clazz getInterfaces for int interfaces length Method interfaceMethod getPublicMethod interfaces name paramTypes if interfaceMethod null return interfaceMethod return null private static final class MethodInfo Method method String name Class parameterTypes boolean upcast MethodInfo Method method this method null name method getName parameterTypes method getParameterTypes upcast false void tryUpcasting Class clazz throws NoSuchMethodException method clazz getMethod name parameterTypes name null parameterTypes null upcast true public class StringUtils private static final String EOL System getProperty private static final int EOL_LENGTH EOL length public String concat List list StringBuffer sb new StringBuffer int size list size for int size sb append list get toString return sb toString static public String getPackageAsPath String pckge return pckge replace File separator charAt File separator static public String removeUnderScores String data String temp null StringBuffer out new StringBuffer temp data StringTokenizer st new StringTokenizer temp while st hasMoreTokens String element String st nextElement out append firstLetterCaps element return out toString static public String removeAndHump String data return removeAndHump data static public String removeAndHump String data String replaceThis String temp null StringBuffer out new StringBuffer temp data StringTokenizer st new StringTokenizer temp replaceThis while st hasMoreTokens String element String st nextElement out append capitalizeFirstLetter element return out toString static public String firstLetterCaps String data String firstLetter data substring toUpperCase String restLetters data substring toLowerCase return firstLetter restLetters static public String capitalizeFirstLetter String data String firstLetter data substring toUpperCase String restLetters data substring return firstLetter restLetters public static String split String line String delim List list new ArrayList StringTokenizer new StringTokenizer line delim while hasMoreTokens list add nextToken return String list toArray new String list size public static String chop String int return chop EOL public static String chop String int String eol if null eol null return int length length if eol length endsWith eol length if length if length length return substring length public static StringBuffer stringSubstitution String argStr Hashtable vars return stringSubstitution argStr Map vars public static StringBuffer stringSubstitution String argStr Map vars StringBuffer argBuf new StringBuffer for int cIdx cIdx argStr length char ch argStr charAt cIdx switch ch case StringBuffer nameBuf new StringBuffer for cIdx cIdx argStr length cIdx ch argStr charAt cIdx if ch Character isLetterOrDigit ch nameBuf append ch else break if nameBuf length String value String vars get nameBuf toString if value null argBuf append value break default argBuf append ch cIdx break return argBuf public static String fileContentsToString String file String contents File new File file if exists try FileReader fr new FileReader char template new char int length fr read template contents new String template catch Exception System out println printStackTrace return contents public static String collapseNewlines String argStr char last argStr charAt StringBuffer argBuf new StringBuffer for int cIdx cIdx argStr length cIdx char ch argStr charAt cIdx if ch last argBuf append ch last ch return argBuf toString public static String collapseSpaces String argStr char last argStr charAt StringBuffer argBuf new StringBuffer for int cIdx cIdx argStr length cIdx char ch argStr charAt cIdx if ch last argBuf append ch last ch return argBuf toString public static final String sub String line String oldString String newString int if line indexOf oldString char line2 line toCharArray char newString2 newString toCharArray int oLength oldString length StringBuffer buf new StringBuffer line2 length buf append line2 append newString2 oLength int while line indexOf oldString buf append line2 append newString2 oLength buf append line2 line2 length return buf toString return line public static final String stackTrace Throwable String foo null try ByteArrayOutputStream ostr new ByteArrayOutputStream printStackTrace new PrintWriter ostr true foo ostr toString catch Exception return foo public static final String normalizePath String path String normalized path if normalized indexOf normalized normalized replace if normalized startsWith normalized normalized while true if index break normalized normalized substring index normalized substring index while true int index normalized indexOf if index break normalized normalized substring index normalized substring index while true int index normalized indexOf if index break normalized normalized substring index normalized substring index while true int index normalized indexOf if index break if index int index2 normalized lastIndexOf index normalized normalized substring index2 normalized substring index return normalized public String select boolean state String trueString String falseString if state return trueString else return falseString public boolean allEmpty List list int size list size for int size if list get null list get toString length return false return true public class ClasspathResourceLoader extends ResourceLoader public void init ExtendedProperties configuration rsvc info rsvc info public synchronized InputStream getResourceStream String name throws ResourceNotFoundException InputStream result null if name null name length throw new ResourceNotFoundException try ClassLoader classLoader this getClass getClassLoader result classLoader getResourceAsStream name catch Exception fnfe throw new ResourceNotFoundException fnfe getMessage return result public boolean isSourceModified Resource resource return false public long getLastModified Resource resource return public interface RuntimeConstants public static final String RUNTIME_LOG public static final String RUNTIME_LOG_LOGSYSTEM public static final String RUNTIME_LOG_LOGSYSTEM_CLASS public static final String RUNTIME_LOG_ERROR_STACKTRACE public static final String RUNTIME_LOG_WARN_STACKTRACE public static final String RUNTIME_LOG_INFO_STACKTRACE public static final String RUNTIME_LOG_REFERENCE_LOG_INVALID public final static String DEBUG_PREFIX public final static String INFO_PREFIX public final static String WARN_PREFIX public final static String ERROR_PREFIX public final static String UNKNOWN_PREFIX public final static String LOGSYSTEM_LOG4J_PATTERN public final static String LOGSYSTEM_LOG4J_FILE_SIZE public final static String LOGSYSTEM_LOG4J_FILE_BACKUPS public final static String LOGSYSTEM_LOG4J_SYSLOGD_HOST public final static String LOGSYSTEM_LOG4J_SYSLOGD_FACILITY public final static String LOGSYSTEM_LOG4J_REMOTE_HOST public final static String LOGSYSTEM_LOG4J_REMOTE_PORT public final static String LOGSYSTEM_LOG4J_EMAIL_SERVER public final static String LOGSYSTEM_LOG4J_EMAIL_FROM public final static String LOGSYSTEM_LOG4J_EMAIL_TO public final static String LOGSYSTEM_LOG4J_EMAIL_SUBJECT public final static String LOGSYSTEM_LOG4J_EMAIL_BUFFER_SIZE public static final String COUNTER_NAME public static final String COUNTER_INITIAL_VALUE public static String ERRORMSG_START public static String ERRORMSG_END public static String PARSE_DIRECTIVE_MAXDEPTH public static String RESOURCE_MANAGER_CLASS public static String RESOURCE_MANAGER_CACHE_CLASS public static final String RESOURCE_MANAGER_LOGWHENFOUND public static final String RESOURCE_LOADER public static final String FILE_RESOURCE_LOADER_PATH public static final String FILE_RESOURCE_LOADER_CACHE public static final String VM_LIBRARY public final static String VM_LIBRARY_AUTORELOAD public static final String VM_PERM_ALLOW_INLINE public final static String VM_PERM_ALLOW_INLINE_REPLACE_GLOBAL public final static String VM_PERM_INLINE_LOCAL public final static String VM_MESSAGES_ON public final static String VM_CONTEXT_LOCALSCOPE public static String INTERPOLATE_STRINGLITERALS public static final String INPUT_ENCODING public static final String OUTPUT_ENCODING public static final String ENCODING_DEFAULT final static String DEFAULT_RUNTIME_PROPERTIES final static String DEFAULT_RUNTIME_DIRECTIVES final static int NUMBER_OF_PARSERS final static String PARSER_POOL_SIZE final static String UBERSPECT_CLASSNAME public class Escape public Escape public static final String getText String st StringBuffer buff new StringBuffer char block st toCharArray String stEntity null int last for last block length switch block case stEntity break case stEntity break case stEntity break case stEntity break default if stEntity null buff append block last last buff append stEntity stEntity null last if last block length buff append block last last return buff toString public class VelocimacroFactory private RuntimeServices rsvc null private VelocimacroManager vmManager null private boolean replaceAllowed false private boolean addNewAllowed true private boolean templateLocal false private boolean blather false private boolean autoReloadLibrary false private Vector macroLibVec null private Map libModMap public VelocimacroFactory RuntimeServices rs this rsvc rs libModMap new HashMap vmManager new VelocimacroManager rsvc public void initVelocimacro synchronized this setReplacementPermission true setBlather true logVMMessageInfo vmManager setNamespaceUsage false Object libfiles rsvc getProperty RuntimeConstants VM_LIBRARY if libfiles null if libfiles instanceof Vector macroLibVec Vector libfiles else if libfiles instanceof String macroLibVec new Vector macroLibVec addElement libfiles for int macroLibVec size String lib String macroLibVec elementAt if lib null lib equals vmManager setRegisterFromLib true logVMMessageInfo lib try Template template rsvc getTemplate lib Twonk twonk new Twonk twonk template template twonk modificationTime template getLastModified libModMap put lib twonk catch Exception logVMMessageInfo lib logVMMessageInfo vmManager setRegisterFromLib false setAddMacroPermission true if rsvc getBoolean RuntimeConstants VM_PERM_ALLOW_INLINE true setAddMacroPermission false logVMMessageInfo else logVMMessageInfo setReplacementPermission false if rsvc getBoolean RuntimeConstants VM_PERM_ALLOW_INLINE_REPLACE_GLOBAL false setReplacementPermission true logVMMessageInfo else logVMMessageInfo vmManager setNamespaceUsage true setTemplateLocalInline rsvc getBoolean RuntimeConstants VM_PERM_INLINE_LOCAL false if getTemplateLocalInline logVMMessageInfo else logVMMessageInfo vmManager setTemplateLocalInlineVM getTemplateLocalInline setBlather rsvc getBoolean RuntimeConstants VM_MESSAGES_ON true if getBlather logVMMessageInfo else logVMMessageInfo setAutoload rsvc getBoolean RuntimeConstants VM_LIBRARY_AUTORELOAD false if getAutoload logVMMessageInfo else logVMMessageInfo rsvc info return public boolean addVelocimacro String name String macroBody String argArray String sourceTemplate if name null macroBody null argArray null sourceTemplate null logVMMessageWarn return false if canAddVelocimacro name sourceTemplate return false synchronized this vmManager addVM name macroBody argArray sourceTemplate if blather String argArray for int argArray length argArray sourceTemplate logVMMessageInfo return true private boolean canAddVelocimacro String name String sourceTemplate if getAutoload for int macroLibVec size String lib String macroLibVec elementAt if lib equals sourceTemplate return true if addNewAllowed logVMMessageWarn name return false if templateLocal if isVelocimacro name sourceTemplate replaceAllowed logVMMessageWarn name return false return true private void logVMMessageInfo String if blather rsvc info private void logVMMessageWarn String if blather rsvc warn public boolean isVelocimacro String vm String sourceTemplate synchronized this if vmManager get vm sourceTemplate null return true return false public Directive getVelocimacro String vmName String sourceTemplate VelocimacroProxy vp null synchronized this vp vmManager get vmName sourceTemplate if vp null getAutoload String lib vmManager getLibraryName vmName sourceTemplate if lib null try Twonk tw Twonk libModMap get lib if tw null Template template tw template long tt tw modificationTime long ft template getResourceLoader getLastModified template if ft tt logVMMessageInfo lib tw modificationTime ft template rsvc getTemplate lib tw template template tw modificationTime template getLastModified catch Exception logVMMessageInfo lib vp vmManager get vmName sourceTemplate return vp public boolean dumpVMNamespace String namespace return vmManager dumpNamespace namespace private void setTemplateLocalInline boolean templateLocal private boolean getTemplateLocalInline return templateLocal private boolean setAddMacroPermission boolean arg boolean addNewAllowed addNewAllowed arg return private boolean setReplacementPermission boolean arg boolean replaceAllowed replaceAllowed arg return private void setBlather boolean blather private boolean getBlather return blather private void setAutoload boolean autoReloadLibrary private boolean getAutoload return autoReloadLibrary private class Twonk public Template template public long modificationTime public class ASTAddNode extends SimpleNode public ASTAddNode int id super id public ASTAddNode Parser int id super id public Object jjtAccept ParserVisitor visitor Object data return visitor visit this data public Object value InternalContextAdapter context throws MethodInvocationException Object left jjtGetChild value context Object right jjtGetChild value context if left null right null rsvc error left null jjtGetChild left null literal context getCurrentTemplateName getLine getColumn return null if left instanceof Integer right instanceof Integer rsvc error left instanceof Integer context getCurrentTemplateName getLine getColumn return null return new Integer Integer left intValue Integer right intValue public class Macro extends Directive private static boolean debugMode false public String getName return public int getType return BLOCK public boolean render InternalContextAdapter context Writer writer Node node throws IOException return true public void init RuntimeServices rs InternalContextAdapter context Node node throws Exception super init rs context node return public static void processAndRegister RuntimeServices rs Node node String sourceTemplate throws IOException ParseException int numArgs node jjtGetNumChildren if numArgs rs error numArgs throw new MacroParseException int firstType node jjtGetChild getType if firstType ParserTreeConstants JJTWORD Token node jjtGetChild getFirstToken throw new MacroParseException ParserTreeConstants jjtNodeName firstType String argArray getArgArray node List macroArray getASTAsStringArray node jjtGetChild numArgs StringBuffer temp new StringBuffer for int macroArray size temp append macroArray get String macroBody temp toString boolean bRet rs addVelocimacro argArray macroBody argArray sourceTemplate return private static String getArgArray Node node int numArgs node jjtGetNumChildren String argArray new String numArgs int while numArgs argArray node jjtGetChild getFirstToken image if if argArray startsWith argArray argArray substring argArray length if debugMode System out println numArgs System out print argArray for numArgs System out print argArray System out println return argArray private static List getASTAsStringArray Node rootNode Token rootNode getFirstToken Token tLast rootNode getLastToken ArrayList list new ArrayList rootNode getFirstToken while tLast list add NodeUtils tokenLiteral next list add NodeUtils tokenLiteral return list public interface ParserVisitor public Object visit SimpleNode node Object data public Object visit ASTprocess node Object data public Object visit ASTComment node Object data public Object visit ASTNumberLiteral node Object data public Object visit ASTStringLiteral node Object data public Object visit ASTIdentifier node Object data public Object visit ASTWord node Object data public Object visit ASTDirective node Object data public Object visit ASTBlock node Object data public Object visit ASTObjectArray node Object data public Object visit ASTMethod node Object data public Object visit ASTReference node Object data public Object visit ASTTrue node Object data public Object visit ASTFalse node Object data public Object visit ASTText node Object data public Object visit ASTIfStatement node Object data public Object visit ASTElseStatement node Object data public Object visit ASTElseIfStatement node Object data public Object visit ASTSetDirective node Object data public Object visit ASTExpression node Object data public Object visit ASTAssignment node Object data public Object visit ASTOrNode node Object data public Object visit ASTAndNode node Object data public Object visit ASTEQNode node Object data public Object visit ASTNENode node Object data public Object visit ASTLTNode node Object data public Object visit ASTGTNode node Object data public Object visit ASTLENode node Object data public Object visit ASTGENode node Object data public Object visit ASTAddNode node Object data public Object visit ASTSubtractNode node Object data public Object visit ASTMulNode node Object data public Object visit ASTDivNode node Object data public Object visit ASTModNode node Object data public Object visit ASTNotNode node Object data public class AvalonLogSystem implements LogSystem private Logger logger null private RuntimeServices rsvc null public AvalonLogSystem public void init RuntimeServices rs throws Exception this rsvc rs String loggerName String rsvc getProperty if loggerName null this logger Hierarchy getDefaultHierarchy getLoggerFor loggerName else String logfile String rsvc getProperty RuntimeConstants RUNTIME_LOG try init logfile logVelocityMessage logfile catch Exception System out println System err println throw new Exception public void init String logFile throws Exception FileTarget target new FileTarget new File logFile false new VelocityFormatter logger Hierarchy getDefaultHierarchy getLoggerFor rsvc toString logger setPriority Priority DEBUG logger setLogTargets new LogTarget target public void logVelocityMessage int level String message switch level case LogSystem WARN_ID logger warn RuntimeConstants WARN_PREFIX message break case LogSystem INFO_ID logger info RuntimeConstants INFO_PREFIX message break case LogSystem DEBUG_ID logger debug RuntimeConstants DEBUG_PREFIX message break case LogSystem ERROR_ID logger error RuntimeConstants ERROR_PREFIX message break default logger info message break public class ASTFalse extends SimpleNode private static Boolean value Boolean FALSE public ASTFalse int id super id public ASTFalse Parser int id super id public Object jjtAccept ParserVisitor visitor Object data return visitor visit this data public boolean evaluate InternalContextAdapter context return false public Object value InternalContextAdapter context return value public class RuntimeInstance implements RuntimeConstants RuntimeServices private VelocimacroFactory vmFactory null private LogSystem logSystem new PrimordialLogSystem private SimplePool parserPool private boolean initialized private ExtendedProperties overridingProperties null private Hashtable runtimeDirectives private ExtendedProperties configuration new ExtendedProperties private ResourceManager resourceManager null private Introspector introspector null private Map applicationAttributes null private Uberspect uberSpect public RuntimeInstance vmFactory new VelocimacroFactory this introspector new Introspector this applicationAttributes new HashMap public synchronized void init throws Exception if initialized false info info info initializeProperties initializeLogger initializeResourceManager initializeDirectives initializeParserPool initializeIntrospection vmFactory initVelocimacro info initialized true private void initializeIntrospection throws Exception String rm getString RuntimeConstants UBERSPECT_CLASSNAME if rm null rm length Object null try Class forName rm newInstance catch ClassNotFoundException cnfe String err rm error err throw new Exception err if instanceof Uberspect String err rm error err throw new Exception err uberSpect Uberspect if uberSpect instanceof UberspectLoggable UberspectLoggable uberSpect setRuntimeLogger this uberSpect init else String err error err throw new Exception err private void setDefaultProperties try InputStream inputStream getClass getResourceAsStream DEFAULT_RUNTIME_PROPERTIES configuration load inputStream info new File DEFAULT_RUNTIME_PROPERTIES getPath catch IOException ioe System err println public void setProperty String key Object value if overridingProperties null overridingProperties new ExtendedProperties overridingProperties setProperty key value public void setConfiguration ExtendedProperties configuration if overridingProperties null overridingProperties configuration else if overridingProperties configuration overridingProperties combine configuration public void addProperty String key Object value if overridingProperties null overridingProperties new ExtendedProperties overridingProperties addProperty key value public void clearProperty String key if overridingProperties null overridingProperties clearProperty key public Object getProperty String key return configuration getProperty key private void initializeProperties if configuration isInitialized false setDefaultProperties if overridingProperties null configuration combine overridingProperties public void init Properties throws Exception overridingProperties ExtendedProperties convertProperties init public void init String configurationFile throws Exception overridingProperties new ExtendedProperties configurationFile init private void initializeResourceManager throws Exception String rm getString RuntimeConstants RESOURCE_MANAGER_CLASS if rm null rm length Object null try Class forName rm newInstance catch ClassNotFoundException cnfe String err rm error err throw new Exception err if instanceof ResourceManager String err rm error err throw new Exception err resourceManager ResourceManager resourceManager initialize this else String err error err throw new Exception err private void initializeLogger throws Exception if logSystem instanceof PrimordialLogSystem PrimordialLogSystem pls PrimordialLogSystem logSystem logSystem LogManager createLogSystem this if logSystem null logSystem new NullLogSystem else pls dumpLogMessages logSystem private void initializeDirectives throws Exception runtimeDirectives new Hashtable Properties directiveProperties new Properties InputStream inputStream getClass getResourceAsStream DEFAULT_RUNTIME_DIRECTIVES if inputStream null throw new Exception directiveProperties load inputStream Enumeration directiveClasses directiveProperties elements while directiveClasses hasMoreElements String directiveClass String directiveClasses nextElement loadDirective directiveClass String userdirective configuration getStringArray for int userdirective length loadDirective userdirective private void loadDirective String directiveClass String caption try Object Class forName directiveClass newInstance if instanceof Directive Directive directive Directive runtimeDirectives put directive getName directive info caption directiveClass else error caption directiveClass catch Exception error caption directiveClass private void initializeParserPool int numParsers getInt PARSER_POOL_SIZE NUMBER_OF_PARSERS parserPool new SimplePool numParsers for int numParsers parserPool put createNewParser info numParsers public Parser createNewParser Parser parser new Parser this parser setDirectives runtimeDirectives return parser public SimpleNode parse Reader reader String templateName throws ParseException return parse reader templateName true public SimpleNode parse Reader reader String templateName boolean dumpNamespace throws ParseException SimpleNode ast null Parser parser Parser parserPool get boolean madeNew false if parser null error parser createNewParser if parser null madeNew true if parser null try if dumpNamespace dumpVMNamespace templateName ast parser parse reader templateName finally if madeNew parserPool put parser else error return ast public Template getTemplate String name throws ResourceNotFoundException ParseErrorException Exception return getTemplate name getString INPUT_ENCODING ENCODING_DEFAULT public Template getTemplate String name String encoding throws ResourceNotFoundException ParseErrorException Exception return Template resourceManager getResource name ResourceManager RESOURCE_TEMPLATE encoding public ContentResource getContent String name throws ResourceNotFoundException ParseErrorException Exception return getContent name getString INPUT_ENCODING ENCODING_DEFAULT public ContentResource getContent String name String encoding throws ResourceNotFoundException ParseErrorException Exception return ContentResource resourceManager getResource name ResourceManager RESOURCE_CONTENT encoding public String getLoaderNameForResource String resourceName return resourceManager getLoaderNameForResource resourceName private boolean showStackTrace if configuration isInitialized return getBoolean RUNTIME_LOG_WARN_STACKTRACE false else return false private void log int level Object message String out if showStackTrace message instanceof Throwable message instanceof Exception out StringUtils stackTrace Throwable message else out message toString logSystem logVelocityMessage level out public void warn Object message log LogSystem WARN_ID message public void info Object message log LogSystem INFO_ID message public void error Object message log LogSystem ERROR_ID message public void debug Object message log LogSystem DEBUG_ID message public String getString String key String defaultValue return configuration getString key defaultValue public Directive getVelocimacro String vmName String templateName return vmFactory getVelocimacro vmName templateName public boolean addVelocimacro String name String macro String argArray String sourceTemplate return vmFactory addVelocimacro name macro argArray sourceTemplate public boolean isVelocimacro String vmName String templateName return vmFactory isVelocimacro vmName templateName public boolean dumpVMNamespace String namespace return vmFactory dumpVMNamespace namespace public String getString String key return configuration getString key public int getInt String key return configuration getInt key public int getInt String key int defaultValue return configuration getInt key defaultValue public boolean getBoolean String key boolean def return configuration getBoolean key def public ExtendedProperties getConfiguration return configuration public Introspector getIntrospector return introspector public Object getApplicationAttribute Object key return applicationAttributes get key public Object setApplicationAttribute Object key Object return applicationAttributes put key public Uberspect getUberspect return uberSpect public class JarResourceLoader extends ResourceLoader private Hashtable entryDirectory new Hashtable private Hashtable jarfiles new Hashtable public void init ExtendedProperties configuration rsvc info Vector paths configuration getVector if paths null paths size paths configuration getVector if paths null paths size rsvc warn rsvc info paths size for int paths size loadJar String paths get rsvc info private void loadJar String path rsvc info path if path null rsvc error if path startsWith rsvc error if path endsWith path closeJar path JarHolder temp new JarHolder rsvc path addEntries temp getEntries jarfiles put temp getUrlPath temp private void closeJar String path if jarfiles containsKey path JarHolder theJar JarHolder jarfiles get path theJar close private synchronized void addEntries Hashtable entries entryDirectory putAll entries public synchronized InputStream getResourceStream String source throws ResourceNotFoundException InputStream results null if source null source length throw new ResourceNotFoundException String normalizedPath StringUtils normalizePath source if normalizedPath null normalizedPath length String msg normalizedPath rsvc error msg throw new ResourceNotFoundException msg if normalizedPath startsWith normalizedPath normalizedPath substring if entryDirectory containsKey normalizedPath String jarurl String entryDirectory get normalizedPath if jarfiles containsKey jarurl JarHolder holder JarHolder jarfiles get jarurl results holder getResource normalizedPath return results throw new ResourceNotFoundException source public boolean isSourceModified Resource resource return true public long getLastModified Resource resource return public class InlineScopeVMTestCase extends BaseTestCase implements TemplateTestBase private static final String TEST_CASE_NAME InlineScopeVMTestCase super TEST_CASE_NAME try Velocity setProperty Velocity VM_PERM_ALLOW_INLINE_REPLACE_GLOBAL Velocity setProperty Velocity VM_PERM_INLINE_LOCAL Velocity setProperty Velocity FILE_RESOURCE_LOADER_PATH FILE_RESOURCE_LOADER_PATH Velocity init catch Exception System err println TEST_CASE_NAME System exit public static junit framework Test suite return new InlineScopeVMTestCase public void runTest try assureResultsDirectoryExists RESULT_DIR Template template2 RuntimeSingleton getTemplate getFileName null TMPL_FILE_EXT Template template1 RuntimeSingleton getTemplate getFileName null TMPL_FILE_EXT FileOutputStream fos1 new FileOutputStream getFileName RESULT_DIR RESULT_FILE_EXT FileOutputStream fos2 new FileOutputStream getFileName RESULT_DIR RESULT_FILE_EXT Writer writer1 new BufferedWriter new OutputStreamWriter fos1 Writer writer2 new BufferedWriter new OutputStreamWriter fos2 VelocityContext context new VelocityContext template1 merge context writer1 writer1 flush writer1 close template2 merge context writer2 writer2 flush writer2 close if isMatch RESULT_DIR COMPARE_DIR RESULT_FILE_EXT CMP_FILE_EXT isMatch RESULT_DIR COMPARE_DIR RESULT_FILE_EXT CMP_FILE_EXT fail catch Exception fail getMessage public class FileUtil static public String mkdir String try if new File mkdirs return else return catch Exception return toString public static File file String File new File return public static File file String base String File new File base return public class VMContext implements InternalContextAdapter HashMap vmproxyhash new HashMap HashMap localcontext new HashMap InternalContextAdapter innerContext null InternalContextAdapter wrappedContext null private boolean localcontextscope false public VMContext InternalContextAdapter inner RuntimeServices rsvc localcontextscope rsvc getBoolean RuntimeConstants VM_CONTEXT_LOCALSCOPE false wrappedContext inner innerContext inner getBaseContext public Context getInternalUserContext return innerContext getInternalUserContext public InternalContextAdapter getBaseContext return innerContext getBaseContext public void addVMProxyArg VMProxyArg vmpa String key vmpa getContextReference if vmpa isConstant localcontext put key vmpa getObject wrappedContext else vmproxyhash put key vmpa public Object put String key Object value VMProxyArg vmpa VMProxyArg vmproxyhash get key if vmpa null return vmpa setObject wrappedContext value else if localcontextscope return localcontext put key value else if localcontext containsKey key return localcontext put key value else return innerContext put key value public Object get String key Object null VMProxyArg vmpa VMProxyArg vmproxyhash get key if vmpa null vmpa getObject wrappedContext else if localcontextscope localcontext get key else localcontext get key if null innerContext get key return public boolean containsKey Object key return false public Object getKeys return vmproxyhash keySet toArray public Object remove Object key return vmproxyhash remove key public void pushCurrentTemplateName String innerContext pushCurrentTemplateName public void popCurrentTemplateName innerContext popCurrentTemplateName public String getCurrentTemplateName return innerContext getCurrentTemplateName public Object getTemplateNameStack return innerContext getTemplateNameStack public IntrospectionCacheData icacheGet Object key return innerContext icacheGet key public void icachePut Object key IntrospectionCacheData innerContext icachePut key public EventCartridge attachEventCartridge EventCartridge ec return innerContext attachEventCartridge ec public EventCartridge getEventCartridge return innerContext getEventCartridge public void setCurrentResource Resource innerContext setCurrentResource public Resource getCurrentResource return innerContext getCurrentResource public class SimpleLog4JLogSystem implements LogSystem private RuntimeServices rsvc null protected Category logger null public SimpleLog4JLogSystem public void init RuntimeServices rs rsvc rs String categoryname String rsvc getProperty if categoryname null logger Category getInstance categoryname logVelocityMessage categoryname return String logfile rsvc getString RuntimeConstants RUNTIME_LOG try internalInit logfile logVelocityMessage logfile catch Exception System out println private void internalInit String logfile throws Exception logger Category getInstance this getClass getName logger setAdditivity false logger setPriority Priority DEBUG RollingFileAppender appender new RollingFileAppender new PatternLayout logfile true appender setMaxBackupIndex appender setMaximumFileSize logger addAppender appender public void logVelocityMessage int level String message switch level case LogSystem WARN_ID logger warn message break case LogSystem INFO_ID logger info message break case LogSystem DEBUG_ID logger debug message break case LogSystem ERROR_ID logger error message break default logger debug message break protected void finalize throws Throwable shutdown public void shutdown Enumeration appenders logger getAllAppenders while appenders hasMoreElements Appender appender Appender appenders nextElement appender close public class SimpleNode implements Node protected RuntimeServices rsvc null protected Node parent protected Node children protected int id protected Parser parser public boolean state protected boolean invalid false protected Token first last public SimpleNode int id public SimpleNode Parser int this parser public void jjtOpen public void jjtClose public void setFirstToken Token this first public Token getFirstToken return first public Token getLastToken return last public void jjtSetParent Node parent public Node jjtGetParent return parent public void jjtAddChild Node int if children null children new Node else if children length Node new Node System arraycopy children children length children children public Node jjtGetChild int return children public int jjtGetNumChildren return children null children length public Object jjtAccept ParserVisitor visitor Object data return visitor visit this data public Object childrenAccept ParserVisitor visitor Object data if children null for int children length children jjtAccept visitor data return data public String toString String prefix return prefix toString public void dump String prefix System out println toString prefix if children null for int children length SimpleNode SimpleNode children if null dump prefix public String literal Token first StringBuffer sb new StringBuffer image while last next sb append image return sb toString public Object init InternalContextAdapter context Object data throws Exception rsvc RuntimeServices data int jjtGetNumChildren for try jjtGetChild init context data catch ReferenceException re rsvc error re return data public boolean evaluate InternalContextAdapter context throws MethodInvocationException return false public Object value InternalContextAdapter context throws MethodInvocationException return null public boolean render InternalContextAdapter context Writer writer throws IOException MethodInvocationException ParseErrorException ResourceNotFoundException int jjtGetNumChildren for jjtGetChild render context writer return true public Object execute Object InternalContextAdapter context throws MethodInvocationException return null public int getType return id public void setInfo int info this info info public int getInfo return info public void setInvalid invalid true public boolean isInvalid return invalid public int getLine return first beginLine public int getColumn return first beginColumn public class ParserTokenManager implements ParserConstants private int fileDepth private int lparen private int rparen Stack stateStack new Stack public boolean debugPrint false private boolean inReference public boolean inDirective private boolean inComment public boolean inSet public boolean stateStackPop Hashtable try Hashtable stateStack pop catch EmptyStackException lparen SwitchTo DEFAULT return false if debugPrint System out println stateStack size Integer get intValue Integer get intValue lparen Integer get intValue rparen Integer get intValue SwitchTo Integer get intValue return true public boolean stateStackPush if debugPrint System out println stateStack size curLexState Hashtable new Hashtable put new Integer curLexState put new Integer lparen put new Integer rparen lparen stateStack push return true public void clearStateVars stateStack clear lparen rparen inReference false inDirective false inComment false inSet false return private void RPARENHandler boolean closed false if inComment closed true while closed if lparen if lparen rparen stateStackPop else rparen closed true else if stateStackPop break public java io PrintStream debugStream System out public void setDebugStream java io PrintStream ds debugStream ds private final int jjStopStringLiteralDfa_0 int pos long active0 switch pos case if active0 jjmatchedKind return if active0 return if active0 return return case if active0 jjmatchedKind jjmatchedPos return if active0 return return case if active0 jjmatchedKind jjmatchedPos return return case if active0 jjmatchedKind jjmatchedPos return if active0 return return default return private final int jjStartNfa_0 int pos long active0 return jjMoveNfa_0 jjStopStringLiteralDfa_0 pos active0 pos private final int jjStopAtPos int pos int kind jjmatchedKind kind jjmatchedPos pos return pos private final int jjStartNfaWithStates_0 int pos int kind int state jjmatchedKind kind jjmatchedPos pos try curChar input_stream readChar catch java io IOException return pos return jjMoveNfa_0 state pos private final int jjMoveStringLiteralDfa0_0 switch curChar case jjmatchedKind return jjMoveStringLiteralDfa1_0 case jjmatchedKind return jjMoveStringLiteralDfa1_0 case return jjStopAtPos case return jjMoveStringLiteralDfa1_0 case return jjStopAtPos case return jjStopAtPos case return jjStopAtPos case return jjStopAtPos case return jjStartNfaWithStates_0 case return jjMoveStringLiteralDfa1_0 case return jjStopAtPos case jjmatchedKind return jjMoveStringLiteralDfa1_0 case jjmatchedKind return jjMoveStringLiteralDfa1_0 case jjmatchedKind return jjMoveStringLiteralDfa1_0 case return jjStopAtPos case return jjStopAtPos case return jjMoveStringLiteralDfa1_0 case return jjMoveStringLiteralDfa1_0 case return jjMoveStringLiteralDfa1_0 default return jjMoveNfa_0 private final int jjMoveStringLiteralDfa1_0 long active0 try curChar input_stream readChar catch java io IOException jjStopStringLiteralDfa_0 active0 return switch curChar case if active0 return jjStopAtPos break case if active0 return jjStopAtPos break case if active0 return jjStartNfaWithStates_0 break case if active0 return jjStopAtPos break case if active0 return jjStopAtPos else if active0 return jjStopAtPos else if active0 return jjStopAtPos else if active0 return jjStopAtPos break case return jjMoveStringLiteralDfa2_0 active0 case return jjMoveStringLiteralDfa2_0 active0 case if active0 return jjStopAtPos break default break return jjStartNfa_0 active0 private final int jjMoveStringLiteralDfa2_0 long old0 long active0 if active0 old0 return jjStartNfa_0 old0 try curChar input_stream readChar catch java io IOException jjStopStringLiteralDfa_0 active0 return switch curChar case return jjMoveStringLiteralDfa3_0 active0 case return jjMoveStringLiteralDfa3_0 active0 default break return jjStartNfa_0 active0 private final int jjMoveStringLiteralDfa3_0 long old0 long active0 if active0 old0 return jjStartNfa_0 old0 try curChar input_stream readChar catch java io IOException jjStopStringLiteralDfa_0 active0 return switch curChar case if active0 return jjStartNfaWithStates_0 break case return jjMoveStringLiteralDfa4_0 active0 default break return jjStartNfa_0 active0 private final int jjMoveStringLiteralDfa4_0 long old0 long active0 if active0 old0 return jjStartNfa_0 old0 try curChar input_stream readChar catch java io IOException jjStopStringLiteralDfa_0 active0 return switch curChar case if active0 return jjStartNfaWithStates_0 break default break return jjStartNfa_0 active0 private final void jjCheckNAdd int state if jjrounds state jjround jjstateSet jjnewStateCnt state jjrounds state jjround private final void jjAddStates int start int end do jjstateSet jjnewStateCnt jjnextStates start while start end private final void jjCheckNAddTwoStates int state1 int state2 jjCheckNAdd state1 jjCheckNAdd state2 private final void jjCheckNAddStates int start int end do jjCheckNAdd jjnextStates start while start end private final void jjCheckNAddStates int start jjCheckNAdd jjnextStates start jjCheckNAdd jjnextStates start static final long jjbitVec0 static final long jjbitVec2 private final int jjMoveNfa_0 int startState int curPos int nextStates int startsAt jjnewStateCnt int jjstateSet startState int kind for if jjround ReInitRounds if curChar long curChar MatchLoop do switch jjstateSet case if if kind kind jjCheckNAdd else if if kind kind else if if kind kind jjCheckNAdd else if curChar if kind kind jjCheckNAddTwoStates else if curChar jjCheckNAdd else if curChar jjCheckNAddStates else if curChar jjCheckNAddStates else if curChar jjstateSet jjnewStateCnt else if curChar if kind kind jjCheckNAddStates if curChar jjstateSet jjnewStateCnt break case if jjCheckNAddStates break case if kind kind break case if curChar kind kind break case if curChar jjstateSet jjnewStateCnt break case if curChar jjstateSet jjnewStateCnt break case if kind kind break case if curChar jjstateSet jjnewStateCnt break case if curChar jjstateSet jjnewStateCnt break case if break if kind kind jjCheckNAdd break case if curChar jjCheckNAddStates break case if jjCheckNAddStates break case if curChar kind kind break case if jjCheckNAddStates break case if jjCheckNAddStates break case if jjCheckNAddStates break case if jjstateSet jjnewStateCnt break case if jjCheckNAdd break case if curChar jjAddStates break case if curChar jjCheckNAddStates break case if curChar jjCheckNAddStates break case if jjCheckNAddStates break case if curChar jjAddStates break case if curChar jjCheckNAddStates break case if curChar kind kind break case if kind kind break case if curChar kind kind break case if curChar jjstateSet jjnewStateCnt break case if curChar jjCheckNAdd break case if break if kind kind jjCheckNAdd break case if break if kind kind jjstateSet jjnewStateCnt break case if curChar kind kind break case if curChar jjCheckNAddTwoStates break case if curChar kind kind break case if curChar break if kind kind jjCheckNAddTwoStates break default break while startsAt else if curChar long curChar MatchLoop do switch jjstateSet case if if kind kind jjCheckNAdd else if curChar jjCheckNAddStates break case if kind kind break case if jjCheckNAddStates break case if curChar jjAddStates break case if jjCheckNAddStates break case jjAddStates break case if curChar jjAddStates break case case if break if kind kind jjCheckNAdd break case if curChar jjCheckNAddStates break case if curChar jjCheckNAddTwoStates break case if curChar jjCheckNAddTwoStates break case if curChar jjAddStates break default break while startsAt else int hiByte int curChar int i1 hiByte long l1 hiByte int i2 curChar long l2 curChar MatchLoop do switch jjstateSet case if jjCanMove_0 hiByte i1 i2 l1 l2 kind kind break case if jjCanMove_0 hiByte i1 i2 l1 l2 jjAddStates break case if jjCanMove_0 hiByte i1 i2 l1 l2 jjAddStates break default break while startsAt if kind jjmatchedKind kind jjmatchedPos curPos kind curPos if jjnewStateCnt startsAt jjnewStateCnt startsAt return curPos try curChar input_stream readChar catch java io IOException return curPos private final int jjStopStringLiteralDfa_6 int pos long active0 switch pos case if active0 return return default return private final int jjStartNfa_6 int pos long active0 return jjMoveNfa_6 jjStopStringLiteralDfa_6 pos active0 pos private final int jjStartNfaWithStates_6 int pos int kind int state jjmatchedKind kind jjmatchedPos pos try curChar input_stream readChar catch java io IOException return pos return jjMoveNfa_6 state pos private final int jjMoveStringLiteralDfa0_6 switch curChar case jjmatchedKind return jjMoveStringLiteralDfa1_6 case return jjMoveStringLiteralDfa1_6 default return jjMoveNfa_6 private final int jjMoveStringLiteralDfa1_6 long active0 try curChar input_stream readChar catch java io IOException jjStopStringLiteralDfa_6 active0 return switch curChar case if active0 return jjStopAtPos else if active0 return jjStopAtPos break case if active0 return jjStartNfaWithStates_6 break default break return jjStartNfa_6 active0 private final int jjMoveNfa_6 int startState int curPos int nextStates int startsAt jjnewStateCnt int jjstateSet startState int kind for if jjround ReInitRounds if curChar long curChar MatchLoop do switch jjstateSet case if curChar if kind kind jjCheckNAddTwoStates else if curChar jjstateSet jjnewStateCnt break case if curChar jjstateSet jjnewStateCnt break case if kind kind break case if curChar jjstateSet jjnewStateCnt break case if curChar kind kind break case if curChar jjCheckNAddTwoStates break case if curChar kind kind break case if curChar break if kind kind jjCheckNAddTwoStates break default break while startsAt else if curChar long curChar MatchLoop do switch jjstateSet case if curChar jjCheckNAddStates break case if kind kind break case if curChar jjCheckNAddTwoStates break case if curChar jjCheckNAddTwoStates break case if curChar jjAddStates break default break while startsAt else int hiByte int curChar int i1 hiByte long l1 hiByte int i2 curChar long l2 curChar MatchLoop do switch jjstateSet case if jjCanMove_0 hiByte i1 i2 l1 l2 kind kind break default break while startsAt if kind jjmatchedKind kind jjmatchedPos curPos kind curPos if jjnewStateCnt startsAt jjnewStateCnt startsAt return curPos try curChar input_stream readChar catch java io IOException return curPos private final int jjStopStringLiteralDfa_4 int pos long active0 switch pos case if active0 return if active0 jjmatchedKind return if active0 jjmatchedKind return return case if active0 return if active0 jjmatchedKind jjmatchedPos return if active0 jjmatchedKind jjmatchedPos return if active0 return return case if active0 jjmatchedKind jjmatchedPos return if active0 jjmatchedKind jjmatchedPos return return case if active0 return if active0 jjmatchedKind jjmatchedPos return return case if active0 jjmatchedKind jjmatchedPos return return default return private final int jjStartNfa_4 int pos long active0 return jjMoveNfa_4 jjStopStringLiteralDfa_4 pos active0 pos private final int jjStartNfaWithStates_4 int pos int kind int state jjmatchedKind kind jjmatchedPos pos try curChar input_stream readChar catch java io IOException return pos return jjMoveNfa_4 state pos private final int jjMoveStringLiteralDfa0_4 switch curChar case jjmatchedKind return jjMoveStringLiteralDfa1_4 case return jjMoveStringLiteralDfa1_4 case return jjMoveStringLiteralDfa1_4 case return jjMoveStringLiteralDfa1_4 default return jjMoveNfa_4 private final int jjMoveStringLiteralDfa1_4 long active0 try curChar input_stream readChar catch java io IOException jjStopStringLiteralDfa_4 active0 return switch curChar case if active0 return jjStopAtPos break case if active0 return jjStartNfaWithStates_4 break case if active0 return jjStartNfaWithStates_4 break case return jjMoveStringLiteralDfa2_4 active0 case return jjMoveStringLiteralDfa2_4 active0 default break return jjStartNfa_4 active0 private final int jjMoveStringLiteralDfa2_4 long old0 long active0 if active0 old0 return jjStartNfa_4 old0 try curChar input_stream readChar catch java io IOException jjStopStringLiteralDfa_4 active0 return switch curChar case return jjMoveStringLiteralDfa3_4 active0 case return jjMoveStringLiteralDfa3_4 active0 default break return jjStartNfa_4 active0 private final int jjMoveStringLiteralDfa3_4 long old0 long active0 if active0 old0 return jjStartNfa_4 old0 try curChar input_stream readChar catch java io IOException jjStopStringLiteralDfa_4 active0 return switch curChar case return jjMoveStringLiteralDfa4_4 active0 case if active0 return jjStartNfaWithStates_4 break default break return jjStartNfa_4 active0 private final int jjMoveStringLiteralDfa4_4 long old0 long active0 if active0 old0 return jjStartNfa_4 old0 try curChar input_stream readChar catch java io IOException jjStopStringLiteralDfa_4 active0 return switch curChar case return jjMoveStringLiteralDfa5_4 active0 default break return jjStartNfa_4 active0 private final int jjMoveStringLiteralDfa5_4 long old0 long active0 if active0 old0 return jjStartNfa_4 old0 try curChar input_stream readChar catch java io IOException jjStopStringLiteralDfa_4 active0 return switch curChar case if active0 return jjStartNfaWithStates_4 break default break return jjStartNfa_4 active0 private final int jjMoveNfa_4 int startState int curPos int nextStates int startsAt jjnewStateCnt int jjstateSet startState int kind for if jjround ReInitRounds if curChar long curChar MatchLoop do switch jjstateSet case if if kind kind jjCheckNAdd else if curChar if kind kind jjCheckNAddTwoStates else if curChar jjCheckNAdd else if curChar jjstateSet jjnewStateCnt break case if if kind kind jjCheckNAdd else if if kind kind else if jjCheckNAddStates if curChar jjstateSet jjnewStateCnt break case case if break if kind kind jjCheckNAdd break case if break if kind kind jjCheckNAdd break case if break if kind kind jjCheckNAdd break case if curChar jjstateSet jjnewStateCnt break case if kind kind break case if curChar jjstateSet jjnewStateCnt break case if curChar jjCheckNAdd break case if break if kind kind jjCheckNAdd break case if curChar kind kind break case if curChar jjCheckNAddTwoStates break case if curChar kind kind break case if curChar break if kind kind jjCheckNAddTwoStates break case if jjAddStates break case if kind kind break case if curChar kind kind break case if curChar jjstateSet jjnewStateCnt break case if jjCheckNAddStates break case if kind kind break case if curChar kind kind break case if curChar jjstateSet jjnewStateCnt break default break while startsAt else if curChar long curChar MatchLoop do switch jjstateSet case if if kind kind jjCheckNAdd else if curChar jjCheckNAddStates if curChar jjAddStates break case case if break if kind kind jjCheckNAdd break case if if kind kind jjCheckNAdd if curChar jjstateSet jjnewStateCnt else if curChar jjstateSet jjnewStateCnt break case if if kind kind jjCheckNAdd if curChar jjstateSet jjnewStateCnt break case if if kind kind jjCheckNAdd if curChar if kind kind jjAddStates break case if kind kind break case if break if kind kind jjCheckNAdd break case if curChar jjCheckNAddStates break case if curChar jjCheckNAddTwoStates break case if curChar jjCheckNAddTwoStates break case if curChar jjAddStates break case if curChar jjAddStates break case if curChar break if kind kind jjAddStates break case if curChar jjstateSet jjnewStateCnt break default break while startsAt else int hiByte int curChar int i1 hiByte long l1 hiByte int i2 curChar long l2 curChar MatchLoop do switch jjstateSet case if jjCanMove_0 hiByte i1 i2 l1 l2 kind kind break default break while startsAt if kind jjmatchedKind kind jjmatchedPos curPos kind curPos if jjnewStateCnt startsAt jjnewStateCnt startsAt return curPos try curChar input_stream readChar catch java io IOException return curPos private final int jjStopStringLiteralDfa_3 int pos long active0 switch pos case if active0 return if active0 return return default return private final int jjStartNfa_3 int pos long active0 return jjMoveNfa_3 jjStopStringLiteralDfa_3 pos active0 pos private final int jjStartNfaWithStates_3 int pos int kind int state jjmatchedKind kind jjmatchedPos pos try curChar input_stream readChar catch java io IOException return pos return jjMoveNfa_3 state pos private final int jjMoveStringLiteralDfa0_3 switch curChar case jjmatchedKind return jjMoveStringLiteralDfa1_3 case jjmatchedKind return jjMoveStringLiteralDfa1_3 default return jjMoveNfa_3 private final int jjMoveStringLiteralDfa1_3 long active0 try curChar input_stream readChar catch java io IOException jjStopStringLiteralDfa_3 active0 return switch curChar case if active0 return jjStopAtPos break case if active0 return jjStartNfaWithStates_3 break case if active0 return jjStartNfaWithStates_3 break default break return jjStartNfa_3 active0 private final int jjMoveNfa_3 int startState int curPos int nextStates int startsAt jjnewStateCnt int jjstateSet startState int kind for if jjround ReInitRounds if curChar long curChar MatchLoop do switch jjstateSet case if curChar jjstateSet jjnewStateCnt break case if if kind kind jjCheckNAdd else if curChar if kind kind jjCheckNAddTwoStates else if curChar jjCheckNAddTwoStates if jjCheckNAddTwoStates break case if curChar jjCheckNAddTwoStates if curChar if kind kind break case if curChar jjCheckNAddTwoStates else if curChar jjstateSet jjnewStateCnt if curChar if kind kind break case if jjCheckNAddTwoStates break case if curChar jjAddStates break case if curChar kind kind break case if curChar jjCheckNAdd break case if break if kind kind jjCheckNAdd break case if curChar jjstateSet jjnewStateCnt break case if break if kind kind jjstateSet jjnewStateCnt break case if curChar jjstateSet jjnewStateCnt break case if kind kind break case if curChar kind kind break case if curChar jjCheckNAddTwoStates break case if curChar kind kind break case if curChar break if kind kind jjCheckNAddTwoStates break default break while startsAt else if curChar long curChar MatchLoop do switch jjstateSet case case if curChar jjstateSet jjnewStateCnt break case if if kind kind jjCheckNAdd else if curChar jjCheckNAddStates if curChar jjAddStates break case if curChar jjAddStates if curChar jjCheckNAddTwoStates if curChar jjCheckNAddTwoStates break case if curChar jjCheckNAddTwoStates if curChar jjCheckNAddTwoStates if curChar jjstateSet jjnewStateCnt break case if curChar jjAddStates break case if curChar jjstateSet jjnewStateCnt break case if break if kind kind jjCheckNAdd break case if curChar jjAddStates break case case if break if kind kind jjCheckNAdd break case if kind kind break case if curChar jjCheckNAddStates break case if curChar jjCheckNAddTwoStates break case if curChar jjCheckNAddTwoStates break case if curChar jjAddStates break default break while startsAt else int hiByte int curChar int i1 hiByte long l1 hiByte int i2 curChar long l2 curChar MatchLoop do switch jjstateSet case case if jjCanMove_0 hiByte i1 i2 l1 l2 break if kind kind jjCheckNAdd break case if jjCanMove_0 hiByte i1 i2 l1 l2 kind kind break default break while startsAt if kind jjmatchedKind kind jjmatchedPos curPos kind curPos if jjnewStateCnt startsAt jjnewStateCnt startsAt return curPos try curChar input_stream readChar catch java io IOException return curPos private final int jjStopStringLiteralDfa_7 int pos long active0 switch pos case if active0 return return default return private final int jjStartNfa_7 int pos long active0 return jjMoveNfa_7 jjStopStringLiteralDfa_7 pos active0 pos private final int jjStartNfaWithStates_7 int pos int kind int state jjmatchedKind kind jjmatchedPos pos try curChar input_stream readChar catch java io IOException return pos return jjMoveNfa_7 state pos private final int jjMoveStringLiteralDfa0_7 switch curChar case jjmatchedKind return jjMoveStringLiteralDfa1_7 case return jjMoveStringLiteralDfa1_7 default return jjMoveNfa_7 private final int jjMoveStringLiteralDfa1_7 long active0 try curChar input_stream readChar catch java io IOException jjStopStringLiteralDfa_7 active0 return switch curChar case if active0 return jjStopAtPos else if active0 return jjStopAtPos break case if active0 return jjStartNfaWithStates_7 break default break return jjStartNfa_7 active0 private final int jjMoveNfa_7 int startState int curPos int nextStates int startsAt jjnewStateCnt int jjstateSet startState int kind for if jjround ReInitRounds if curChar long curChar MatchLoop do switch jjstateSet case if curChar if kind kind jjCheckNAddTwoStates else if curChar jjstateSet jjnewStateCnt break case if curChar jjstateSet jjnewStateCnt break case if kind kind break case if curChar jjstateSet jjnewStateCnt break case if curChar kind kind break case if curChar jjCheckNAddTwoStates break case if curChar kind kind break case if curChar break if kind kind jjCheckNAddTwoStates break default break while startsAt else if curChar long curChar MatchLoop do switch jjstateSet case if curChar jjCheckNAddStates break case if kind kind break case if curChar jjCheckNAddTwoStates break case if curChar jjCheckNAddTwoStates break case if curChar jjAddStates break default break while startsAt else int hiByte int curChar int i1 hiByte long l1 hiByte int i2 curChar long l2 curChar MatchLoop do switch jjstateSet case if jjCanMove_0 hiByte i1 i2 l1 l2 kind kind break default break while startsAt if kind jjmatchedKind kind jjmatchedPos curPos kind curPos if jjnewStateCnt startsAt jjnewStateCnt startsAt return curPos try curChar input_stream readChar catch java io IOException return curPos private final int jjStopStringLiteralDfa_8 int pos long active0 switch pos case if active0 return return default return private final int jjStartNfa_8 int pos long active0 return jjMoveNfa_8 jjStopStringLiteralDfa_8 pos active0 pos private final int jjStartNfaWithStates_8 int pos int kind int state jjmatchedKind kind jjmatchedPos pos try curChar input_stream readChar catch java io IOException return pos return jjMoveNfa_8 state pos private final int jjMoveStringLiteralDfa0_8 switch curChar case jjmatchedKind return jjMoveStringLiteralDfa1_8 default return jjMoveNfa_8 private final int jjMoveStringLiteralDfa1_8 long active0 try curChar input_stream readChar catch java io IOException jjStopStringLiteralDfa_8 active0 return switch curChar case if active0 return jjStopAtPos break case if active0 return jjStartNfaWithStates_8 break default break return jjStartNfa_8 active0 private final int jjMoveNfa_8 int startState int curPos int nextStates int startsAt jjnewStateCnt int jjstateSet startState int kind for if jjround ReInitRounds if curChar long curChar MatchLoop do switch jjstateSet case if if kind kind else if curChar if kind kind jjCheckNAddTwoStates else if curChar jjstateSet jjnewStateCnt if curChar jjstateSet jjnewStateCnt break case if curChar jjstateSet jjnewStateCnt break case if kind kind break case if curChar jjstateSet jjnewStateCnt break case if kind kind break case if curChar kind kind break case if curChar jjstateSet jjnewStateCnt break case if curChar kind kind break case if curChar jjCheckNAddTwoStates break case if curChar kind kind break case if curChar break if kind kind jjCheckNAddTwoStates break default break while startsAt else if curChar long curChar MatchLoop do switch jjstateSet case if curChar jjCheckNAddStates break case if kind kind break case if curChar jjCheckNAddTwoStates break case if curChar jjCheckNAddTwoStates break case if curChar jjAddStates break default break while startsAt else int hiByte int curChar int i1 hiByte long l1 hiByte int i2 curChar long l2 curChar MatchLoop do switch jjstateSet case if jjCanMove_0 hiByte i1 i2 l1 l2 kind kind break default break while startsAt if kind jjmatchedKind kind jjmatchedPos curPos kind curPos if jjnewStateCnt startsAt jjnewStateCnt startsAt return curPos try curChar input_stream readChar catch java io IOException return curPos private final int jjStopStringLiteralDfa_5 int pos long active0 switch pos case if active0 return if active0 jjmatchedKind return return case if active0 return if active0 jjmatchedKind jjmatchedPos return return case if active0 jjmatchedKind jjmatchedPos return return case if active0 jjmatchedKind jjmatchedPos return if active0 return return default return private final int jjStartNfa_5 int pos long active0 return jjMoveNfa_5 jjStopStringLiteralDfa_5 pos active0 pos private final int jjStartNfaWithStates_5 int pos int kind int state jjmatchedKind kind jjmatchedPos pos try curChar input_stream readChar catch java io IOException return pos return jjMoveNfa_5 state pos private final int jjMoveStringLiteralDfa0_5 switch curChar case jjmatchedKind return jjMoveStringLiteralDfa1_5 case return jjMoveStringLiteralDfa1_5 case return jjMoveStringLiteralDfa1_5 case return jjStopAtPos case return jjStopAtPos default return jjMoveNfa_5 private final int jjMoveStringLiteralDfa1_5 long active0 try curChar input_stream readChar catch java io IOException jjStopStringLiteralDfa_5 active0 return switch curChar case if active0 return jjStopAtPos break case if active0 return jjStartNfaWithStates_5 break case return jjMoveStringLiteralDfa2_5 active0 case return jjMoveStringLiteralDfa2_5 active0 default break return jjStartNfa_5 active0 private final int jjMoveStringLiteralDfa2_5 long old0 long active0 if active0 old0 return jjStartNfa_5 old0 try curChar input_stream readChar catch java io IOException jjStopStringLiteralDfa_5 active0 return switch curChar case return jjMoveStringLiteralDfa3_5 active0 case return jjMoveStringLiteralDfa3_5 active0 default break return jjStartNfa_5 active0 private final int jjMoveStringLiteralDfa3_5 long old0 long active0 if active0 old0 return jjStartNfa_5 old0 try curChar input_stream readChar catch java io IOException jjStopStringLiteralDfa_5 active0 return switch curChar case if active0 return jjStartNfaWithStates_5 break case return jjMoveStringLiteralDfa4_5 active0 default break return jjStartNfa_5 active0 private final int jjMoveStringLiteralDfa4_5 long old0 long active0 if active0 old0 return jjStartNfa_5 old0 try curChar input_stream readChar catch java io IOException jjStopStringLiteralDfa_5 active0 return switch curChar case if active0 return jjStartNfaWithStates_5 break default break return jjStartNfa_5 active0 private final int jjMoveNfa_5 int startState int curPos int nextStates int startsAt jjnewStateCnt int jjstateSet startState int kind for if jjround ReInitRounds if curChar long curChar MatchLoop do switch jjstateSet case if curChar if kind kind jjCheckNAddTwoStates else if curChar jjstateSet jjnewStateCnt else if curChar jjstateSet jjnewStateCnt break case if curChar jjstateSet jjnewStateCnt break case if kind kind break case if curChar jjstateSet jjnewStateCnt break case if break if kind kind jjstateSet jjnewStateCnt break case if curChar jjstateSet jjnewStateCnt break case if curChar kind kind break case if curChar jjCheckNAddTwoStates break case if curChar kind kind break case if curChar break if kind kind jjCheckNAddTwoStates break default break while startsAt else if curChar long curChar MatchLoop do switch jjstateSet case if if kind kind jjCheckNAdd else if curChar jjCheckNAddStates break case if kind kind break case case if break if kind kind jjCheckNAdd break case if kind kind break case if curChar jjCheckNAddStates break case if curChar jjCheckNAddTwoStates break case if curChar jjCheckNAddTwoStates break case if curChar jjAddStates break default break while startsAt else int hiByte int curChar int i1 hiByte long l1 hiByte int i2 curChar long l2 curChar MatchLoop do switch jjstateSet case if jjCanMove_0 hiByte i1 i2 l1 l2 kind kind break default break while startsAt if kind jjmatchedKind kind jjmatchedPos curPos kind curPos if jjnewStateCnt startsAt jjnewStateCnt startsAt return curPos try curChar input_stream readChar catch java io IOException return curPos private final int jjStopStringLiteralDfa_1 int pos long active0 switch pos case if active0 return if active0 jjmatchedKind return if active0 return return case if active0 return if active0 jjmatchedKind jjmatchedPos return return case if active0 jjmatchedKind jjmatchedPos return return case if active0 jjmatchedKind jjmatchedPos return if active0 return return default return private final int jjStartNfa_1 int pos long active0 return jjMoveNfa_1 jjStopStringLiteralDfa_1 pos active0 pos private final int jjStartNfaWithStates_1 int pos int kind int state jjmatchedKind kind jjmatchedPos pos try curChar input_stream readChar catch java io IOException return pos return jjMoveNfa_1 state pos private final int jjMoveStringLiteralDfa0_1 switch curChar case jjmatchedKind return jjMoveStringLiteralDfa1_1 case return jjStopAtPos case return jjStopAtPos case return jjMoveStringLiteralDfa1_1 case return jjStopAtPos case return jjStopAtPos case return jjMoveStringLiteralDfa1_1 case return jjMoveStringLiteralDfa1_1 case return jjStopAtPos case return jjStopAtPos default return jjMoveNfa_1 private final int jjMoveStringLiteralDfa1_1 long active0 try curChar input_stream readChar catch java io IOException jjStopStringLiteralDfa_1 active0 return switch curChar case if active0 return jjStopAtPos break case if active0 return jjStartNfaWithStates_1 break case if active0 return jjStopAtPos break case return jjMoveStringLiteralDfa2_1 active0 case return jjMoveStringLiteralDfa2_1 active0 default break return jjStartNfa_1 active0 private final int jjMoveStringLiteralDfa2_1 long old0 long active0 if active0 old0 return jjStartNfa_1 old0 try curChar input_stream readChar catch java io IOException jjStopStringLiteralDfa_1 active0 return switch curChar case return jjMoveStringLiteralDfa3_1 active0 case return jjMoveStringLiteralDfa3_1 active0 default break return jjStartNfa_1 active0 private final int jjMoveStringLiteralDfa3_1 long old0 long active0 if active0 old0 return jjStartNfa_1 old0 try curChar input_stream readChar catch java io IOException jjStopStringLiteralDfa_1 active0 return switch curChar case if active0 return jjStartNfaWithStates_1 break case return jjMoveStringLiteralDfa4_1 active0 default break return jjStartNfa_1 active0 private final int jjMoveStringLiteralDfa4_1 long old0 long active0 if active0 old0 return jjStartNfa_1 old0 try curChar input_stream readChar catch java io IOException jjStopStringLiteralDfa_1 active0 return switch curChar case if active0 return jjStartNfaWithStates_1 break default break return jjStartNfa_1 active0 private final int jjMoveNfa_1 int startState int curPos int nextStates int startsAt jjnewStateCnt int jjstateSet startState int kind for if jjround ReInitRounds if curChar long curChar MatchLoop do switch jjstateSet case if if kind kind jjCheckNAdd else if if kind kind jjCheckNAdd else if curChar if kind kind jjCheckNAddTwoStates else if curChar jjstateSet jjnewStateCnt else if curChar jjCheckNAdd else if curChar jjCheckNAddStates else if curChar jjCheckNAddStates else if curChar jjstateSet jjnewStateCnt break case if curChar jjstateSet jjnewStateCnt break case if kind kind break case if curChar jjstateSet jjnewStateCnt break case if break if kind kind jjCheckNAdd break case if curChar jjCheckNAddStates break case if jjCheckNAddStates break case if curChar kind kind break case if jjCheckNAddStates break case if jjCheckNAddStates break case if jjCheckNAddStates break case if jjstateSet jjnewStateCnt break case if jjCheckNAdd break case if curChar jjAddStates break case if curChar jjCheckNAddStates break case if curChar jjCheckNAddStates break case if jjCheckNAddStates break case if curChar jjAddStates break case if curChar jjCheckNAddStates break case if curChar kind kind break case if curChar jjCheckNAdd break case if break if kind kind jjCheckNAdd break case if break if kind kind jjstateSet jjnewStateCnt break case if curChar jjstateSet jjnewStateCnt break case if curChar kind kind break case if curChar jjCheckNAddTwoStates break case if curChar kind kind break case if curChar break if kind kind jjCheckNAddTwoStates break default break while startsAt else if curChar long curChar MatchLoop do switch jjstateSet case if if kind kind jjCheckNAdd else if curChar jjCheckNAddStates break case if kind kind break case if jjCheckNAddStates break case if curChar jjAddStates break case if jjCheckNAddStates break case jjAddStates break case if curChar jjAddStates break case case if break if kind kind jjCheckNAdd break case if kind kind break case if curChar jjCheckNAddStates break case if curChar jjCheckNAddTwoStates break case if curChar jjCheckNAddTwoStates break case if curChar jjAddStates break default break while startsAt else int hiByte int curChar int i1 hiByte long l1 hiByte int i2 curChar long l2 curChar MatchLoop do switch jjstateSet case if jjCanMove_0 hiByte i1 i2 l1 l2 kind kind break case if jjCanMove_0 hiByte i1 i2 l1 l2 jjAddStates break case if jjCanMove_0 hiByte i1 i2 l1 l2 jjAddStates break default break while startsAt if kind jjmatchedKind kind jjmatchedPos curPos kind curPos if jjnewStateCnt startsAt jjnewStateCnt startsAt return curPos try curChar input_stream readChar catch java io IOException return curPos private final int jjStopStringLiteralDfa_2 int pos long active0 switch pos case if active0 return if active0 jjmatchedKind return return case if active0 return if active0 jjmatchedKind jjmatchedPos return return case if active0 jjmatchedKind jjmatchedPos return return case if active0 jjmatchedKind jjmatchedPos return if active0 return return default return private final int jjStartNfa_2 int pos long active0 return jjMoveNfa_2 jjStopStringLiteralDfa_2 pos active0 pos private final int jjStartNfaWithStates_2 int pos int kind int state jjmatchedKind kind jjmatchedPos pos try curChar input_stream readChar catch java io IOException return pos return jjMoveNfa_2 state pos private final int jjMoveStringLiteralDfa0_2 switch curChar case jjmatchedKind return jjMoveStringLiteralDfa1_2 case return jjStopAtPos case return jjMoveStringLiteralDfa1_2 case return jjMoveStringLiteralDfa1_2 case return jjStopAtPos case return jjStopAtPos default return jjMoveNfa_2 private final int jjMoveStringLiteralDfa1_2 long active0 try curChar input_stream readChar catch java io IOException jjStopStringLiteralDfa_2 active0 return switch curChar case if active0 return jjStopAtPos break case if active0 return jjStartNfaWithStates_2 break case return jjMoveStringLiteralDfa2_2 active0 case return jjMoveStringLiteralDfa2_2 active0 default break return jjStartNfa_2 active0 private final int jjMoveStringLiteralDfa2_2 long old0 long active0 if active0 old0 return jjStartNfa_2 old0 try curChar input_stream readChar catch java io IOException jjStopStringLiteralDfa_2 active0 return switch curChar case return jjMoveStringLiteralDfa3_2 active0 case return jjMoveStringLiteralDfa3_2 active0 default break return jjStartNfa_2 active0 private final int jjMoveStringLiteralDfa3_2 long old0 long active0 if active0 old0 return jjStartNfa_2 old0 try curChar input_stream readChar catch java io IOException jjStopStringLiteralDfa_2 active0 return switch curChar case if active0 return jjStartNfaWithStates_2 break case return jjMoveStringLiteralDfa4_2 active0 default break return jjStartNfa_2 active0 private final int jjMoveStringLiteralDfa4_2 long old0 long active0 if active0 old0 return jjStartNfa_2 old0 try curChar input_stream readChar catch java io IOException jjStopStringLiteralDfa_2 active0 return switch curChar case if active0 return jjStartNfaWithStates_2 break default break return jjStartNfa_2 active0 private final int jjMoveNfa_2 int startState int curPos int nextStates int startsAt jjnewStateCnt int jjstateSet startState int kind for if jjround ReInitRounds if curChar long curChar MatchLoop do switch jjstateSet case if curChar if kind kind jjCheckNAddTwoStates else if curChar jjstateSet jjnewStateCnt else if curChar jjstateSet jjnewStateCnt break case if curChar jjstateSet jjnewStateCnt break case if kind kind break case if curChar jjstateSet jjnewStateCnt break case if break if kind kind jjstateSet jjnewStateCnt break case if curChar jjstateSet jjnewStateCnt break case if curChar kind kind break case if curChar jjCheckNAddTwoStates break case if curChar kind kind break case if curChar break if kind kind jjCheckNAddTwoStates break default break while startsAt else if curChar long curChar MatchLoop do switch jjstateSet case if if kind kind jjCheckNAdd else if curChar jjCheckNAddStates break case if kind kind break case case if break if kind kind jjCheckNAdd break case if kind kind break case if curChar jjCheckNAddStates break case if curChar jjCheckNAddTwoStates break case if curChar jjCheckNAddTwoStates break case if curChar jjAddStates break default break while startsAt else int hiByte int curChar int i1 hiByte long l1 hiByte int i2 curChar long l2 curChar MatchLoop do switch jjstateSet case if jjCanMove_0 hiByte i1 i2 l1 l2 kind kind break default break while startsAt if kind jjmatchedKind kind jjmatchedPos curPos kind curPos if jjnewStateCnt startsAt jjnewStateCnt startsAt return curPos try curChar input_stream readChar catch java io IOException return curPos static final int jjnextStates private static final boolean jjCanMove_0 int hiByte int i1 int i2 long l1 long l2 switch hiByte case return jjbitVec2 i2 l2 default if jjbitVec0 i1 l1 return true return false public static final String jjstrLiteralImages null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null null public static final String lexStateNames public static final int jjnewLexState static final long jjtoToken static final long jjtoSkip static final long jjtoSpecial static final long jjtoMore private CharStream input_stream private final int jjrounds new int private final int jjstateSet new int StringBuffer image int jjimageLen int lengthOfMatch protected char curChar public ParserTokenManager CharStream stream input_stream stream public ParserTokenManager CharStream stream int lexState this stream SwitchTo lexState public void ReInit CharStream stream jjmatchedPos jjnewStateCnt curLexState defaultLexState input_stream stream ReInitRounds private final void ReInitRounds int jjround for jjrounds public void ReInit CharStream stream int lexState ReInit stream SwitchTo lexState public void SwitchTo int lexState if lexState lexState throw new TokenMgrError lexState TokenMgrError INVALID_LEXICAL_STATE else curLexState lexState private final Token jjFillToken Token Token newToken jjmatchedKind kind jjmatchedKind String im jjstrLiteralImages jjmatchedKind image im null input_stream GetImage im beginLine input_stream getBeginLine beginColumn input_stream getBeginColumn endLine input_stream getEndLine endColumn input_stream getEndColumn return int curLexState int defaultLexState int jjnewStateCnt int jjround int jjmatchedPos int jjmatchedKind public final Token getNextToken int kind Token specialToken null Token matchedToken int curPos EOFLoop for try curChar input_stream BeginToken catch java io IOException jjmatchedKind matchedToken jjFillToken matchedToken specialToken specialToken return matchedToken image null jjimageLen for switch curLexState case jjmatchedKind jjmatchedPos curPos jjMoveStringLiteralDfa0_0 break case jjmatchedKind jjmatchedPos curPos jjMoveStringLiteralDfa0_1 if jjmatchedPos jjmatchedKind jjmatchedKind break case jjmatchedKind jjmatchedPos curPos jjMoveStringLiteralDfa0_2 if jjmatchedPos jjmatchedKind jjmatchedKind break case jjmatchedKind jjmatchedPos curPos jjMoveStringLiteralDfa0_3 break case jjmatchedKind jjmatchedPos curPos jjMoveStringLiteralDfa0_4 if jjmatchedPos jjmatchedKind jjmatchedKind break case jjmatchedKind jjmatchedPos curPos jjMoveStringLiteralDfa0_5 if jjmatchedPos jjmatchedKind jjmatchedKind break case jjmatchedKind jjmatchedPos curPos jjMoveStringLiteralDfa0_6 if jjmatchedPos jjmatchedKind jjmatchedKind break case jjmatchedKind jjmatchedPos curPos jjMoveStringLiteralDfa0_7 if jjmatchedPos jjmatchedKind jjmatchedKind break case jjmatchedKind jjmatchedPos curPos jjMoveStringLiteralDfa0_8 if jjmatchedPos jjmatchedKind jjmatchedKind break if jjmatchedKind if jjmatchedPos curPos input_stream backup curPos jjmatchedPos if jjtoToken jjmatchedKind jjmatchedKind matchedToken jjFillToken matchedToken specialToken specialToken TokenLexicalActions matchedToken if jjnewLexState jjmatchedKind curLexState jjnewLexState jjmatchedKind return matchedToken else if jjtoSkip jjmatchedKind jjmatchedKind if jjtoSpecial jjmatchedKind jjmatchedKind matchedToken jjFillToken if specialToken null specialToken matchedToken else matchedToken specialToken specialToken specialToken specialToken next matchedToken SkipLexicalActions matchedToken else SkipLexicalActions null if jjnewLexState jjmatchedKind curLexState jjnewLexState jjmatchedKind continue EOFLoop MoreLexicalActions if jjnewLexState jjmatchedKind curLexState jjnewLexState jjmatchedKind curPos jjmatchedKind try curChar input_stream readChar continue catch java io IOException e1 int error_line input_stream getEndLine int error_column input_stream getEndColumn String error_after null boolean EOFSeen false try input_stream readChar input_stream backup catch java io IOException e1 EOFSeen true error_after curPos input_stream GetImage if curChar curChar error_line error_column else error_column if EOFSeen input_stream backup error_after curPos input_stream GetImage throw new TokenMgrError EOFSeen curLexState error_line error_column error_after curChar TokenMgrError LEXICAL_ERROR final void SkipLexicalActions Token matchedToken switch jjmatchedKind case if image null image new StringBuffer new String input_stream GetSuffix jjimageLen lengthOfMatch jjmatchedPos else image append input_stream GetSuffix jjimageLen lengthOfMatch jjmatchedPos input_stream backup inReference false if debugPrint System out print stateStackPop break case if image null image new StringBuffer new String input_stream GetSuffix jjimageLen lengthOfMatch jjmatchedPos else image append input_stream GetSuffix jjimageLen lengthOfMatch jjmatchedPos if debugPrint System out print input_stream backup inDirective false stateStackPop break default break final void MoreLexicalActions jjimageLen lengthOfMatch jjmatchedPos switch jjmatchedKind case if image null image new StringBuffer new String input_stream GetSuffix jjimageLen else image append input_stream GetSuffix jjimageLen jjimageLen if inComment if curLexState REFERENCE inReference false stateStackPop inReference true if debugPrint System out print REFERENCE stateStackPush SwitchTo REFERENCE break case if image null image new StringBuffer new String input_stream GetSuffix jjimageLen else image append input_stream GetSuffix jjimageLen jjimageLen if inComment if curLexState REFERENCE inReference false stateStackPop inReference true if debugPrint System out print REFERENCE stateStackPush SwitchTo REFERENCE break case if image null image new StringBuffer new String input_stream GetSuffix jjimageLen else image append input_stream GetSuffix jjimageLen jjimageLen if inComment if curLexState REFERENCE inReference false stateStackPop inComment true stateStackPush SwitchTo IN_SINGLE_LINE_COMMENT break case if image null image new StringBuffer new String input_stream GetSuffix jjimageLen else image append input_stream GetSuffix jjimageLen jjimageLen input_stream backup inComment true stateStackPush SwitchTo IN_FORMAL_COMMENT break case if image null image new StringBuffer new String input_stream GetSuffix jjimageLen else image append input_stream GetSuffix jjimageLen jjimageLen inComment true stateStackPush SwitchTo IN_MULTI_LINE_COMMENT break case if image null image new StringBuffer new String input_stream GetSuffix jjimageLen else image append input_stream GetSuffix jjimageLen jjimageLen if inComment if curLexState REFERENCE curLexState REFMODIFIER inReference false stateStackPop inDirective true if debugPrint System out print DIRECTIVE stateStackPush SwitchTo PRE_DIRECTIVE break default break final void TokenLexicalActions Token matchedToken switch jjmatchedKind case if image null image new StringBuffer new String input_stream GetSuffix jjimageLen lengthOfMatch jjmatchedPos else image append input_stream GetSuffix jjimageLen lengthOfMatch jjmatchedPos if inComment lparen if curLexState REFMODIFIER SwitchTo REFMOD2 break case if image null image new StringBuffer new String input_stream GetSuffix jjimageLen lengthOfMatch jjmatchedPos else image append input_stream GetSuffix jjimageLen lengthOfMatch jjmatchedPos RPARENHandler break case if image null image new StringBuffer new String input_stream GetSuffix jjimageLen lengthOfMatch jjmatchedPos else image append input_stream GetSuffix jjimageLen lengthOfMatch jjmatchedPos SwitchTo REFERENCE break case if image null image new StringBuffer new String input_stream GetSuffix jjimageLen lengthOfMatch jjmatchedPos else image append input_stream GetSuffix jjimageLen lengthOfMatch jjmatchedPos if inComment inDirective true if debugPrint System out print DIRECTIVE stateStackPush inSet true SwitchTo DIRECTIVE if inComment lparen if curLexState REFMODIFIER SwitchTo REFMOD2 break case if image null image new StringBuffer new String input_stream GetSuffix jjimageLen lengthOfMatch jjmatchedPos else image append input_stream GetSuffix jjimageLen lengthOfMatch jjmatchedPos inComment false stateStackPop break case if image null image new StringBuffer new String input_stream GetSuffix jjimageLen lengthOfMatch jjmatchedPos else image append input_stream GetSuffix jjimageLen lengthOfMatch jjmatchedPos inComment false stateStackPop break case if image null image new StringBuffer new String input_stream GetSuffix jjimageLen lengthOfMatch jjmatchedPos else image append input_stream GetSuffix jjimageLen lengthOfMatch jjmatchedPos inComment false stateStackPop break case if image null image new StringBuffer new String input_stream GetSuffix jjimageLen lengthOfMatch jjmatchedPos else image append input_stream GetSuffix jjimageLen lengthOfMatch jjmatchedPos if curLexState DIRECTIVE inSet lparen stateStackPop break case if image null image new StringBuffer new String input_stream GetSuffix jjimageLen lengthOfMatch jjmatchedPos else image append input_stream GetSuffix jjimageLen lengthOfMatch jjmatchedPos if debugPrint System out println stateStackPop if inSet inSet false if inDirective inDirective false break case if image null image new StringBuffer new String input_stream GetSuffix jjimageLen lengthOfMatch jjmatchedPos else image append input_stream GetSuffix jjimageLen lengthOfMatch jjmatchedPos inDirective false stateStackPop break case if image null image new StringBuffer new String input_stream GetSuffix jjimageLen lengthOfMatch jjmatchedPos else image append input_stream GetSuffix jjimageLen lengthOfMatch jjmatchedPos SwitchTo DIRECTIVE break case if image null image new StringBuffer new String input_stream GetSuffix jjimageLen lengthOfMatch jjmatchedPos else image append input_stream GetSuffix jjimageLen lengthOfMatch jjmatchedPos SwitchTo DIRECTIVE break case if image null image new StringBuffer new String input_stream GetSuffix jjimageLen lengthOfMatch jjmatchedPos else image append input_stream GetSuffix jjimageLen lengthOfMatch jjmatchedPos inDirective false stateStackPop break case if image null image new StringBuffer new String input_stream GetSuffix jjimageLen lengthOfMatch jjmatchedPos else image append input_stream GetSuffix jjimageLen lengthOfMatch jjmatchedPos matchedToken kind EOF fileDepth break case if image null image new StringBuffer new String input_stream GetSuffix jjimageLen lengthOfMatch jjmatchedPos else image append input_stream GetSuffix jjimageLen lengthOfMatch jjmatchedPos if lparen inSet curLexState REFMOD2 stateStackPop break case if image null image new StringBuffer new String input_stream GetSuffix jjimageLen lengthOfMatch jjmatchedPos else image append input_stream GetSuffix jjimageLen lengthOfMatch jjmatchedPos input_stream backup matchedToken image if debugPrint System out print REFMODIFIER SwitchTo REFMODIFIER break case if image null image new StringBuffer new String input_stream GetSuffix jjimageLen lengthOfMatch jjmatchedPos else image append input_stream GetSuffix jjimageLen lengthOfMatch jjmatchedPos stateStackPop break default break public class ASTLENode extends SimpleNode public ASTLENode int id super id public ASTLENode Parser int id super id public Object jjtAccept ParserVisitor visitor Object data return visitor visit this data public boolean evaluate InternalContextAdapter context throws MethodInvocationException Object left jjtGetChild value context Object right jjtGetChild value context if left null right null rsvc error left null jjtGetChild left null literal context getCurrentTemplateName getLine getColumn return false if left instanceof Integer right instanceof Integer rsvc error left instanceof Integer left instanceof Integer left getClass right getClass context getCurrentTemplateName getLine getColumn return false return Integer left intValue Integer right intValue public Object value InternalContextAdapter context throws MethodInvocationException boolean val evaluate context return val Boolean TRUE Boolean FALSE public class CommonsExtPropTestCase extends BaseTestCase private static final String COMPARE_DIR private static final String RESULTS_DIR private static final String TEST_CONFIG public CommonsExtPropTestCase super public static junit framework Test suite return new CommonsExtPropTestCase public void runTest try assureResultsDirectoryExists RESULTS_DIR ExtendedProperties new ExtendedProperties TEST_CONFIG FileWriter result new FileWriter getFileName RESULTS_DIR message result showIterator result getKeys message result showVector result getVector message result ExtendedProperties subset subset showIterator result subset getKeys message result showVector result subset getVector message result result write getString result write message result result write new Boolean getBoolean toString result write message result result write new Byte getByte toString result write message result result write new Short getShort toString result write message result result write new Integer getInt toString result write message result result write new Long getLong toString result write message result result write new Float getFloat toString result write message result result write new Double getDouble toString result write message result result write getString result write message result showVector result getVector result write result flush result close if isMatch RESULTS_DIR COMPARE_DIR fail catch Exception System err println printStackTrace System exit private void showIterator FileWriter result Iterator throws Exception while hasNext result write String next result write result write private void showVector FileWriter result Vector throws Exception for int size result write String get result write result write private void message FileWriter result String message throws Exception result write result write message result write result write public class ASTMethod extends SimpleNode private String methodName private int paramCount public ASTMethod int id super id public ASTMethod Parser int id super id public Object jjtAccept ParserVisitor visitor Object data return visitor visit this data public Object init InternalContextAdapter context Object data throws Exception super init context data methodName getFirstToken image paramCount jjtGetNumChildren return data public Object execute Object InternalContextAdapter context throws MethodInvocationException VelMethod method null Object params new Object paramCount try IntrospectionCacheData icd context icacheGet this Class getClass if icd null icd contextData for int paramCount params jjtGetChild value context method VelMethod icd thingy else for int paramCount params jjtGetChild value context method rsvc getUberspect getMethod methodName params new Info if method null icd new IntrospectionCacheData icd contextData icd thingy method context icachePut this icd if method null return null catch MethodInvocationException mie throw mie catch Exception rsvc error return null try Object obj method invoke params if obj null if method getReturnType Void TYPE return new String return obj catch InvocationTargetException ite EventCartridge ec context getEventCartridge if ec null ite getTargetException instanceof java lang Exception try return ec methodException getClass methodName Exception ite getTargetException catch Exception throw new MethodInvocationException methodName getClass getClass getMessage methodName else throw new MethodInvocationException methodName getClass ite getTargetException getClass ite getTargetException getMessage ite getTargetException methodName catch Exception rsvc error methodName getClass return null public class VelocityContext extends AbstractContext implements Cloneable private Map context null public VelocityContext this null null public VelocityContext Map context this context null public VelocityContext Context innerContext this null innerContext public VelocityContext Map context Context innerContext super innerContext this context context null new HashMap context public Object internalGet String key return context get key public Object internalPut String key Object value return context put key value public boolean internalContainsKey Object key return context containsKey key public Object internalGetKeys return context keySet toArray public Object internalRemove Object key return context remove key public Object clone VelocityContext clone null try clone VelocityContext super clone clone context new HashMap context catch CloneNotSupportedException ignored return clone public class Template extends Resource private boolean initialized false private Exception errorCondition null public Template public boolean process throws ResourceNotFoundException ParseErrorException Exception data null InputStream is null errorCondition null try is resourceLoader getResourceStream name catch ResourceNotFoundException rnfe errorCondition rnfe throw rnfe if is null try BufferedReader br new BufferedReader new InputStreamReader is encoding data rsvc parse br name initDocument return true catch UnsupportedEncodingException uce String msg encoding name errorCondition new ParseErrorException msg throw errorCondition catch ParseException pex errorCondition new ParseErrorException pex getMessage throw errorCondition catch Exception errorCondition throw finally is close else errorCondition new ResourceNotFoundException name throw errorCondition public void initDocument throws Exception InternalContextAdapterImpl ica new InternalContextAdapterImpl new VelocityContext try ica pushCurrentTemplateName name SimpleNode data init ica rsvc finally ica popCurrentTemplateName public void merge Context context Writer writer throws ResourceNotFoundException ParseErrorException MethodInvocationException Exception if errorCondition null throw errorCondition if data null InternalContextAdapterImpl ica new InternalContextAdapterImpl context try ica pushCurrentTemplateName name ica setCurrentResource this SimpleNode data render ica writer finally ica popCurrentTemplateName ica setCurrentResource null else String msg rsvc error msg throw new Exception msg public class ParseErrorException extends VelocityException public ParseErrorException String exceptionMessage super exceptionMessage public class FileResourceLoader extends ResourceLoader private Vector paths null private Hashtable templatePaths new Hashtable public void init ExtendedProperties configuration rsvc info paths configuration getVector int sz paths size for int sz rsvc info String paths get rsvc info public synchronized InputStream getResourceStream String templateName throws ResourceNotFoundException if templateName null templateName length throw new ResourceNotFoundException String template StringUtils normalizePath templateName if template null template length String msg template rsvc error msg throw new ResourceNotFoundException msg if template startsWith template template substring int size paths size for int size String path String paths get InputStream inputStream findTemplate path template if inputStream null templatePaths put templateName path return inputStream String msg template throw new ResourceNotFoundException msg private InputStream findTemplate String path String template try File file new File path template if file canRead return new BufferedInputStream new FileInputStream file getAbsolutePath else return null catch FileNotFoundException fnfe return null public boolean isSourceModified Resource resource boolean modified true String fileName resource getName String path String templatePaths get fileName File currentFile null for int currentFile null paths size String testPath String paths get File testFile new File testPath fileName if testFile canRead currentFile testFile File file new File path fileName if currentFile null file exists else if currentFile equals file file canRead modified file lastModified resource getLastModified return modified public long getLastModified Resource resource String path String templatePaths get resource getName File file new File path resource getName if file canRead return file lastModified else return public interface ResourceCache public void initialize RuntimeServices rs public Resource get Object resourceKey public Resource put Object resourceKey Resource resource public Resource remove Object resourceKey public Iterator enumerateKeys public class ASTObjectArray extends SimpleNode public ASTObjectArray int id super id public ASTObjectArray Parser int id super id public Object jjtAccept ParserVisitor visitor Object data return visitor visit this data public Object value InternalContextAdapter context throws MethodInvocationException int size jjtGetNumChildren ArrayList objectArray new ArrayList for int size objectArray add jjtGetChild value context return objectArray public class ContentResource extends Resource public ContentResource public boolean process throws ResourceNotFoundException BufferedReader reader null try StringWriter sw new StringWriter reader new BufferedReader new InputStreamReader resourceLoader getResourceStream name encoding char buf new char int len while len reader read buf sw write buf len setData sw toString return true catch ResourceNotFoundException throw catch Exception rsvc error toString return false finally if reader null try reader close catch Exception ignored public abstract class VelocityServlet extends HttpServlet public static final String REQUEST public static final String RESPONSE public static final String CONTENT_TYPE public static final String DEFAULT_CONTENT_TYPE public static final String DEFAULT_OUTPUT_ENCODING private static String defaultContentType protected static final String INIT_PROPS_KEY private static final String OLD_INIT_PROPS_KEY private static SimplePool writerPool new SimplePool public void init ServletConfig config throws ServletException super init config initVelocity config defaultContentType RuntimeSingleton getString CONTENT_TYPE DEFAULT_CONTENT_TYPE protected void initVelocity ServletConfig config throws ServletException try Properties props loadConfiguration config Velocity init props catch Exception throw new ServletException protected Properties loadConfiguration ServletConfig config throws IOException FileNotFoundException String propsFile config getInitParameter INIT_PROPS_KEY if propsFile null propsFile length ServletContext sc config getServletContext propsFile config getInitParameter OLD_INIT_PROPS_KEY if propsFile null propsFile length propsFile sc getInitParameter INIT_PROPS_KEY if propsFile null propsFile length propsFile sc getInitParameter OLD_INIT_PROPS_KEY if propsFile null propsFile length sc log OLD_INIT_PROPS_KEY INIT_PROPS_KEY else sc log OLD_INIT_PROPS_KEY INIT_PROPS_KEY Properties new Properties if propsFile null String realPath getServletContext getRealPath propsFile if realPath null propsFile realPath load new FileInputStream propsFile return public void doGet HttpServletRequest request HttpServletResponse response throws ServletException IOException doRequest request response public void doPost HttpServletRequest request HttpServletResponse response throws ServletException IOException doRequest request response protected void doRequest HttpServletRequest request HttpServletResponse response throws ServletException IOException Context context null try context createContext request response setContentType request response Template template handleRequest request response context if template null return mergeTemplate template context response catch Exception error request response finally requestCleanup request response context protected void requestCleanup HttpServletRequest request HttpServletResponse response Context context return protected void mergeTemplate Template template Context context HttpServletResponse response throws ResourceNotFoundException ParseErrorException MethodInvocationException IOException UnsupportedEncodingException Exception ServletOutputStream output response getOutputStream VelocityWriter vw null String encoding response getCharacterEncoding try vw VelocityWriter writerPool get if vw null vw new VelocityWriter new OutputStreamWriter output encoding true else vw recycle new OutputStreamWriter output encoding template merge context vw finally try if vw null vw flush vw recycle null writerPool put vw catch Exception protected void setContentType HttpServletRequest request HttpServletResponse response String contentType defaultContentType int index contentType lastIndexOf if index index contentType length contentType indexOf index String encoding chooseCharacterEncoding request if DEFAULT_OUTPUT_ENCODING equalsIgnoreCase encoding contentType encoding response setContentType contentType protected String chooseCharacterEncoding HttpServletRequest request return RuntimeSingleton getString RuntimeConstants OUTPUT_ENCODING DEFAULT_OUTPUT_ENCODING protected Context createContext HttpServletRequest request HttpServletResponse response VelocityContext context new VelocityContext context put REQUEST request context put RESPONSE response return context public Template getTemplate String name throws ResourceNotFoundException ParseErrorException Exception return RuntimeSingleton getTemplate name public Template getTemplate String name String encoding throws ResourceNotFoundException ParseErrorException Exception return RuntimeSingleton getTemplate name encoding protected Template handleRequest HttpServletRequest request HttpServletResponse response Context ctx throws Exception Template handleRequest ctx if null throw new Exception return protected Template handleRequest Context ctx throws Exception throw new Exception protected void error HttpServletRequest request HttpServletResponse response Exception cause throws ServletException IOException StringBuffer html new StringBuffer html append html append html append html append html append String why cause getMessage if why null why trim length html append why html append StringWriter sw new StringWriter cause printStackTrace new PrintWriter sw html append sw toString html append html append html append response getOutputStream print html toString public class VelocityFormatter Context context null NumberFormat nf NumberFormat getInstance public VelocityFormatter Context context this context context public String formatShortDate Date date return DateFormat getDateInstance DateFormat SHORT format date public String formatLongDate Date date return DateFormat getDateInstance DateFormat LONG format date public String formatShortDateTime Date date return DateFormat getDateTimeInstance DateFormat SHORT DateFormat SHORT format date public String formatLongDateTime Date date return DateFormat getDateTimeInstance DateFormat LONG DateFormat LONG format date public String formatArray Object array return formatArray array public String formatArray Object array String delim return formatArray array delim delim public String formatArray Object array String delim String finaldelim StringBuffer sb new StringBuffer int arrayLen Array getLength array for int arrayLen sb append Array get array toString if arrayLen sb append delim else if arrayLen sb append finaldelim return sb toString public String formatVector List list return formatVector list public String formatVector List list String delim return formatVector list delim delim public String formatVector List list String delim String finaldelim StringBuffer sb new StringBuffer int size list size for int size sb append list get if size sb append delim else if size sb append finaldelim return sb toString public String limitLen int maxlen String string return limitLen maxlen string public String limitLen int maxlen String string String suffix String ret string if string length maxlen ret string substring maxlen suffix length suffix return ret public class VelocityAlternator protected String alternates null protected int current public VelocityAlternator String alternates this alternates alternates public String alternate current current alternates length return public String toString return alternates current public class VelocityAutoAlternator extends VelocityAlternator public VelocityAutoAlternator String alternates super alternates public final String toString String alternates current alternate return public String makeAlternator String name String alt1 String alt2 String alternates alt1 alt2 context put name new VelocityAlternator alternates return public String makeAlternator String name String alt1 String alt2 String alt3 String alternates alt1 alt2 alt3 context put name new VelocityAlternator alternates return public String makeAlternator String name String alt1 String alt2 String alt3 String alt4 String alternates alt1 alt2 alt3 alt4 context put name new VelocityAlternator alternates return public String makeAutoAlternator String name String alt1 String alt2 String alternates alt1 alt2 context put name new VelocityAutoAlternator alternates return public Object isNull Object Object dflt if null return dflt else return public class ASTStringLiteral extends SimpleNode private boolean interpolate true private SimpleNode nodeTree null private String image private String interpolateimage public ASTStringLiteral int id super id public ASTStringLiteral Parser int id super id public Object init InternalContextAdapter context Object data throws Exception super init context data interpolate rsvc getBoolean RuntimeConstants INTERPOLATE_STRINGLITERALS true getFirstToken image startsWith getFirstToken image indexOf getFirstToken image indexOf image getFirstToken image substring getFirstToken image length interpolateimage image if interpolate BufferedReader br new BufferedReader new StringReader interpolateimage nodeTree rsvc parse br context null context getCurrentTemplateName false nodeTree init context rsvc return data public Object jjtAccept ParserVisitor visitor Object data return visitor visit this data public Object value InternalContextAdapter context if interpolate try StringWriter writer new StringWriter nodeTree render context writer String ret writer toString return ret substring ret length catch Exception rsvc error return image public class MultipleFileResourcePathTest extends BaseTestCase private static final String TMPL_FILE_EXT private static final String CMP_FILE_EXT private static final String RESULT_FILE_EXT private final static String FILE_RESOURCE_LOADER_PATH1 private final static String FILE_RESOURCE_LOADER_PATH2 private static final String RESULTS_DIR private static final String COMPARE_DIR MultipleFileResourcePathTest super try assureResultsDirectoryExists RESULTS_DIR Velocity addProperty Velocity FILE_RESOURCE_LOADER_PATH FILE_RESOURCE_LOADER_PATH1 Velocity addProperty Velocity FILE_RESOURCE_LOADER_PATH FILE_RESOURCE_LOADER_PATH2 Velocity init catch Exception System err println printStackTrace System exit public static junit framework Test suite return new MultipleFileResourcePathTest public void runTest try Template template1 RuntimeSingleton getTemplate getFileName null TMPL_FILE_EXT Template template2 RuntimeSingleton getTemplate getFileName null TMPL_FILE_EXT FileOutputStream fos1 new FileOutputStream getFileName RESULTS_DIR RESULT_FILE_EXT FileOutputStream fos2 new FileOutputStream getFileName RESULTS_DIR RESULT_FILE_EXT Writer writer1 new BufferedWriter new OutputStreamWriter fos1 Writer writer2 new BufferedWriter new OutputStreamWriter fos2 VelocityContext context new VelocityContext template1 merge context writer1 writer1 flush writer1 close template2 merge context writer2 writer2 flush writer2 close if isMatch RESULTS_DIR COMPARE_DIR RESULT_FILE_EXT CMP_FILE_EXT isMatch RESULTS_DIR COMPARE_DIR RESULT_FILE_EXT CMP_FILE_EXT fail catch Exception fail getMessage public class ParserTestCase extends TestCase public ParserTestCase String testName super testName public static Test suite return new TestSuite ParserTestCase class public void testEquals throws Exception VelocityEngine ve new VelocityEngine ve init String template ve evaluate new VelocityContext new StringWriter template template try ve evaluate new VelocityContext new StringWriter template assertTrue false catch ParseErrorException pe public void testMacro throws Exception VelocityEngine ve new VelocityEngine ve init String template ve evaluate new VelocityContext new StringWriter template template try ve evaluate new VelocityContext new StringWriter template assertTrue false catch ParseErrorException pe public void testArgs throws Exception VelocityEngine ve new VelocityEngine ve init String template ve evaluate new VelocityContext new StringWriter template template ve evaluate new VelocityContext new StringWriter template template try ve evaluate new VelocityContext new StringWriter template assertTrue false catch ParseErrorException pe System out println public abstract class ResourceLoader protected boolean isCachingOn false protected long modificationCheckInterval protected String className null protected RuntimeServices rsvc null public void commonInit RuntimeServices rs ExtendedProperties configuration this rsvc rs isCachingOn configuration getBoolean false modificationCheckInterval configuration getLong className configuration getString public abstract void init ExtendedProperties configuration public abstract InputStream getResourceStream String source throws ResourceNotFoundException public abstract boolean isSourceModified Resource resource public abstract long getLastModified Resource resource public String getClassName return className public void setCachingOn boolean value isCachingOn value public boolean isCachingOn return isCachingOn public void setModificationCheckInterval long modificationCheckInterval this modificationCheckInterval modificationCheckInterval public long getModificationCheckInterval return modificationCheckInterval public class TexenTask extends Task private final static String ERR_MSG_FRAGMENT protected String controlTemplate protected String templatePath protected String outputDirectory protected String outputFile protected String outputEncoding protected String inputEncoding protected ExtendedProperties contextProperties protected boolean useClasspath private String fileSeparator System getProperty public void setControlTemplate String controlTemplate this controlTemplate controlTemplate public String getControlTemplate return controlTemplate public void setTemplatePath String templatePath throws Exception StringBuffer resolvedPath new StringBuffer StringTokenizer st new StringTokenizer templatePath while st hasMoreTokens File fullPath project resolveFile st nextToken resolvedPath append fullPath getCanonicalPath if st hasMoreTokens resolvedPath append this templatePath resolvedPath toString System out println templatePath public String getTemplatePath return templatePath public void setOutputDirectory File outputDirectory try this outputDirectory outputDirectory getCanonicalPath catch java io IOException ioe throw new BuildException ioe public String getOutputDirectory return outputDirectory public void setOutputFile String outputFile this outputFile outputFile public void setOutputEncoding String outputEncoding this outputEncoding outputEncoding public void setInputEncoding String inputEncoding this inputEncoding inputEncoding public String getOutputFile return outputFile public void setContextProperties String file String sources StringUtils split file contextProperties new ExtendedProperties for int sources length ExtendedProperties source new ExtendedProperties try File fullPath project resolveFile sources log fullPath source load new FileInputStream fullPath catch Exception ClassLoader classLoader this getClass getClassLoader try InputStream inputStream classLoader getResourceAsStream sources if inputStream null throw new BuildException sources else source load inputStream catch IOException ioe source null Iterator source getKeys while hasNext String name String next String value source getString name contextProperties setProperty name value public ExtendedProperties getContextProperties return contextProperties public void setUseClasspath boolean useClasspath this useClasspath useClasspath public Context initControlContext throws Exception return new VelocityContext public void execute throws BuildException if templatePath null useClasspath false throw new BuildException if controlTemplate null throw new BuildException if outputDirectory null throw new BuildException if outputFile null throw new BuildException VelocityEngine ve new VelocityEngine try if templatePath null log templatePath project MSG_VERBOSE ve setProperty ve FILE_RESOURCE_LOADER_PATH templatePath if useClasspath log ve addProperty VelocityEngine RESOURCE_LOADER ve setProperty VelocityEngine RESOURCE_LOADER ve setProperty VelocityEngine RESOURCE_LOADER ve setProperty VelocityEngine RESOURCE_LOADER ve init Generator generator Generator getInstance generator setVelocityEngine ve generator setOutputPath outputDirectory generator setInputEncoding inputEncoding generator setOutputEncoding outputEncoding if templatePath null generator setTemplatePath templatePath File file new File outputDirectory if file exists file mkdirs String path outputDirectory File separator outputFile log path project MSG_INFO Writer writer generator getWriter path outputEncoding Context initControlContext populateInitialContext if contextProperties null Iterator contextProperties getKeys while hasNext String property String next String value contextProperties getString property try put property new Integer value catch NumberFormatException nfe String booleanString contextProperties testBoolean value if booleanString null put property new Boolean booleanString else if property endsWith value StringUtils fileContentsToString project resolveFile value getCanonicalPath property property substring property indexOf put property value writer write generator parse controlTemplate writer flush writer close generator shutdown cleanup catch BuildException throw catch MethodInvocationException throw new BuildException getReferenceName getMethodName ERR_MSG_FRAGMENT getWrappedThrowable catch ParseErrorException throw new BuildException ERR_MSG_FRAGMENT catch ResourceNotFoundException throw new BuildException ERR_MSG_FRAGMENT catch Exception throw new BuildException ERR_MSG_FRAGMENT protected void populateInitialContext Context context throws Exception context put new Date toString protected void cleanup throws Exception public class PrimordialLogSystem implements LogSystem private Vector pendingMessages new Vector private RuntimeServices rsvc null public PrimordialLogSystem public void init RuntimeServices rs throws Exception rsvc rs public void logVelocityMessage int level String message synchronized this Object data new Object data new Integer level data message pendingMessages addElement data public void dumpLogMessages LogSystem newLogger synchronized this if pendingMessages isEmpty for Enumeration pendingMessages elements hasMoreElements Object data Object nextElement newLogger logVelocityMessage Integer data intValue String data public interface UberspectLoggable public void setRuntimeLogger RuntimeLogger logger public class ASTGTNode extends SimpleNode public ASTGTNode int id super id public ASTGTNode Parser int id super id public Object jjtAccept ParserVisitor visitor Object data return visitor visit this data public boolean evaluate InternalContextAdapter context throws MethodInvocationException Object left jjtGetChild value context Object right jjtGetChild value context if left null right null rsvc error left null jjtGetChild left null literal context getCurrentTemplateName getLine getColumn return false if left instanceof Integer right instanceof Integer rsvc error left instanceof Integer left instanceof Integer left getClass right getClass context getCurrentTemplateName getLine getColumn return false return Integer left intValue Integer right intValue public Object value InternalContextAdapter context throws MethodInvocationException boolean val evaluate context return val Boolean TRUE Boolean FALSE public class Foreach extends Directive public String getName return public int getType return BLOCK private String counterName private int counterInitialValue private String elementKey protected Info uberInfo public void init RuntimeServices rs InternalContextAdapter context Node node throws Exception super init rs context node counterName rsvc getString RuntimeConstants COUNTER_NAME counterInitialValue rsvc getInt RuntimeConstants COUNTER_INITIAL_VALUE elementKey node jjtGetChild getFirstToken image substring uberInfo new Info context getCurrentTemplateName getLine getColumn public boolean render InternalContextAdapter context Writer writer Node node throws IOException MethodInvocationException ResourceNotFoundException ParseErrorException Object listObject node jjtGetChild value context if listObject null return false Iterator null try rsvc getUberspect getIterator listObject uberInfo catch Exception ee System out println ee if null return false int counter counterInitialValue Object context get elementKey Object ctr context get counterName while hasNext context put counterName new Integer counter context put elementKey next node jjtGetChild render context writer counter if ctr null context put counterName ctr else context remove counterName if null context put elementKey else context remove elementKey return true public class ASTNENode extends SimpleNode public ASTNENode int id super id public ASTNENode Parser int id super id public Object jjtAccept ParserVisitor visitor Object data return visitor visit this data public boolean evaluate InternalContextAdapter context throws MethodInvocationException Object left jjtGetChild value context Object right jjtGetChild value context if left null right null rsvc error left null jjtGetChild left null literal context getCurrentTemplateName getLine getColumn return false if left getClass equals right getClass return left equals right else rsvc error left getClass right getClass context getCurrentTemplateName getLine getColumn return false public Object value InternalContextAdapter context throws MethodInvocationException boolean val evaluate context return val Boolean TRUE Boolean FALSE public class ASTSetDirective extends SimpleNode private String leftReference private Node right private ASTReference left boolean blather false public ASTSetDirective int id super id public ASTSetDirective Parser int id super id public Object jjtAccept ParserVisitor visitor Object data return visitor visit this data public Object init InternalContextAdapter context Object data throws Exception super init context data right getRightHandSide left getLeftHandSide blather rsvc getBoolean RuntimeConstants RUNTIME_LOG_REFERENCE_LOG_INVALID true leftReference left getFirstToken image substring return data public boolean render InternalContextAdapter context Writer writer throws IOException MethodInvocationException Object value right value context if value null if blather EventCartridge ec context getEventCartridge boolean doit true if ec null doit ec shouldLogOnNullSet left literal right literal if doit rsvc error context getCurrentTemplateName getLine getColumn return false if left jjtGetNumChildren context put leftReference value else left setValue context value return true private ASTReference getLeftHandSide return ASTReference jjtGetChild private Node getRightHandSide return jjtGetChild public class TestProvider String title boolean state Object ob null public static String PUB_STAT_STRING int stateint public String getName return public Stack getStack Stack stack new Stack stack push stack push stack push return stack public List getEmptyList List list new ArrayList return list public List getList List list new ArrayList list add list add list add return list public Hashtable getSearch Hashtable new Hashtable put put put put ArrayList al new ArrayList al add put al return public Hashtable getHashtable Hashtable new Hashtable put put put return public ArrayList getRelSearches ArrayList al new ArrayList al add getSearch return al public String getTitle return title public void setTitle String title this title title public Object getMenu Object menu new Object for int Hashtable item new Hashtable item put Integer toString item put Integer toString item put Integer toString menu item return menu public ArrayList getCustomers ArrayList list new ArrayList list add list add list add list add return list public ArrayList getCustomers2 ArrayList list new ArrayList list add new TestProvider list add new TestProvider list add new TestProvider list add new TestProvider return list public Object me return this public String toString return public Vector getVector Vector list new Vector list addElement list addElement return list public String getArray String strings new String strings strings return strings public boolean theAPLRules return true public boolean getStateTrue return true public boolean getStateFalse return false public String objectArrayMethod Object return public String concat Object strings StringBuffer result new StringBuffer for int strings length result append String strings append return result toString public String concat List strings StringBuffer result new StringBuffer for int strings size result append String strings get append return result toString public String objConcat List objects StringBuffer result new StringBuffer for int objects size result append objects get append return result toString public String parse String Object String String return toString public String concat String String return public Person getPerson return new Person public Child getChild return new Child public String showPerson Person person return person getName public String chop String string int return string substring string length public boolean allEmpty Object list int size list length for int size if list toString length return false return true public void setState Boolean state public void setBangStart Integer System out println stateint intValue public Integer bang System out println stateint Integer ret new Integer stateint stateint return ret public String get String key return key public String put String key Object ob return key public String getFoo throws Exception System out println throw new Exception public String getThrow throws Exception System out println throw new Exception public class ASTAndNode extends SimpleNode public ASTAndNode int id super id public ASTAndNode Parser int id super id public Object jjtAccept ParserVisitor visitor Object data return visitor visit this data public Object value InternalContextAdapter context throws MethodInvocationException return new Boolean evaluate context public boolean evaluate InternalContextAdapter context throws MethodInvocationException Node left jjtGetChild Node right jjtGetChild if left null right null rsvc error left null context getCurrentTemplateName getLine getColumn return false if left evaluate context if right evaluate context return true return false public class TemplateTestCase extends BaseTestCase implements TemplateTestBase protected String baseFileName private TestProvider provider private ArrayList al private Hashtable private VelocityContext context private VelocityContext context1 private VelocityContext context2 private Vector vec public TemplateTestCase String baseFileName super getTestCaseName baseFileName this baseFileName baseFileName public static junit framework Test suite return new TemplateTestSuite protected void setUp provider new TestProvider al provider getCustomers new Hashtable put put vec new Vector vec addElement new String vec addElement new String context2 new VelocityContext context1 new VelocityContext context2 context new VelocityContext context1 context put provider context1 put context2 put provider getCustomers2 context put al context1 put context2 put new HashMap context2 put provider getSearch context put provider getRelSearches context1 put provider getRelSearches context2 put provider getArray context put vec context put new String context put new FieldMethodizer context put new FieldMethodizer provider context put context put new BoolObj Object oarr int intarr context put vec context2 put vec iterator context1 put context put oarr context put vec elements context put intarr public void runTest try Template template RuntimeSingleton getTemplate getFileName null baseFileName TMPL_FILE_EXT assureResultsDirectoryExists RESULT_DIR FileOutputStream fos new FileOutputStream getFileName RESULT_DIR baseFileName RESULT_FILE_EXT Writer writer new BufferedWriter new OutputStreamWriter fos template merge context writer writer flush writer close if isMatch RESULT_DIR COMPARE_DIR baseFileName RESULT_FILE_EXT CMP_FILE_EXT fail catch Exception System out println fail getMessage public class IntrospectorTestCase extends BaseTestCase private Method method private String result private String type private ArrayList failures new ArrayList IntrospectorTestCase super public IntrospectorTestCase String name super name public static junit framework Test suite return new IntrospectorTestCase public void runTest MethodProvider mp new MethodProvider try Object booleanParams new Boolean true type method RuntimeSingleton getIntrospector getMethod MethodProvider class type booleanParams result String method invoke mp booleanParams if result equals type failures add type Object byteParams new Byte type method RuntimeSingleton getIntrospector getMethod MethodProvider class type byteParams result String method invoke mp byteParams if result equals type failures add type Object characterParams new Character type method RuntimeSingleton getIntrospector getMethod MethodProvider class type characterParams result String method invoke mp characterParams if result equals type failures add type Object doubleParams new Double double type method RuntimeSingleton getIntrospector getMethod MethodProvider class type doubleParams result String method invoke mp doubleParams if result equals type failures add type Object floatParams new Float float type method RuntimeSingleton getIntrospector getMethod MethodProvider class type floatParams result String method invoke mp floatParams if result equals type failures add type Object integerParams new Integer int type method RuntimeSingleton getIntrospector getMethod MethodProvider class type integerParams result String method invoke mp integerParams if result equals type failures add type Object longParams new Long long type method RuntimeSingleton getIntrospector getMethod MethodProvider class type longParams result String method invoke mp longParams if result equals type failures add type Object shortParams new Short short type method RuntimeSingleton getIntrospector getMethod MethodProvider class type shortParams result String method invoke mp shortParams if result equals type failures add type Object params method RuntimeSingleton getIntrospector getMethod MethodProvider class params if method null failures add type method RuntimeSingleton getIntrospector getMethod MethodProvider class params if method null failures add type int totalFailures failures size if totalFailures StringBuffer sb new StringBuffer for int totalFailures sb append String failures get append fail sb toString catch Exception fail toString public static class MethodProvider public String booleanMethod boolean return public String byteMethod byte return public String characterMethod char return public String doubleMethod double return public String floatMethod float return public String integerMethod int return public String longMethod long return public String shortMethod short return String untouchable return private String reallyuntouchable return public interface RuntimeLogger public void warn Object message public void info Object message public void error Object message public void debug Object message public class JarHolder private String urlpath null private JarFile theJar null private JarURLConnection conn null private RuntimeServices rsvc null public JarHolder RuntimeServices rs String urlpath rsvc rs this urlpath urlpath init rsvc info urlpath public void init try rsvc info urlpath URL url new URL urlpath conn JarURLConnection url openConnection conn setAllowUserInteraction false conn setDoInput true conn setDoOutput false conn connect theJar conn getJarFile catch Exception rsvc error public void close try theJar close catch Exception rsvc error theJar null conn null rsvc info public InputStream getResource String theentry throws ResourceNotFoundException InputStream data null try JarEntry entry theJar getJarEntry theentry if entry null data theJar getInputStream entry catch Exception fnfe rsvc error fnfe throw new ResourceNotFoundException fnfe getMessage return data public Hashtable getEntries Hashtable allEntries new Hashtable Enumeration all theJar entries while all hasMoreElements JarEntry je JarEntry all nextElement if je isDirectory allEntries put je getName this urlpath return allEntries public String getUrlPath return urlpath public class VelocimacroManager private RuntimeServices rsvc null private static String GLOBAL_NAMESPACE private boolean registerFromLib false private Hashtable namespaceHash new Hashtable private Hashtable libraryMap new Hashtable private boolean namespacesOn true private boolean inlineLocalMode false VelocimacroManager RuntimeServices rs this rsvc rs addNamespace GLOBAL_NAMESPACE public boolean addVM String vmName String macroBody String argArray String namespace MacroEntry me new MacroEntry this vmName macroBody argArray namespace me setFromLibrary registerFromLib boolean isLib true if registerFromLib libraryMap put namespace namespace else isLib libraryMap containsKey namespace if isLib usingNamespaces namespace Hashtable local getNamespace namespace true local put String vmName me return true else MacroEntry exist MacroEntry getNamespace GLOBAL_NAMESPACE get vmName if exist null me setFromLibrary exist getFromLibrary getNamespace GLOBAL_NAMESPACE put vmName me return true public VelocimacroProxy get String vmName String namespace if usingNamespaces namespace Hashtable local getNamespace namespace false if local null MacroEntry me MacroEntry local get vmName if me null return me createVelocimacro namespace MacroEntry me MacroEntry getNamespace GLOBAL_NAMESPACE get vmName if me null return me createVelocimacro namespace return null public boolean dumpNamespace String namespace synchronized this if usingNamespaces namespace Hashtable Hashtable namespaceHash remove namespace if null return false clear return true return false public void setNamespaceUsage boolean namespacesOn public void setRegisterFromLib boolean registerFromLib public void setTemplateLocalInlineVM boolean inlineLocalMode private Hashtable getNamespace String namespace return getNamespace namespace false private Hashtable getNamespace String namespace boolean addIfNew Hashtable Hashtable namespaceHash get namespace if null addIfNew addNamespace namespace return private Hashtable addNamespace String namespace Hashtable new Hashtable Object oh if oh namespaceHash put namespace null namespaceHash put namespace oh return null return private boolean usingNamespaces String namespace if namespacesOn return false if inlineLocalMode return true return false public String getLibraryName String vmName String namespace if usingNamespaces namespace Hashtable local getNamespace namespace false if local null MacroEntry me MacroEntry local get vmName if me null return null MacroEntry me MacroEntry getNamespace GLOBAL_NAMESPACE get vmName if me null return me getSourceTemplate return null protected class MacroEntry String macroname String argarray String macrobody String sourcetemplate SimpleNode nodeTree null VelocimacroManager manager null boolean fromLibrary false MacroEntry VelocimacroManager vmm String vmName String macroBody String argArray String sourceTemplate this macroname vmName this argarray argArray this macrobody macroBody this sourcetemplate sourceTemplate this manager vmm public void setFromLibrary boolean fromLibrary public boolean getFromLibrary return fromLibrary public SimpleNode getNodeTree return nodeTree public String getSourceTemplate return sourcetemplate VelocimacroProxy createVelocimacro String namespace VelocimacroProxy vp new VelocimacroProxy vp setName this macroname vp setArgArray this argarray vp setMacrobody this macrobody vp setNodeTree this nodeTree vp setNamespace namespace return vp void setup InternalContextAdapter ica if nodeTree null parseTree ica void parseTree InternalContextAdapter ica try BufferedReader br new BufferedReader new StringReader macrobody nodeTree rsvc parse br macroname true nodeTree init ica null catch Exception rsvc error macroname StringUtils stackTrace public class Introspector extends IntrospectorBase public final static String CACHEDUMP_MSG private RuntimeLogger rlog null public Introspector RuntimeLogger logger this rlog logger public Method getMethod Class String name Object params throws Exception try return super getMethod name params catch MethodMap AmbiguousException ae String msg name for int params length if msg msg msg msg params getClass getName msg msg rlog error msg return null protected void clearCache super clearCache rlog info CACHEDUMP_MSG public class ArrayIterator implements Iterator private Object array private int pos private int size public ArrayIterator Object array if array getClass isArray throw new IllegalArgumentException this array array pos size Array getLength this array public Object next if pos size return Array get array pos throw new NoSuchElementException pos size public boolean hasNext return pos size public void remove throw new UnsupportedOperationException interface InternalHousekeepingContext void pushCurrentTemplateName String void popCurrentTemplateName String getCurrentTemplateName Object getTemplateNameStack IntrospectionCacheData icacheGet Object key void icachePut Object key IntrospectionCacheData Resource getCurrentResource void setCurrentResource Resource public class Test implements ReferenceInsertionEventHandler NullSetEventHandler MethodExceptionEventHandler private static Stack writerStack new Stack public Test String templateFile String encoding Writer writer null TestProvider provider new TestProvider ArrayList al provider getCustomers Hashtable new Hashtable put put Vector new Vector String str addElement new String addElement new String addElement str try Properties new Properties try FileInputStream fis new FileInputStream new File if fis null load fis catch Exception ex for Enumeration propertyNames hasMoreElements String el String nextElement Velocity setProperty el getProperty el Velocity setProperty Velocity RUNTIME_LOG_ERROR_STACKTRACE Velocity setProperty Velocity RUNTIME_LOG_WARN_STACKTRACE Velocity setProperty Velocity RUNTIME_LOG_INFO_STACKTRACE Velocity init if templateFile null templateFile Template template null try template RuntimeSingleton getTemplate templateFile encoding catch ResourceNotFoundException rnfe System out println templateFile catch ParseErrorException pee System out println templateFile pee VelocityContext context new VelocityContext context put provider context put context put provider getCustomers2 context put al context put context put provider getSearch context put provider getRelSearches context put provider getRelSearches context put provider getMenu context put provider getArray context put context put new String context put new HashMap context put new FieldMethodizer context put new FieldMethodizer provider context put context put str context put new Long int intarr Object oarr context put context put iterator context put context put oarr context put intarr String stest StringWriter new StringWriter new StringWriter new StringWriter EventCartridge ec new EventCartridge ec addEventHandler this ec attachToContext context VelocityContext vc new VelocityContext context if template null writer new BufferedWriter new OutputStreamWriter System out encoding template merge vc writer writer flush writer close catch MethodInvocationException mie System out println mie catch Exception RuntimeSingleton error printStackTrace public Object referenceInsert String reference Object value if value null return value public boolean shouldLogOnNullSet String lhs String rhs if lhs equals return false return true public Object methodException Class claz String method Exception throws Exception if method equals return throw public static void main String args Test String encoding if args length encoding args new Test args encoding public interface InternalContextAdapter extends InternalHousekeepingContext Context InternalWrapperContext InternalEventContext public class MultiLoaderTestCase extends BaseTestCase private static final String TMPL_FILE_EXT private static final String CMP_FILE_EXT private static final String RESULT_FILE_EXT private static final String RESULTS_DIR private final static String FILE_RESOURCE_LOADER_PATH private static final String COMPARE_DIR public MultiLoaderTestCase super try assureResultsDirectoryExists RESULTS_DIR Velocity setProperty Velocity RESOURCE_LOADER Velocity setProperty Velocity FILE_RESOURCE_LOADER_PATH FILE_RESOURCE_LOADER_PATH Velocity addProperty Velocity RESOURCE_LOADER Velocity addProperty Velocity RESOURCE_LOADER Velocity setProperty Velocity RESOURCE_LOADER Velocity setProperty Velocity RESOURCE_LOADER Velocity setProperty Velocity RESOURCE_LOADER Velocity setProperty Velocity RESOURCE_LOADER Velocity setProperty Velocity RESOURCE_LOADER FILE_RESOURCE_LOADER_PATH Velocity init catch Exception System err println printStackTrace System exit public static junit framework Test suite return new MultiLoaderTestCase public void runTest try assureResultsDirectoryExists RESULTS_DIR Template template1 Velocity getTemplate getFileName null TMPL_FILE_EXT Template template2 Velocity getTemplate getFileName null TMPL_FILE_EXT Template template3 Velocity getTemplate getFileName null TMPL_FILE_EXT FileOutputStream fos1 new FileOutputStream getFileName RESULTS_DIR RESULT_FILE_EXT FileOutputStream fos2 new FileOutputStream getFileName RESULTS_DIR RESULT_FILE_EXT FileOutputStream fos3 new FileOutputStream getFileName RESULTS_DIR RESULT_FILE_EXT Writer writer1 new BufferedWriter new OutputStreamWriter fos1 Writer writer2 new BufferedWriter new OutputStreamWriter fos2 Writer writer3 new BufferedWriter new OutputStreamWriter fos3 VelocityContext context new VelocityContext template1 merge context writer1 writer1 flush writer1 close template2 merge context writer2 writer2 flush writer2 close template3 merge context writer3 writer3 flush writer3 close if isMatch RESULTS_DIR COMPARE_DIR RESULT_FILE_EXT CMP_FILE_EXT fail if isMatch RESULTS_DIR COMPARE_DIR RESULT_FILE_EXT CMP_FILE_EXT fail if isMatch RESULTS_DIR COMPARE_DIR RESULT_FILE_EXT CMP_FILE_EXT fail catch Exception fail getMessage public class ASTSubtractNode extends SimpleNode public ASTSubtractNode int id super id public ASTSubtractNode Parser int id super id public Object jjtAccept ParserVisitor visitor Object data return visitor visit this data public Object value InternalContextAdapter context throws MethodInvocationException Object left jjtGetChild value context Object right jjtGetChild value context if left null right null rsvc error left null jjtGetChild left null literal context getCurrentTemplateName getLine getColumn return null if left instanceof Integer right instanceof Integer rsvc error left instanceof Integer context getCurrentTemplateName getLine getColumn return null return new Integer Integer left intValue Integer right intValue public class ParseDirectiveException extends Exception private Stack filenameStack new Stack private String msg private int depthCount ParseDirectiveException String int msg depthCount public String getMessage String returnStr depthCount msg returnStr try while filenameStack empty returnStr String filenameStack pop returnStr catch Exception return returnStr public void addFile String filenameStack push public interface ResourceManager public static final int RESOURCE_TEMPLATE public static final int RESOURCE_CONTENT public void initialize RuntimeServices rs throws Exception public Resource getResource String resourceName int resourceType String encoding throws ResourceNotFoundException ParseErrorException Exception public String getLoaderNameForResource String resourceName class InternalContextBase implements InternalHousekeepingContext InternalEventContext Serializable private HashMap introspectionCache new HashMap private Stack templateNameStack new Stack private EventCartridge eventCartridge null private Resource currentResource null public void pushCurrentTemplateName String templateNameStack push return public void popCurrentTemplateName templateNameStack pop return public String getCurrentTemplateName if templateNameStack empty return else return String templateNameStack peek public Object getTemplateNameStack return templateNameStack toArray public IntrospectionCacheData icacheGet Object key return IntrospectionCacheData introspectionCache get key public void icachePut Object key IntrospectionCacheData introspectionCache put key public void setCurrentResource Resource currentResource public Resource getCurrentResource return currentResource public EventCartridge attachEventCartridge EventCartridge ec EventCartridge temp eventCartridge eventCartridge ec return temp public EventCartridge getEventCartridge return eventCartridge public abstract class BaseVisitor implements ParserVisitor protected InternalContextAdapter context protected Writer writer public void setWriter Writer writer this writer writer public void setContext InternalContextAdapter context this context context public Object visit SimpleNode node Object data data node childrenAccept this data return data public Object visit ASTprocess node Object data data node childrenAccept this data return data public Object visit ASTExpression node Object data data node childrenAccept this data return data public Object visit ASTAssignment node Object data data node childrenAccept this data return data public Object visit ASTOrNode node Object data data node childrenAccept this data return data public Object visit ASTAndNode node Object data data node childrenAccept this data return data public Object visit ASTEQNode node Object data data node childrenAccept this data return data public Object visit ASTNENode node Object data data node childrenAccept this data return data public Object visit ASTLTNode node Object data data node childrenAccept this data return data public Object visit ASTGTNode node Object data data node childrenAccept this data return data public Object visit ASTLENode node Object data data node childrenAccept this data return data public Object visit ASTGENode node Object data data node childrenAccept this data return data public Object visit ASTAddNode node Object data data node childrenAccept this data return data public Object visit ASTSubtractNode node Object data data node childrenAccept this data return data public Object visit ASTMulNode node Object data data node childrenAccept this data return data public Object visit ASTDivNode node Object data data node childrenAccept this data return data public Object visit ASTModNode node Object data data node childrenAccept this data return data public Object visit ASTNotNode node Object data data node childrenAccept this data return data public Object visit ASTNumberLiteral node Object data data node childrenAccept this data return data public Object visit ASTStringLiteral node Object data data node childrenAccept this data return data public Object visit ASTIdentifier node Object data data node childrenAccept this data return data public Object visit ASTMethod node Object data data node childrenAccept this data return data public Object visit ASTReference node Object data data node childrenAccept this data return data public Object visit ASTTrue node Object data data node childrenAccept this data return data public Object visit ASTFalse node Object data data node childrenAccept this data return data public Object visit ASTBlock node Object data data node childrenAccept this data return data public Object visit ASTText node Object data data node childrenAccept this data return data public Object visit ASTIfStatement node Object data data node childrenAccept this data return data public Object visit ASTElseStatement node Object data data node childrenAccept this data return data public Object visit ASTElseIfStatement node Object data data node childrenAccept this data return data public Object visit ASTComment node Object data data node childrenAccept this data return data public Object visit ASTObjectArray node Object data data node childrenAccept this data return data public Object visit ASTWord node Object data data node childrenAccept this data return data public Object visit ASTSetDirective node Object data data node childrenAccept this data return data public Object visit ASTDirective node Object data data node childrenAccept this data return data public class ConfigurationTestCase extends BaseTestCase private static final String COMPARE_DIR private static final String RESULTS_DIR private static final String TEST_CONFIG public ConfigurationTestCase super public static junit framework Test suite return new ConfigurationTestCase public void runTest try assureResultsDirectoryExists RESULTS_DIR Configuration new Configuration TEST_CONFIG FileWriter result new FileWriter getFileName RESULTS_DIR message result showIterator result getKeys message result showVector result getVector message result Configuration subset subset showIterator result subset getKeys message result showVector result subset getVector message result result write getString result write message result result write new Boolean getBoolean toString result write message result result write new Byte getByte toString result write message result result write new Short getShort toString result write message result result write new Integer getInt toString result write message result result write new Long getLong toString result write message result result write new Float getFloat toString result write message result result write new Double getDouble toString result write message result result write getString result write message result showVector result getVector result write result flush result close if isMatch RESULTS_DIR COMPARE_DIR fail catch Exception System err println printStackTrace System exit private void showIterator FileWriter result Iterator throws Exception while hasNext result write String next result write result write private void showVector FileWriter result Vector throws Exception for int size result write String get result write result write private void message FileWriter result String message throws Exception result write result write message result write result write public class MacroParseException extends ParseException public MacroParseException String msg super msg class XPathCache private static final Map XPATH_CACHE new WeakHashMap private XPathCache static XPath getXPath String xpathString XPath xpath null synchronized XPATH_CACHE xpath XPath XPATH_CACHE get xpathString if xpath null xpath new XPath xpathString XPATH_CACHE put xpathString xpath return xpath public class PropertyExecutor extends AbstractExecutor protected Introspector introspector null protected String methodUsed null public PropertyExecutor RuntimeLogger Introspector ispctr Class clazz String property rlog introspector ispctr discover clazz property protected void discover Class clazz String property try char StringBuffer sb Object params sb new StringBuffer sb append property methodUsed sb toString method introspector getMethod clazz methodUsed params if method null return sb new StringBuffer sb append property sb charAt if Character isLowerCase sb setCharAt Character toUpperCase else sb setCharAt Character toLowerCase methodUsed sb toString method introspector getMethod clazz methodUsed params if method null return catch Exception rlog error public Object execute Object throws IllegalAccessException InvocationTargetException if method null return null return method invoke null public class MethodInvocationExceptionTest extends TestCase public MethodInvocationExceptionTest super try Velocity init catch Exception System err println System exit public static junit framework Test suite return new MethodInvocationExceptionTest public void runTest String template VelocityContext vc new VelocityContext vc put this StringWriter new StringWriter try Velocity evaluate vc template fail catch MethodInvocationException mie System out println System out println mie getReferenceName System out println mie getMethodName Throwable mie getWrappedThrowable System out println if instanceof Exception System out println Exception getMessage catch Exception fail printStackTrace template try Velocity evaluate vc template fail catch MethodInvocationException mie System out println System out println mie getReferenceName System out println mie getMethodName Throwable mie getWrappedThrowable System out println if instanceof Exception System out println Exception getMessage catch Exception fail template try Velocity evaluate vc template fail catch MethodInvocationException mie System out println System out println mie getReferenceName System out println mie getMethodName Throwable mie getWrappedThrowable System out println if instanceof Exception System out println Exception getMessage catch Exception fail template try Velocity evaluate vc template fail catch MethodInvocationException mie System out println System out println mie getReferenceName System out println mie getMethodName Throwable mie getWrappedThrowable System out println if instanceof Exception System out println Exception getMessage catch Exception fail public void doException throws Exception throw new NullPointerException public void getFoo throws Exception throw new Exception public void setFoo String foo throws Exception throw new Exception public class BooleanPropertyExecutor extends PropertyExecutor public BooleanPropertyExecutor RuntimeLogger rlog Introspector is Class clazz String property super rlog is clazz property protected void discover Class clazz String property try char StringBuffer sb Object params sb new StringBuffer sb append property sb charAt if Character isLowerCase sb setCharAt Character toUpperCase methodUsed sb toString method introspector getMethod clazz methodUsed params if method null if method getReturnType Boolean TYPE return method null catch Exception rlog error public class VMReferenceMungeVisitor extends BaseVisitor private Map argmap null public VMReferenceMungeVisitor Map map argmap map public Object visit ASTReference node Object data String override String argmap get node literal substring if override null node setLiteral override data node childrenAccept this data return data public class ResourceNotFoundException extends VelocityException public ResourceNotFoundException String exceptionMessage super exceptionMessage public final class InternalContextAdapterImpl implements InternalContextAdapter Context context null InternalHousekeepingContext icb null InternalEventContext iec null public InternalContextAdapterImpl Context context if instanceof InternalHousekeepingContext icb new InternalContextBase else icb InternalHousekeepingContext context if instanceof InternalEventContext iec InternalEventContext context public void pushCurrentTemplateName String icb pushCurrentTemplateName public void popCurrentTemplateName icb popCurrentTemplateName public String getCurrentTemplateName return icb getCurrentTemplateName public Object getTemplateNameStack return icb getTemplateNameStack public IntrospectionCacheData icacheGet Object key return icb icacheGet key public void icachePut Object key IntrospectionCacheData icb icachePut key public void setCurrentResource Resource icb setCurrentResource public Resource getCurrentResource return icb getCurrentResource public Object put String key Object value return context put key value public Object get String key return context get key public boolean containsKey Object key return context containsKey key public Object getKeys return context getKeys public Object remove Object key return context remove key public Context getInternalUserContext return context public InternalContextAdapter getBaseContext return this public EventCartridge attachEventCartridge EventCartridge ec if iec null return iec attachEventCartridge ec return null public EventCartridge getEventCartridge if iec null return iec getEventCartridge return null public interface DirectiveConstants public static final int BLOCK public static final int LINE public class VelocimacroTestCase extends TestCase private String template1 private String result1 public VelocimacroTestCase super try Velocity setProperty Velocity VM_PERM_INLINE_LOCAL Boolean TRUE Velocity init catch Exception System err println System exit public static junit framework Test suite return new VelocimacroTestCase public void runTest VelocityContext context new VelocityContext try StringWriter writer new StringWriter Velocity evaluate context writer template1 String out writer toString if result1 equals out fail catch Exception fail getMessage public class VMProxyArg private int type private SimpleNode nodeTree null private Object staticObject null private InternalContextAdapter usercontext null private int numTreeChildren private String contextReference null private String callerReference null private String singleLevelRef null private boolean constant false private final int GENERALSTATIC private RuntimeServices rsvc null public VMProxyArg RuntimeServices rs String contextRef String callerRef int rsvc rs contextReference contextRef callerReference callerRef type setup if nodeTree null numTreeChildren nodeTree jjtGetNumChildren if type ParserTreeConstants JJTREFERENCE if numTreeChildren singleLevelRef ASTReference nodeTree getRootString public boolean isConstant return constant public Object setObject InternalContextAdapter context Object if type ParserTreeConstants JJTREFERENCE if numTreeChildren try ASTReference nodeTree setValue context catch MethodInvocationException mie rsvc error mie else context put singleLevelRef else type GENERALSTATIC staticObject rsvc error contextReference callerReference return null public Object getObject InternalContextAdapter context try Object retObject null if type ParserTreeConstants JJTREFERENCE if numTreeChildren retObject context get singleLevelRef else retObject nodeTree execute null context else if type ParserTreeConstants JJTOBJECTARRAY retObject nodeTree value context else if type ParserTreeConstants JJTINTEGERRANGE retObject nodeTree value context else if type ParserTreeConstants JJTTRUE retObject staticObject else if type ParserTreeConstants JJTFALSE retObject staticObject else if type ParserTreeConstants JJTSTRINGLITERAL retObject nodeTree value context else if type ParserTreeConstants JJTNUMBERLITERAL retObject staticObject else if type ParserTreeConstants JJTTEXT try StringWriter writer new StringWriter nodeTree render context writer retObject writer catch Exception rsvc error else if type GENERALSTATIC retObject staticObject else rsvc error callerReference type return retObject catch MethodInvocationException mie rsvc error mie return null private void setup switch type case ParserTreeConstants JJTINTEGERRANGE case ParserTreeConstants JJTREFERENCE case ParserTreeConstants JJTOBJECTARRAY case ParserTreeConstants JJTSTRINGLITERAL case ParserTreeConstants JJTTEXT constant false try String buff callerReference BufferedReader br new BufferedReader new StringReader buff nodeTree rsvc parse br callerReference true nodeTree SimpleNode nodeTree jjtGetChild jjtGetChild if nodeTree null nodeTree getType type rsvc error InternalContextAdapter ica new InternalContextAdapterImpl new VelocityContext ica pushCurrentTemplateName ParserTreeConstants jjtNodeName type nodeTree init ica rsvc catch Exception rsvc error callerReference StringUtils stackTrace break case ParserTreeConstants JJTTRUE constant true staticObject new Boolean true break case ParserTreeConstants JJTFALSE constant true staticObject new Boolean false break case ParserTreeConstants JJTNUMBERLITERAL constant true staticObject new Integer callerReference break case ParserTreeConstants JJTWORD rsvc error callerReference constant true staticObject new String callerReference break default rsvc error callerReference public VMProxyArg VMProxyArg model InternalContextAdapter usercontext contextReference model getContextReference callerReference model getCallerReference nodeTree model getNodeTree staticObject model getStaticObject type model getType if nodeTree null numTreeChildren nodeTree jjtGetNumChildren if type ParserTreeConstants JJTREFERENCE if numTreeChildren singleLevelRef ASTReference nodeTree getRootString public String getCallerReference return callerReference public String getContextReference return contextReference public SimpleNode getNodeTree return nodeTree public Object getStaticObject return staticObject public int getType return type public abstract class AbstractExecutor protected RuntimeLogger rlog null protected Method method null public abstract Object execute Object throws IllegalAccessException InvocationTargetException public boolean isAlive return method null public Method getMethod return method public interface VelMethod public Object invoke Object Object params throws Exception public boolean isCacheable public String getMethodName public Class getReturnType public class ASTParameters extends SimpleNode public ASTParameters int id super id public ASTParameters Parser int id super id public Object jjtAccept ParserVisitor visitor Object data return visitor visit this data public class Velocity implements RuntimeConstants public static void init throws Exception RuntimeSingleton init public static void init String propsFilename throws Exception RuntimeSingleton init propsFilename public static void init Properties throws Exception RuntimeSingleton init public static void setProperty String key Object value RuntimeSingleton setProperty key value public static void addProperty String key Object value RuntimeSingleton addProperty key value public static void clearProperty String key RuntimeSingleton clearProperty key public static void setConfiguration Configuration configuration ExtendedProperties ep configuration getExtendedProperties RuntimeSingleton setConfiguration ep public static void setExtendedProperties ExtendedProperties configuration RuntimeSingleton setConfiguration configuration public static Object getProperty String key return RuntimeSingleton getProperty key public static boolean evaluate Context context Writer out String logTag String instring throws ParseErrorException MethodInvocationException ResourceNotFoundException IOException return evaluate context out logTag new BufferedReader new StringReader instring public static boolean evaluate Context context Writer writer String logTag InputStream instream throws ParseErrorException MethodInvocationException ResourceNotFoundException IOException BufferedReader br null String encoding null try encoding RuntimeSingleton getString INPUT_ENCODING ENCODING_DEFAULT br new BufferedReader new InputStreamReader instream encoding catch UnsupportedEncodingException uce String msg encoding logTag throw new ParseErrorException msg return evaluate context writer logTag br public static boolean evaluate Context context Writer writer String logTag Reader reader throws ParseErrorException MethodInvocationException ResourceNotFoundException IOException SimpleNode nodeTree null try nodeTree RuntimeSingleton parse reader logTag catch ParseException pex throw new ParseErrorException pex getMessage if nodeTree null InternalContextAdapterImpl ica new InternalContextAdapterImpl context ica pushCurrentTemplateName logTag try try nodeTree init ica RuntimeSingleton getRuntimeServices catch Exception RuntimeSingleton error logTag nodeTree render ica writer finally ica popCurrentTemplateName return true return false public static boolean invokeVelocimacro String vmName String logTag String params Context context Writer writer if vmName null params null context null writer null logTag null RuntimeSingleton error return false if RuntimeSingleton isVelocimacro vmName logTag RuntimeSingleton error vmName return false StringBuffer construct new StringBuffer construct append vmName construct append for int params length construct append construct append params construct append try boolean retval evaluate context writer logTag construct toString return retval catch Exception RuntimeSingleton error return false public static boolean mergeTemplate String templateName Context context Writer writer throws ResourceNotFoundException ParseErrorException MethodInvocationException Exception return mergeTemplate templateName RuntimeSingleton getString INPUT_ENCODING ENCODING_DEFAULT context writer public static boolean mergeTemplate String templateName String encoding Context context Writer writer throws ResourceNotFoundException ParseErrorException MethodInvocationException Exception Template template RuntimeSingleton getTemplate templateName encoding if template null RuntimeSingleton error templateName return false else template merge context writer return true public static Template getTemplate String name throws ResourceNotFoundException ParseErrorException Exception return RuntimeSingleton getTemplate name public static Template getTemplate String name String encoding throws ResourceNotFoundException ParseErrorException Exception return RuntimeSingleton getTemplate name encoding public static boolean resourceExists String resourceName return RuntimeSingleton getLoaderNameForResource resourceName null public static void warn Object message RuntimeSingleton warn message public static void info Object message RuntimeSingleton info message public static void error Object message RuntimeSingleton error message public static void debug Object message RuntimeSingleton debug message public static void setApplicationAttribute Object key Object value RuntimeSingleton getRuntimeInstance setApplicationAttribute key value public static boolean templateExists String resourceName return resourceExists resourceName public class WebMacro protected static final String VM_EXT protected static final String WM_EXT protected static String perLineREs public void convert String target File file new File target if file exists System err println System exit if file isDirectory String basedir file getAbsolutePath String newBasedir basedir VM_EXT DirectoryScanner ds new DirectoryScanner ds setBasedir basedir ds addDefaultExcludes ds scan String files ds getIncludedFiles for int files length writeTemplate files basedir newBasedir else writeTemplate file getAbsolutePath private boolean writeTemplate String file String basedir String newBasedir if file indexOf WM_EXT return false System out println file String template String templateDir String newTemplate File outputDirectory if basedir length template file templateDir newTemplate convertName file else template basedir File separator file templateDir newBasedir extractPath file outputDirectory new File templateDir if outputDirectory exists outputDirectory mkdirs newTemplate newBasedir File separator convertName file String convertedTemplate convertTemplate template try FileWriter fw new FileWriter newTemplate fw write convertedTemplate fw close catch Exception printStackTrace return true private final String extractPath String file int lastSepPos file lastIndexOf File separator return lastSepPos File separator file substring lastSepPos private String convertName String name if name indexOf WM_EXT return name substring name indexOf WM_EXT VM_EXT else return name private static final void usage System err println System exit public String convertTemplate String template String contents StringUtils fileContentsToString template if contents endsWith contents Perl5Util perl new Perl5Util for int perLineREs length contents perl substitute makeSubstRE contents if perl match contents contents perl substitute contents else contents perl substitute contents contents perl substitute contents return contents private final String makeSubstRE int return perLineREs perLineREs public static void main String args if args length for int args length WebMacro converter new WebMacro converter convert args else usage public interface InternalWrapperContext public Context getInternalUserContext public InternalContextAdapter getBaseContext public class ASTEscape extends SimpleNode public String val private char ctext public ASTEscape int id super id public ASTEscape Parser int id super id public Object jjtAccept ParserVisitor visitor Object data return visitor visit this data public Object init InternalContextAdapter context Object data throws Exception ctext val toCharArray return data public boolean render InternalContextAdapter context Writer writer throws IOException writer write ctext return true public class ClasspathResourceTest extends BaseTestCase private static final String TMPL_FILE_EXT private static final String CMP_FILE_EXT private static final String RESULT_FILE_EXT private static final String RESULTS_DIR private static final String COMPARE_DIR public ClasspathResourceTest super try assureResultsDirectoryExists RESULTS_DIR Velocity setProperty Velocity RESOURCE_LOADER Velocity addProperty Velocity RESOURCE_LOADER Velocity setProperty Velocity RESOURCE_LOADER Velocity setProperty Velocity RESOURCE_LOADER Velocity init catch Exception System err println printStackTrace System exit public static junit framework Test suite return new ClasspathResourceTest public void runTest try assureResultsDirectoryExists RESULTS_DIR Template template1 RuntimeSingleton getTemplate getFileName null TMPL_FILE_EXT Template template2 RuntimeSingleton getTemplate getFileName null TMPL_FILE_EXT FileOutputStream fos1 new FileOutputStream getFileName RESULTS_DIR RESULT_FILE_EXT FileOutputStream fos2 new FileOutputStream getFileName RESULTS_DIR RESULT_FILE_EXT Writer writer1 new BufferedWriter new OutputStreamWriter fos1 Writer writer2 new BufferedWriter new OutputStreamWriter fos2 VelocityContext context new VelocityContext template1 merge context writer1 writer1 flush writer1 close template2 merge context writer2 writer2 flush writer2 close if isMatch RESULTS_DIR COMPARE_DIR RESULT_FILE_EXT CMP_FILE_EXT isMatch RESULTS_DIR COMPARE_DIR RESULT_FILE_EXT CMP_FILE_EXT fail catch Exception fail getMessage public abstract class InputBase extends Directive protected String getInputEncoding InternalContextAdapter context Resource current context getCurrentResource if current null return current getEncoding else return String rsvc getProperty RuntimeConstants INPUT_ENCODING public class ASTElseStatement extends SimpleNode public ASTElseStatement int id super id public ASTElseStatement Parser int id super id public Object jjtAccept ParserVisitor visitor Object data return visitor visit this data public boolean evaluate InternalContextAdapter context return true public class VelocityFormatter extends PatternFormatter public VelocityFormatter String format super format protected String getTime final long time final String format return new Date toString public interface VelPropertySet public Object invoke Object Object arg throws Exception public boolean isCacheable public String getMethodName public class OutputWrapper extends XMLOutputter public OutputWrapper public String outputString Element element boolean strip StringWriter buff new StringWriter String name element getName try outputElementContent element buff catch IOException return buff toString public class ASTNumberLiteral extends SimpleNode private Integer value null public ASTNumberLiteral int id super id public ASTNumberLiteral Parser int id super id public Object jjtAccept ParserVisitor visitor Object data return visitor visit this data public Object init InternalContextAdapter context Object data throws Exception super init context data value new Integer getFirstToken image return data public Object value InternalContextAdapter context return value public class ASTIdentifier extends SimpleNode private String identifier protected Info uberInfo public ASTIdentifier int id super id public ASTIdentifier Parser int id super id public Object jjtAccept ParserVisitor visitor Object data return visitor visit this data public Object init InternalContextAdapter context Object data throws Exception super init context data identifier getFirstToken image uberInfo new Info context getCurrentTemplateName getLine getColumn return data public Object execute Object InternalContextAdapter context throws MethodInvocationException VelPropertyGet vg null try Class getClass IntrospectionCacheData icd context icacheGet this if icd null icd contextData vg VelPropertyGet icd thingy else vg rsvc getUberspect getPropertyGet identifier uberInfo if vg null vg isCacheable icd new IntrospectionCacheData icd contextData icd thingy vg context icachePut this icd catch Exception rsvc error identifier if vg null return null try return vg invoke catch InvocationTargetException ite EventCartridge ec context getEventCartridge if ec null ite getTargetException instanceof java lang Exception try return ec methodException getClass vg getMethodName Exception ite getTargetException catch Exception throw new MethodInvocationException vg getMethodName getClass ite getTargetException getClass ite getTargetException getMessage ite getTargetException vg getMethodName else throw new MethodInvocationException vg getMethodName getClass ite getTargetException getClass ite getTargetException getMessage ite getTargetException vg getMethodName catch IllegalArgumentException iae return null catch Exception rsvc error identifier getClass return null public class BoolObj public boolean isBoolean return true public String isNotboolean return public class VelocityException extends Exception public VelocityException String exceptionMessage super exceptionMessage public class MethodMap private static final int MORE_SPECIFIC private static final int LESS_SPECIFIC private static final int INCOMPARABLE Map methodByNameMap new Hashtable public void add Method method String methodName method getName List get methodName if null new ArrayList methodByNameMap put methodName add method return public List get String key return List methodByNameMap get key public Method find String methodName Object args throws AmbiguousException List methodList get methodName if methodList null return null int args length Class classes new Class for int Object arg args classes arg null null arg getClass return getMostSpecific methodList classes public static class AmbiguousException extends Exception private static Method getMostSpecific List methods Class classes throws AmbiguousException LinkedList applicables getApplicables methods classes if applicables isEmpty return null if applicables size return Method applicables getFirst LinkedList maximals new LinkedList for Iterator applicable applicables iterator applicable hasNext Method app Method applicable next Class appArgs app getParameterTypes boolean lessSpecific false for Iterator maximal maximals iterator lessSpecific maximal hasNext Method max Method maximal next switch moreSpecific appArgs max getParameterTypes case MORE_SPECIFIC maximal remove break case LESS_SPECIFIC lessSpecific true break if lessSpecific maximals addLast app if maximals size throw new AmbiguousException return Method maximals getFirst private static int moreSpecific Class c1 Class c2 boolean c1MoreSpecific false boolean c2MoreSpecific false for int c1 length if c1 c2 c1MoreSpecific c1MoreSpecific isStrictMethodInvocationConvertible c2 c1 c2MoreSpecific c2MoreSpecific isStrictMethodInvocationConvertible c1 c2 if c1MoreSpecific if c2MoreSpecific return INCOMPARABLE return MORE_SPECIFIC if c2MoreSpecific return LESS_SPECIFIC return INCOMPARABLE private static LinkedList getApplicables List methods Class classes LinkedList list new LinkedList for Iterator imethod methods iterator imethod hasNext Method method Method imethod next if isApplicable method classes list add method return list private static boolean isApplicable Method method Class classes Class methodArgs method getParameterTypes if methodArgs length classes length return false for int classes length if isMethodInvocationConvertible methodArgs classes return false return true private static boolean isMethodInvocationConvertible Class formal Class actual if actual null formal isPrimitive return true if actual null formal isAssignableFrom actual return true if formal isPrimitive if formal Boolean TYPE actual Boolean class return true if formal Character TYPE actual Character class return true if formal Byte TYPE actual Byte class return true if formal Short TYPE actual Short class actual Byte class return true if formal Integer TYPE actual Integer class actual Short class actual Byte class return true if formal Long TYPE actual Long class actual Integer class actual Short class actual Byte class return true if formal Float TYPE actual Float class actual Long class actual Integer class actual Short class actual Byte class return true if formal Double TYPE actual Double class actual Float class actual Long class actual Integer class actual Short class actual Byte class return true return false private static boolean isStrictMethodInvocationConvertible Class formal Class actual if actual null formal isPrimitive return true if formal isAssignableFrom actual return true if formal isPrimitive if formal Short TYPE actual Byte TYPE return true if formal Integer TYPE actual Short TYPE actual Byte TYPE return true if formal Long TYPE actual Integer TYPE actual Short TYPE actual Byte TYPE return true if formal Float TYPE actual Long TYPE actual Integer TYPE actual Short TYPE actual Byte TYPE return true if formal Double TYPE actual Float TYPE actual Long TYPE actual Integer TYPE actual Short TYPE actual Byte TYPE return true return false public class VelocityEngine implements RuntimeConstants private RuntimeInstance ri new RuntimeInstance public void init throws Exception ri init public void init String propsFilename throws Exception ri init propsFilename public void init Properties throws Exception ri init public void setProperty String key Object value ri setProperty key value public void addProperty String key Object value ri addProperty key value public void clearProperty String key ri clearProperty key public void setConfiguration Configuration configuration ExtendedProperties ep configuration getExtendedProperties ri setConfiguration ep public void setExtendedProperties ExtendedProperties configuration ri setConfiguration configuration public Object getProperty String key return ri getProperty key public boolean evaluate Context context Writer out String logTag String instring throws ParseErrorException MethodInvocationException ResourceNotFoundException IOException return evaluate context out logTag new BufferedReader new StringReader instring public boolean evaluate Context context Writer writer String logTag InputStream instream throws ParseErrorException MethodInvocationException ResourceNotFoundException IOException BufferedReader br null String encoding null try encoding ri getString INPUT_ENCODING ENCODING_DEFAULT br new BufferedReader new InputStreamReader instream encoding catch UnsupportedEncodingException uce String msg encoding logTag throw new ParseErrorException msg return evaluate context writer logTag br public boolean evaluate Context context Writer writer String logTag Reader reader throws ParseErrorException MethodInvocationException ResourceNotFoundException IOException SimpleNode nodeTree null try nodeTree ri parse reader logTag catch ParseException pex throw new ParseErrorException pex getMessage if nodeTree null InternalContextAdapterImpl ica new InternalContextAdapterImpl context ica pushCurrentTemplateName logTag try try nodeTree init ica ri catch Exception ri error logTag nodeTree render ica writer finally ica popCurrentTemplateName return true return false public boolean invokeVelocimacro String vmName String logTag String params Context context Writer writer throws Exception if vmName null params null context null writer null logTag null ri error return false if ri isVelocimacro vmName logTag ri error vmName return false StringBuffer construct new StringBuffer construct append vmName construct append for int params length construct append construct append params construct append try boolean retval evaluate context writer logTag construct toString return retval catch Exception ri error throw public boolean mergeTemplate String templateName Context context Writer writer throws ResourceNotFoundException ParseErrorException MethodInvocationException Exception return mergeTemplate templateName ri getString INPUT_ENCODING ENCODING_DEFAULT context writer public boolean mergeTemplate String templateName String encoding Context context Writer writer throws ResourceNotFoundException ParseErrorException MethodInvocationException Exception Template template ri getTemplate templateName encoding if template null ri error templateName return false else template merge context writer return true public Template getTemplate String name throws ResourceNotFoundException ParseErrorException Exception return ri getTemplate name public Template getTemplate String name String encoding throws ResourceNotFoundException ParseErrorException Exception return ri getTemplate name encoding public boolean templateExists String templateName return ri getLoaderNameForResource templateName null public void warn Object message ri warn message public void info Object message ri info message public void error Object message ri error message public void debug Object message ri debug message public void setApplicationAttribute Object key Object value ri setApplicationAttribute key value public class VelocimacroProxy extends Directive private String macroName private String macroBody private String argArray null private SimpleNode nodeTree null private int numMacroArgs private String namespace private boolean init false private String callingArgs private int callingArgTypes private HashMap proxyArgHash new HashMap public String getName return macroName public int getType return LINE public void setName String name macroName name public void setArgArray String arr argArray arr numMacroArgs argArray length public void setNodeTree SimpleNode tree nodeTree tree public int getNumArgs return numMacroArgs public void setMacrobody String mb macroBody mb public void setNamespace String ns this namespace ns public boolean render InternalContextAdapter context Writer writer Node node throws IOException MethodInvocationException try if nodeTree null if init nodeTree init context rsvc init true VMContext vmc new VMContext context rsvc for int argArray length VMProxyArg arg VMProxyArg proxyArgHash get argArray vmc addVMProxyArg arg nodeTree render vmc writer else rsvc error macroName catch Exception if instanceof MethodInvocationException throw MethodInvocationException rsvc error macroName StringUtils stackTrace return true public void init RuntimeServices rs InternalContextAdapter context Node node throws Exception super init rs context node int node jjtGetNumChildren if getNumArgs rsvc error macroName getNumArgs getNumArgs return callingArgs getArgArray node setupMacro callingArgs callingArgTypes return public boolean setupMacro String callArgs int callArgTypes setupProxyArgs callArgs callArgTypes parseTree callArgs return true private void parseTree String callArgs try BufferedReader br new BufferedReader new StringReader macroBody nodeTree rsvc parse br namespace false HashMap hm new HashMap for int argArray length String arg callArgs if arg charAt hm put argArray arg VMReferenceMungeVisitor new VMReferenceMungeVisitor hm nodeTree jjtAccept null catch Exception rsvc error macroName StringUtils stackTrace private void setupProxyArgs String callArgs int callArgTypes for int argArray length VMProxyArg arg new VMProxyArg rsvc argArray callArgs callArgTypes proxyArgHash put argArray arg private String getArgArray Node node int numArgs node jjtGetNumChildren String args new String numArgs callingArgTypes new int numArgs int Token null Token tLast null while numArgs args callingArgTypes node jjtGetChild getType if false node jjtGetChild getType ParserTreeConstants JJTSTRINGLITERAL args node jjtGetChild getFirstToken image substring node jjtGetChild getFirstToken image length else node jjtGetChild getFirstToken tLast node jjtGetChild getLastToken while tLast args image next args image return args public class ASTAssignment extends SimpleNode public ASTAssignment int id super id public ASTAssignment Parser int id super id public Object jjtAccept ParserVisitor visitor Object data return visitor visit this data public class TexenTestCase extends BaseTestCase private static final String RESULTS_DIR private static final String COMPARE_DIR public TexenTestCase super public static junit framework Test suite return new TexenTestCase protected void setUp public void runTest try assureResultsDirectoryExists RESULTS_DIR if isMatch RESULTS_DIR COMPARE_DIR isMatch RESULTS_DIR COMPARE_DIR isMatch RESULTS_DIR COMPARE_DIR isMatch RESULTS_DIR COMPARE_DIR isMatch RESULTS_DIR COMPARE_DIR fail catch Exception public class Include extends InputBase private String outputMsgStart private String outputMsgEnd public String getName return public int getType return LINE public void init RuntimeServices rs InternalContextAdapter context Node node throws Exception super init rs context node outputMsgStart rsvc getString RuntimeConstants ERRORMSG_START outputMsgStart outputMsgStart outputMsgEnd rsvc getString RuntimeConstants ERRORMSG_END outputMsgEnd outputMsgEnd public boolean render InternalContextAdapter context Writer writer Node node throws IOException MethodInvocationException ResourceNotFoundException int argCount node jjtGetNumChildren for int argCount Node node jjtGetChild if getType ParserTreeConstants JJTSTRINGLITERAL getType ParserTreeConstants JJTREFERENCE if renderOutput context writer outputErrorToStream writer else rsvc error toString outputErrorToStream writer return true private boolean renderOutput Node node InternalContextAdapter context Writer writer throws IOException MethodInvocationException ResourceNotFoundException String arg if node null rsvc error return false Object value node value context if value null rsvc error return false arg value toString Resource resource null try resource rsvc getContent arg getInputEncoding context catch ResourceNotFoundException rnfe rsvc error arg context getCurrentTemplateName getLine getColumn throw rnfe catch Exception rsvc error arg context getCurrentTemplateName getLine getColumn if resource null return false writer write String resource getData return true private void outputErrorToStream Writer writer String msg throws IOException if outputMsgStart null outputMsgEnd null writer write outputMsgStart writer write msg writer write outputMsgEnd return public interface NullSetEventHandler extends EventHandler public boolean shouldLogOnNullSet String lhs String rhs public abstract class Resource protected RuntimeServices rsvc null protected ResourceLoader resourceLoader protected static final long MILLIS_PER_SECOND protected long modificationCheckInterval protected long lastModified protected long nextCheck protected String name protected String encoding RuntimeConstants ENCODING_DEFAULT protected Object data null public Resource public void setRuntimeServices RuntimeServices rs rsvc rs public abstract boolean process throws ResourceNotFoundException ParseErrorException Exception public boolean isSourceModified return resourceLoader isSourceModified this public void setModificationCheckInterval long modificationCheckInterval this modificationCheckInterval modificationCheckInterval public boolean requiresChecking if modificationCheckInterval return false return System currentTimeMillis nextCheck public void touch nextCheck System currentTimeMillis MILLIS_PER_SECOND modificationCheckInterval public void setName String name this name name public String getName return name public void setEncoding String encoding this encoding encoding public String getEncoding return encoding public long getLastModified return lastModified public void setLastModified long lastModified this lastModified lastModified public ResourceLoader getResourceLoader return resourceLoader public void setResourceLoader ResourceLoader resourceLoader this resourceLoader resourceLoader public void setData Object data this data data public Object getData return data public class AnakiaElement extends Element private static final XMLOutputter DEFAULT_OUTPUTTER new XMLOutputter public AnakiaElement String name Namespace namespace super name namespace public AnakiaElement String name super name public AnakiaElement String name String uri super name uri public AnakiaElement String name String prefix String uri super name prefix uri public NodeList selectNodes String xpathExpression return new NodeList XPathCache getXPath xpathExpression applyTo this false public String toString return DEFAULT_OUTPUTTER outputString this public List getContent return new NodeList super getContent false public List getChildren return new NodeList super getChildren false public List getChildren String name return new NodeList super getChildren name public List getChildren String name Namespace ns return new NodeList super getChildren name ns public List getAttributes return new NodeList super getAttributes public class ASTBlock extends SimpleNode public ASTBlock int id super id public ASTBlock Parser int id super id public Object jjtAccept ParserVisitor visitor Object data return visitor visit this data public boolean render InternalContextAdapter context Writer writer throws IOException MethodInvocationException ResourceNotFoundException ParseErrorException int jjtGetNumChildren for jjtGetChild render context writer return true public class ASTElseIfStatement extends SimpleNode public ASTElseIfStatement int id super id public ASTElseIfStatement Parser int id super id public Object jjtAccept ParserVisitor visitor Object data return visitor visit this data public boolean evaluate InternalContextAdapter context throws MethodInvocationException return jjtGetChild evaluate context public boolean render InternalContextAdapter context Writer writer throws IOException MethodInvocationException ResourceNotFoundException ParseErrorException return jjtGetChild render context writer public class NodeUtils public static String specialText Token String specialText if specialToken null specialToken image startsWith return specialText Token tmp_t specialToken while tmp_t specialToken null tmp_t tmp_t specialToken while tmp_t null String st tmp_t image StringBuffer sb new StringBuffer for int st length char st charAt if sb append if boolean ok true boolean term false int for ok true ok st length char cc st charAt if cc continue else if cc term true ok false else ok false if term String foo st substring sb append foo specialText sb toString tmp_t tmp_t next return specialText public static String tokenLiteral Token return specialText image public static String interpolate String argStr Context vars StringBuffer argBuf new StringBuffer for int cIdx cIdx argStr length char ch argStr charAt cIdx switch ch case StringBuffer nameBuf new StringBuffer for cIdx cIdx argStr length cIdx ch argStr charAt cIdx if ch ch Character isLetterOrDigit ch nameBuf append ch else if ch ch continue else break if nameBuf length Object value vars get nameBuf toString if value null argBuf append append nameBuf toString else argBuf append value toString break default argBuf append ch cIdx break return argBuf toString public class Parse extends InputBase private boolean ready false public String getName return public int getType return LINE public boolean render InternalContextAdapter context Writer writer Node node throws IOException ResourceNotFoundException ParseErrorException MethodInvocationException if node jjtGetChild null rsvc error return false Object value node jjtGetChild value context if value null rsvc error return false String arg value toString Object templateStack context getTemplateNameStack if templateStack length rsvc getInt RuntimeConstants PARSE_DIRECTIVE_MAXDEPTH StringBuffer path new StringBuffer for int templateStack length path append templateStack rsvc error templateStack length path return false Template null try rsvc getTemplate arg getInputEncoding context catch ResourceNotFoundException rnfe rsvc error arg context getCurrentTemplateName getLine getColumn throw rnfe catch ParseErrorException pee rsvc error arg context getCurrentTemplateName getLine getColumn throw pee catch Exception rsvc error arg return false try context pushCurrentTemplateName arg SimpleNode getData render context writer catch Exception if instanceof MethodInvocationException throw MethodInvocationException rsvc error arg return false finally context popCurrentTemplateName return true public class MiscTestCase extends BaseTestCase public MiscTestCase super public MiscTestCase String name super name public static Test suite return new MiscTestCase public void runTest String eol String arg String res StringUtils chop arg eol assertTrue res equals arg res StringUtils chop arg eol assertTrue res equals arg res StringUtils chop arg eol assertTrue res equals arg res StringUtils chop arg eol assertTrue res equals public class LogManager public static LogSystem createLogSystem RuntimeServices rsvc throws Exception Object rsvc getProperty RuntimeConstants RUNTIME_LOG_LOGSYSTEM if null instanceof LogSystem LogSystem init rsvc return LogSystem List classes null Object obj rsvc getProperty RuntimeConstants RUNTIME_LOG_LOGSYSTEM_CLASS if obj instanceof List classes List obj else if obj instanceof String classes new ArrayList classes add obj for Iterator ii classes iterator ii hasNext String claz String ii next if claz null claz length rsvc info claz try Class forName claz newInstance if instanceof LogSystem LogSystem init rsvc rsvc info claz return LogSystem else rsvc error claz catch NoClassDefFoundError ncdfe rsvc debug claz ncdfe LogSystem als null try als new AvalonLogSystem als init rsvc catch NoClassDefFoundError ncdfe String errstr ncdfe System out println errstr System err println errstr throw ncdfe rsvc info return als public interface ParserConstants int EOF int LBRACKET int RBRACKET int COMMA int DOUBLEDOT int LPAREN int RPAREN int REFMOD2_RPAREN int ESCAPE_DIRECTIVE int SET_DIRECTIVE int DOLLAR int DOLLARBANG int HASH int DOUBLE_ESCAPE int ESCAPE int TEXT int SINGLE_LINE_COMMENT int FORMAL_COMMENT int MULTI_LINE_COMMENT int WHITESPACE int STRING_LITERAL int TRUE int FALSE int NEWLINE int MINUS int PLUS int MULTIPLY int DIVIDE int MODULUS int LOGICAL_AND int LOGICAL_OR int LOGICAL_LT int LOGICAL_LE int LOGICAL_GT int LOGICAL_GE int LOGICAL_EQUALS int LOGICAL_NOT_EQUALS int LOGICAL_NOT int EQUALS int END int IF_DIRECTIVE int ELSEIF_DIRECTIVE int ELSE_DIRECTIVE int STOP_DIRECTIVE int DIGIT int NUMBER_LITERAL int LETTER int DIRECTIVE_CHAR int WORD int ALPHA_CHAR int ALPHANUM_CHAR int IDENTIFIER_CHAR int IDENTIFIER int DOT int LCURLY int RCURLY int REFERENCE_TERMINATOR int DIRECTIVE_TERMINATOR int DIRECTIVE int REFMOD2 int REFMODIFIER int DEFAULT int PRE_DIRECTIVE int REFERENCE int IN_MULTI_LINE_COMMENT int IN_FORMAL_COMMENT int IN_SINGLE_LINE_COMMENT String tokenImage public class FieldMethodizer private HashMap fieldHash new HashMap private HashMap classHash new HashMap public FieldMethodizer public FieldMethodizer String try addObject catch Exception System out println public FieldMethodizer Object try addObject catch Exception System out println public void addObject String throws Exception inspect Class forName public void addObject Object throws Exception inspect getClass public Object get String fieldName try Field Field fieldHash get fieldName if null return get Class classHash get fieldName catch Exception return null private void inspect Class clas Field fields clas getFields for int fields length int mod fields getModifiers if Modifier isStatic mod Modifier isPublic mod fieldHash put fields getName fields classHash put fields getName clas public interface LogSystem public final static boolean DEBUG_ON true public final static int DEBUG_ID public final static int INFO_ID public final static int WARN_ID public final static int ERROR_ID public void init RuntimeServices rs throws Exception public void logVelocityMessage int level String message public class Child extends Person public String getName return public class Person public String getName return public class TemplateNodeView private SimpleNode document private NodeViewMode visitor public TemplateNodeView String template try RuntimeSingleton init InputStreamReader isr new InputStreamReader new FileInputStream template RuntimeSingleton getString RuntimeSingleton INPUT_ENCODING BufferedReader br new BufferedReader isr document RuntimeSingleton parse br template visitor new NodeViewMode visitor setContext null visitor setWriter new PrintWriter System out document jjtAccept visitor null catch Exception System out println printStackTrace public static void main String args TemplateNodeView new TemplateNodeView args public class ASTModNode extends SimpleNode public ASTModNode int id super id public ASTModNode Parser int id super id public Object jjtAccept ParserVisitor visitor Object data return visitor visit this data public Object value InternalContextAdapter context throws MethodInvocationException Object left jjtGetChild value context Object right jjtGetChild value context if left null right null rsvc error left null jjtGetChild left null literal context getCurrentTemplateName getLine getColumn return null if left instanceof Integer right instanceof Integer rsvc error left instanceof Integer context getCurrentTemplateName getLine getColumn return null if Integer right intValue rsvc error context getCurrentTemplateName getLine getColumn return null return new Integer Integer left intValue Integer right intValue public class ASTLTNode extends SimpleNode public ASTLTNode int id super id public ASTLTNode Parser int id super id public Object jjtAccept ParserVisitor visitor Object data return visitor visit this data public boolean evaluate InternalContextAdapter context throws MethodInvocationException Object left jjtGetChild value context Object right jjtGetChild value context if left null right null rsvc error left null jjtGetChild left null literal context getCurrentTemplateName getLine getColumn return false if left instanceof Integer right instanceof Integer rsvc error left instanceof Integer left instanceof Integer left getClass right getClass context getCurrentTemplateName getLine getColumn return false return Integer left intValue Integer right intValue public Object value InternalContextAdapter context throws MethodInvocationException boolean val evaluate context return val Boolean TRUE Boolean FALSE public class PropertiesUtil public Properties load String propertiesFile Properties properties new Properties String templatePath Generator getInstance getTemplatePath if templatePath null properties loadFromTemplatePath propertiesFile else properties loadFromClassPath propertiesFile return properties protected Properties loadFromTemplatePath String propertiesFile Properties properties new Properties String templatePath Generator getInstance getTemplatePath StringTokenizer st new StringTokenizer templatePath while st hasMoreTokens String templateDir st nextToken try String fullPath propertiesFile if fullPath startsWith templateDir fullPath templateDir propertiesFile properties load new FileInputStream fullPath break catch Exception return properties protected Properties loadFromClassPath String propertiesFile Properties properties new Properties ClassLoader classLoader this getClass getClassLoader try if propertiesFile startsWith propertiesFile propertiesFile substring length InputStream inputStream classLoader getResourceAsStream propertiesFile properties load inputStream catch IOException ioe return properties public interface ParserTreeConstants public int JJTPROCESS public int JJTVOID public int JJTESCAPEDDIRECTIVE public int JJTESCAPE public int JJTCOMMENT public int JJTNUMBERLITERAL public int JJTSTRINGLITERAL public int JJTIDENTIFIER public int JJTWORD public int JJTDIRECTIVE public int JJTBLOCK public int JJTOBJECTARRAY public int JJTINTEGERRANGE public int JJTMETHOD public int JJTREFERENCE public int JJTTRUE public int JJTFALSE public int JJTTEXT public int JJTIFSTATEMENT public int JJTELSESTATEMENT public int JJTELSEIFSTATEMENT public int JJTSETDIRECTIVE public int JJTEXPRESSION public int JJTASSIGNMENT public int JJTORNODE public int JJTANDNODE public int JJTEQNODE public int JJTNENODE public int JJTLTNODE public int JJTGTNODE public int JJTLENODE public int JJTGENODE public int JJTADDNODE public int JJTSUBTRACTNODE public int JJTMULNODE public int JJTDIVNODE public int JJTMODNODE public int JJTNOTNODE public String jjtNodeName public class ASTEscapedDirective extends SimpleNode public ASTEscapedDirective int id super id public ASTEscapedDirective Parser int id super id public Object jjtAccept ParserVisitor visitor Object data return visitor visit this data public boolean render InternalContextAdapter context Writer writer throws IOException writer write getFirstToken image return true public class ASTExpression extends SimpleNode public ASTExpression int id super id public ASTExpression Parser int id super id public Object jjtAccept ParserVisitor visitor Object data return visitor visit this data public boolean evaluate InternalContextAdapter context throws MethodInvocationException return jjtGetChild evaluate context public Object value InternalContextAdapter context throws MethodInvocationException return jjtGetChild value context public class ASTDivNode extends SimpleNode public ASTDivNode int id super id public ASTDivNode Parser int id super id public Object jjtAccept ParserVisitor visitor Object data return visitor visit this data public Object value InternalContextAdapter context throws MethodInvocationException Object left jjtGetChild value context Object right jjtGetChild value context if left null right null rsvc error left null jjtGetChild left null literal context getCurrentTemplateName getLine getColumn return null if left instanceof Integer right instanceof Integer rsvc error left instanceof Integer context getCurrentTemplateName getLine getColumn return null if Integer right intValue rsvc error context getCurrentTemplateName getLine getColumn return null return new Integer Integer left intValue Integer right intValue public interface InternalEventContext public EventCartridge attachEventCartridge EventCartridge ec public EventCartridge getEventCartridge public class VelocityServletTest extends TestCase public VelocityServletTest super public static junit framework Test suite return new VelocityServletTest public void runTest MockVelocityServlet servlet new MockVelocityServlet try servlet init new MockServletConfig catch ServletException printStackTrace System out println RuntimeConstants OUTPUT_ENCODING RuntimeSingleton getProperty RuntimeConstants OUTPUT_ENCODING HttpServletResponse res new MockHttpServletResponse servlet visibleSetContentType null res assertEquals res getCharacterEncoding class MockVelocityServlet extends VelocityServlet void visibleSetContentType HttpServletRequest req HttpServletResponse res setContentType req res protected Properties loadConfiguration ServletConfig config throws IOException Properties new Properties setProperty RuntimeConstants OUTPUT_ENCODING return public ServletConfig getServletConfig return new MockServletConfig static class MockServletConfig implements ServletConfig public String getInitParameter String ignored return null public Enumeration getInitParameterNames return null public ServletContext getServletContext return new MockServletContext public String getServletName return static class MockServletContext implements ServletContext public Object getAttribute String ignored return null public Enumeration getAttributeNames return null public ServletContext getContext String ignored return this public String getInitParameter String ignored return null public Enumeration getInitParameterNames return null public int getMajorVersion return public String getMimeType String ignored return null public int getMinorVersion return public RequestDispatcher getNamedDispatcher String ignored return null public String getRealPath String ignored return null public RequestDispatcher getRequestDispatcher String ignored return null public URL getResource String ignored throws MalformedURLException return null public InputStream getResourceAsStream String ignored return null public String getServerInfo return public Servlet getServlet String ignored throws ServletException return null public Enumeration getServletNames return null public Enumeration getServlets return null public void log Exception String msg public void log String msg public void log String msg Throwable public void removeAttribute String name public void setAttribute String name Object value static class MockHttpServletResponse implements HttpServletResponse private String encoding public void flushBuffer throws IOException public int getBufferSize return public String getCharacterEncoding return encoding null encoding public java util Locale getLocale return null public javax servlet ServletOutputStream getOutputStream throws IOException return null public java io PrintWriter getWriter throws IOException return null public boolean isCommitted return false public void reset public void setBufferSize int public void setContentLength int public void setContentType String contentType if contentType null int index contentType lastIndexOf if index index contentType length index contentType indexOf index if index index this encoding contentType substring index trim public void setLocale java util Locale public void addCookie javax servlet http Cookie public void addDateHeader String long public void addHeader String name String value public void addIntHeader String name int value public boolean containsHeader String name return false public String encodeRedirectURL String url return url public String encodeRedirectUrl String url return url public String encodeURL String url return url public String encodeUrl String url return url public void sendError int throws IOException public void sendError int String throws IOException public void sendRedirect String throws IOException public void setDateHeader String long public void setHeader String name String value public void setIntHeader String int public void setStatus int public void setStatus int String public final class VelocityWriter extends Writer public static final int NO_BUFFER public static final int DEFAULT_BUFFER public static final int UNBOUNDED_BUFFER protected int bufferSize protected boolean autoFlush private Writer writer private char cb private int nextChar private static int defaultCharBufferSize private boolean flushed false public VelocityWriter Writer writer this writer defaultCharBufferSize true private VelocityWriter int bufferSize boolean autoFlush this bufferSize bufferSize this autoFlush autoFlush public int getBufferSize return bufferSize public boolean isAutoFlush return autoFlush public VelocityWriter Writer writer int sz boolean autoFlush this sz autoFlush if sz throw new IllegalArgumentException this writer writer cb sz null new char sz nextChar private final void init Writer writer int sz boolean autoFlush this writer writer if sz cb null sz cb length cb new char sz nextChar this autoFlush autoFlush this bufferSize sz private final void flushBuffer throws IOException if bufferSize return flushed true if nextChar return writer write cb nextChar nextChar public final void clear nextChar private final void bufferOverflow throws IOException throw new IOException public final void flush throws IOException flushBuffer if writer null writer flush public final void close throws IOException if writer null return flush public final int getRemaining return bufferSize nextChar public final void write int throws IOException if bufferSize writer write else if nextChar bufferSize if autoFlush flushBuffer else bufferOverflow cb nextChar char private final int min int int return public final void write char cbuf int off int len throws IOException if bufferSize writer write cbuf off len return if len return if len bufferSize if autoFlush flushBuffer else bufferOverflow writer write cbuf off len return int off off len while int min bufferSize nextChar System arraycopy cbuf cb nextChar nextChar if nextChar bufferSize if autoFlush flushBuffer else bufferOverflow public final void write char buf throws IOException write buf buf length public final void write String int off int len throws IOException if bufferSize writer write off len return int off off len while int min bufferSize nextChar getChars cb nextChar nextChar if nextChar bufferSize if autoFlush flushBuffer else bufferOverflow public final void write String throws IOException write length public final void recycle Writer writer this writer writer flushed false clear public class ResourceLoaderFactory public static ResourceLoader getLoader RuntimeServices rs String loaderClassName throws Exception ResourceLoader loader null try loader ResourceLoader Class forName loaderClassName newInstance rs info loader getClass getName return loader catch Exception rs error StringUtils stackTrace throw new Exception loaderClassName StringUtils stackTrace public class ASTprocess extends SimpleNode public ASTprocess int id super id public ASTprocess Parser int id super id public Object jjtAccept ParserVisitor visitor Object data return visitor visit this data public interface ReferenceInsertionEventHandler extends EventHandler public Object referenceInsert String reference Object value public class NodeViewMode extends BaseVisitor private int indent private boolean showTokens true private String indentString StringBuffer sb new StringBuffer for int indent sb append return sb toString private Object showNode Node node Object data String tokens String special Token if showTokens node getFirstToken if specialToken null specialToken image startsWith special specialToken image tokens special image System out println indentString node tokens indent data node childrenAccept this data indent return data public Object visit SimpleNode node Object data return showNode node data public Object visit ASTprocess node Object data return showNode node data public Object visit ASTExpression node Object data return showNode node data public Object visit ASTAssignment node Object data return showNode node data public Object visit ASTOrNode node Object data return showNode node data public Object visit ASTAndNode node Object data return showNode node data public Object visit ASTEQNode node Object data return showNode node data public Object visit ASTNENode node Object data return showNode node data public Object visit ASTLTNode node Object data return showNode node data public Object visit ASTGTNode node Object data return showNode node data public Object visit ASTLENode node Object data return showNode node data public Object visit ASTGENode node Object data return showNode node data public Object visit ASTAddNode node Object data return showNode node data public Object visit ASTSubtractNode node Object data return showNode node data public Object visit ASTMulNode node Object data return showNode node data public Object visit ASTDivNode node Object data return showNode node data public Object visit ASTModNode node Object data return showNode node data public Object visit ASTNotNode node Object data return showNode node data public Object visit ASTNumberLiteral node Object data return showNode node data public Object visit ASTStringLiteral node Object data return showNode node data public Object visit ASTIdentifier node Object data return showNode node data public Object visit ASTMethod node Object data return showNode node data public Object visit ASTReference node Object data return showNode node data public Object visit ASTTrue node Object data return showNode node data public Object visit ASTFalse node Object data return showNode node data public Object visit ASTBlock node Object data return showNode node data public Object visit ASTText node Object data return showNode node data public Object visit ASTIfStatement node Object data return showNode node data public Object visit ASTElseStatement node Object data return showNode node data public Object visit ASTElseIfStatement node Object data return showNode node data public Object visit ASTObjectArray node Object data return showNode node data public Object visit ASTDirective node Object data return showNode node data public Object visit ASTWord node Object data return showNode node data public Object visit ASTSetDirective node Object data return showNode node data public class ASTMulNode extends SimpleNode public ASTMulNode int id super id public ASTMulNode Parser int id super id public Object jjtAccept ParserVisitor visitor Object data return visitor visit this data public Object value InternalContextAdapter context throws MethodInvocationException Object left jjtGetChild value context Object right jjtGetChild value context if left null right null rsvc error left null jjtGetChild left null literal context getCurrentTemplateName getLine getColumn return null if left instanceof Integer right instanceof Integer rsvc error left instanceof Integer context getCurrentTemplateName getLine getColumn return null return new Integer Integer left intValue Integer right intValue public class AnakiaJDOMFactory extends DefaultJDOMFactory public AnakiaJDOMFactory public Element element String name Namespace namespace return new AnakiaElement name namespace public Element element String name return new AnakiaElement name public Element element String name String uri return new AnakiaElement name uri public Element element String name String prefix String uri return new AnakiaElement name prefix uri public final class SimplePool private Object pool private int max private int current public SimplePool int max this max max pool new Object max public void put Object int idx synchronized this if current max idx current if idx pool idx public Object get int idx synchronized this if current idx current current return pool idx return null public int getMax return max public class TreeWalker public TreeWalker public NodeList allElements Element ArrayList theElements new ArrayList treeWalk theElements return new NodeList theElements false private final void treeWalk Element Collection theElements for Iterator getChildren iterator hasNext Element child Element next theElements add child treeWalk child theElements public class ASTWord extends SimpleNode public ASTWord int id super id public ASTWord Parser int id super id public Object jjtAccept ParserVisitor visitor Object data return visitor visit this data public class Configuration extends Hashtable private ExtendedProperties deprecationCrutch new ExtendedProperties private Configuration defaults protected String file protected String basePath protected String fileSeparator System getProperty protected boolean isInitialized false protected static String include protected ArrayList keysAsListed new ArrayList class PropertiesReader extends LineNumberReader public PropertiesReader Reader reader super reader public String readProperty throws IOException StringBuffer buffer new StringBuffer try while true String line readLine trim if line length line charAt if line endsWith line line substring line length buffer append line else buffer append line break catch NullPointerException return null return buffer toString class PropertiesTokenizer extends StringTokenizer static final String DELIMITER public PropertiesTokenizer String string super string DELIMITER public boolean hasMoreTokens return super hasMoreTokens public String nextToken StringBuffer buffer new StringBuffer while hasMoreTokens String token super nextToken if token endsWith buffer append token substring token length buffer append DELIMITER else buffer append token break return buffer toString trim public Configuration super public Configuration String file throws IOException this file null public Configuration String file String defaultFile throws IOException this file file basePath new File file getAbsolutePath basePath basePath substring basePath lastIndexOf fileSeparator this load new FileInputStream file if defaultFile null defaults new Configuration defaultFile private void init Configuration exp throws IOException isInitialized true public boolean isInitialized return isInitialized public String getInclude return Configuration include public void setInclude String inc Configuration include inc public synchronized void load InputStream input throws IOException PropertiesReader reader new PropertiesReader new InputStreamReader input try while true String line reader readProperty int equalSign line indexOf if equalSign String key line substring equalSign trim String value line substring equalSign trim if equals value continue if getInclude null key equalsIgnoreCase getInclude File file null if value startsWith fileSeparator file new File value else if value startsWith fileSeparator value value substring file new File basePath value if file null file exists file canRead load new FileInputStream file else addProperty key value catch NullPointerException return public Object getProperty String key Object this get key if null if defaults null defaults get key return public void addProperty String key Object token deprecationCrutch addProperty key token Object this get key if instanceof String Vector new Vector addElement addElement token put key else if instanceof Vector Vector addElement token else if token instanceof String String token indexOf PropertiesTokenizer DELIMITER PropertiesTokenizer tokenizer new PropertiesTokenizer String token while tokenizer hasMoreTokens String value tokenizer nextToken addStringProperty key value else if containsKey key keysAsListed add key put key token private void addStringProperty String key String token Object this get key if instanceof String Vector new Vector addElement addElement token put key else if instanceof Vector Vector addElement token else if containsKey key keysAsListed add key put key token public void setProperty String key Object value clearProperty key addProperty key value public synchronized void save OutputStream output String Header throws IOException if output null PrintWriter theWrtr new PrintWriter output if Header null theWrtr println Header Enumeration theKeys keys while theKeys hasMoreElements String key String theKeys nextElement Object value get Object key if value null if value instanceof String StringBuffer currentOutput new StringBuffer currentOutput append key currentOutput append currentOutput append String value theWrtr println currentOutput toString else if value instanceof Vector Vector values Vector value Enumeration valuesEnum values elements while valuesEnum hasMoreElements String currentElement String valuesEnum nextElement StringBuffer currentOutput new StringBuffer currentOutput append key currentOutput append currentOutput append currentElement theWrtr println currentOutput toString theWrtr println theWrtr flush public void combine Configuration for Iterator getKeys hasNext String key String next setProperty key get key public void clearProperty String key deprecationCrutch clearProperty key if containsKey key for int keysAsListed size if String keysAsListed get equals key keysAsListed remove break remove key public Iterator getKeys return keysAsListed iterator public Iterator getKeys String prefix Iterator keys getKeys ArrayList matchingKeys new ArrayList while keys hasNext Object key keys next if key instanceof String String key startsWith prefix matchingKeys add key return matchingKeys iterator public Configuration subset String prefix Configuration new Configuration Iterator keys getKeys boolean validSubset false while keys hasNext Object key keys next if key instanceof String String key startsWith prefix if validSubset validSubset true String newKey null if String key length prefix length newKey prefix else newKey String key substring prefix length setProperty newKey get key if validSubset return else return null public void display Iterator getKeys while hasNext String key String next Object value get key System out println key value public String getString String key return getString key null public String getString String key String defaultValue Object value get key if value instanceof String return String value else if value null if defaults null return defaults getString key defaultValue else return defaultValue else if value instanceof Vector return String Vector value get else throw new ClassCastException key public Properties getProperties String key return getProperties key new Properties public Properties getProperties String key Properties defaults String tokens getStringArray key Properties props new Properties defaults for int tokens length String token tokens int equalSign token indexOf if equalSign String pkey token substring equalSign trim String pvalue token substring equalSign trim props put pkey pvalue else throw new IllegalArgumentException token return props public String getStringArray String key Object value get key Vector vector if value instanceof String vector new Vector vector addElement value else if value instanceof Vector vector Vector value else if value null if defaults null return defaults getStringArray key else return new String else throw new ClassCastException key String tokens new String vector size for int tokens length tokens String vector elementAt return tokens public Vector getVector String key return getVector key null public Vector getVector String key Vector defaultValue Object value get key if value instanceof Vector return Vector value else if value instanceof String Vector new Vector addElement String value put key return else if value null if defaults null return defaults getVector key defaultValue else return defaultValue null new Vector defaultValue else throw new ClassCastException key public boolean getBoolean String key Boolean getBoolean key Boolean null if null return booleanValue else throw new NoSuchElementException key public boolean getBoolean String key boolean defaultValue return getBoolean key new Boolean defaultValue booleanValue public Boolean getBoolean String key Boolean defaultValue Object value get key if value instanceof Boolean return Boolean value else if value instanceof String String testBoolean String value Boolean new Boolean put key return else if value null if defaults null return defaults getBoolean key defaultValue else return defaultValue else throw new ClassCastException key public String testBoolean String value String String value toLowerCase if equals equals equals return else if equals equals equals return else return null public byte getByte String key Byte getByte key null if null return byteValue else throw new NoSuchElementException key public byte getByte String key byte defaultValue return getByte key new Byte defaultValue byteValue public Byte getByte String key Byte defaultValue Object value get key if value instanceof Byte return Byte value else if value instanceof String Byte new Byte String value put key return else if value null if defaults null return defaults getByte key defaultValue else return defaultValue else throw new ClassCastException key public short getShort String key Short getShort key null if null return shortValue else throw new NoSuchElementException key public short getShort String key short defaultValue return getShort key new Short defaultValue shortValue public Short getShort String key Short defaultValue Object value get key if value instanceof Short return Short value else if value instanceof String Short new Short String value put key return else if value null if defaults null return defaults getShort key defaultValue else return defaultValue else throw new ClassCastException key public int getInt String name return getInteger name public int getInt String name int def return getInteger name def public int getInteger String key Integer getInteger key null if null return intValue else throw new NoSuchElementException key public int getInteger String key int defaultValue Integer getInteger key null if null return defaultValue return intValue public Integer getInteger String key Integer defaultValue Object value get key if value instanceof Integer return Integer value else if value instanceof String Integer new Integer String value put key return else if value null if defaults null return defaults getInteger key defaultValue else return defaultValue else throw new ClassCastException key public long getLong String key Long getLong key null if null return longValue else throw new NoSuchElementException key public long getLong String key long defaultValue return getLong key new Long defaultValue longValue public Long getLong String key Long defaultValue Object value get key if value instanceof Long return Long value else if value instanceof String Long new Long String value put key return else if value null if defaults null return defaults getLong key defaultValue else return defaultValue else throw new ClassCastException key public float getFloat String key Float getFloat key null if null return floatValue else throw new NoSuchElementException key public float getFloat String key float defaultValue return getFloat key new Float defaultValue floatValue public Float getFloat String key Float defaultValue Object value get key if value instanceof Float return Float value else if value instanceof String Float new Float String value put key return else if value null if defaults null return defaults getFloat key defaultValue else return defaultValue else throw new ClassCastException key public double getDouble String key Double getDouble key null if null return doubleValue else throw new NoSuchElementException key public double getDouble String key double defaultValue return getDouble key new Double defaultValue doubleValue public Double getDouble String key Double defaultValue Object value get key if value instanceof Double return Double value else if value instanceof String Double new Double String value put key return else if value null if defaults null return defaults getDouble key defaultValue else return defaultValue else throw new ClassCastException key public static Configuration convertProperties Properties Configuration new Configuration for Enumeration keys hasMoreElements String String nextElement setProperty getProperty return public ExtendedProperties getExtendedProperties return deprecationCrutch public class ReferenceException extends Exception public ReferenceException String exceptionMessage Node node super exceptionMessage node getLine node getColumn node literal public class ASTDirective extends SimpleNode private Directive directive private String directiveName private boolean isDirective public ASTDirective int id super id public ASTDirective Parser int id super id public Object jjtAccept ParserVisitor visitor Object data return visitor visit this data public Object init InternalContextAdapter context Object data throws Exception super init context data if parser isDirective directiveName isDirective true directive Directive parser getDirective directiveName getClass newInstance directive init rsvc context this directive setLocation getLine getColumn else if rsvc isVelocimacro directiveName context getCurrentTemplateName isDirective true directive Directive rsvc getVelocimacro directiveName context getCurrentTemplateName directive init rsvc context this directive setLocation getLine getColumn else isDirective false return data public boolean render InternalContextAdapter context Writer writer throws IOException MethodInvocationException ResourceNotFoundException ParseErrorException if isDirective directive render context writer this else writer write writer write directiveName return true public void setDirectiveName String str directiveName str return public String getDirectiveName return directiveName public class Compiler implements InstructionConstants public static void main String args String template args substring args indexOf ClassGen cg new ClassGen template Constants ACC_PUBLIC Constants ACC_SUPER null InstructionList il new InstructionList MethodGen mg new MethodGen Constants ACC_STATIC new ArrayType Type STRING il cp int br_index cp addClass int ir_index cp addClass il append new NEW br_index il append DUP il append new NEW ir_index il append DUP il append new GETSTATIC system_in il append new INVOKESPECIAL cp addMethodref il append new INVOKESPECIAL cp addMethodref LocalVariableGen lg mg addLocalVariable new ObjectType null null int in lg getIndex lg mg addLocalVariable Type STRING null null int name lg getIndex il append ACONST_NULL InstructionHandle try_start il append new GETSTATIC system_out il append new PUSH cp il append new INVOKEVIRTUAL cp addMethodref GOTO new GOTO null InstructionHandle try_end il append InstructionHandle handler il append RETURN mg addExceptionHandler try_start try_end handler new ObjectType InstructionHandle ih il append new GETSTATIC system_out setTarget ih il append new NEW cp addClass il append DUP il append new PUSH cp il append new INVOKESPECIAL cp addMethodref il append new ALOAD name String sig Type getMethodSignature Type STRINGBUFFER new Type Type STRING il append new INVOKEVIRTUAL cp addMethodref sig il append new INVOKEVIRTUAL cp addMethodref il append RETURN cg addMethod mg getMethod cg addEmptyConstructor Constants ACC_PUBLIC try cg getJavaClass dump template catch java io IOException System err println public abstract class AbstractContext extends InternalContextBase implements Context Serializable private Context innerContext null public abstract Object internalGet String key public abstract Object internalPut String key Object value public abstract boolean internalContainsKey Object key public abstract Object internalGetKeys public abstract Object internalRemove Object key public AbstractContext public AbstractContext Context inner innerContext inner if innerContext instanceof InternalEventContext attachEventCartridge InternalEventContext innerContext getEventCartridge public Object put String key Object value if key null return null else if value null return null return internalPut key value public Object get String key if key null return null Object internalGet key if null innerContext null innerContext get key return public boolean containsKey Object key if key null return false return internalContainsKey key public Object getKeys return internalGetKeys public Object remove Object key if key null return null return internalRemove key public Context getChainedContext return innerContext public class TokenMgrError extends Error static final int LEXICAL_ERROR static final int STATIC_LEXER_ERROR static final int INVALID_LEXICAL_STATE static final int LOOP_DETECTED int errorCode protected static final String addEscapes String str StringBuffer retval new StringBuffer char ch for int str length switch str charAt case continue case retval append continue case retval append continue case retval append continue case retval append continue case retval append continue case retval append continue case retval append continue case retval append continue default if ch str charAt ch String Integer toString ch retval append substring length length else retval append ch continue return retval toString private static final String LexicalError boolean EOFSeen int lexState int errorLine int errorColumn String errorAfter char curChar return errorLine errorColumn EOFSeen addEscapes String valueOf curChar int curChar addEscapes errorAfter public String getMessage return super getMessage public TokenMgrError public TokenMgrError String message int reason super message errorCode reason public TokenMgrError boolean EOFSeen int lexState int errorLine int errorColumn String errorAfter char curChar int reason this LexicalError EOFSeen lexState errorLine errorColumn errorAfter curChar reason public class NodeList implements List Cloneable private static final AttributeXMLOutputter DEFAULT_OUTPUTTER new AttributeXMLOutputter private List nodes public NodeList nodes new ArrayList public NodeList Document document this Object document public NodeList Element element this Object element private NodeList Object object if object null throw new IllegalArgumentException nodes new ArrayList nodes add object public NodeList List nodes this nodes true public NodeList List nodes boolean copy if nodes null throw new IllegalArgumentException this nodes copy new ArrayList nodes nodes public List getList return nodes public String toString if nodes isEmpty return StringWriter sw new StringWriter nodes size try for Iterator nodes iterator hasNext Object node next if node instanceof Element DEFAULT_OUTPUTTER output Element node sw else if node instanceof Attribute DEFAULT_OUTPUTTER output Attribute node sw else if node instanceof Text DEFAULT_OUTPUTTER output Text node sw else if node instanceof Document DEFAULT_OUTPUTTER output Document node sw else if node instanceof ProcessingInstruction DEFAULT_OUTPUTTER output ProcessingInstruction node sw else if node instanceof Comment DEFAULT_OUTPUTTER output Comment node sw else if node instanceof CDATA DEFAULT_OUTPUTTER output CDATA node sw else if node instanceof DocType DEFAULT_OUTPUTTER output DocType node sw else if node instanceof EntityRef DEFAULT_OUTPUTTER output EntityRef node sw else throw new IllegalArgumentException node null node getClass getName catch IOException throw new Error return sw toString public Object clone throws CloneNotSupportedException NodeList clonedList NodeList super clone clonedList cloneNodes return clonedList private void cloneNodes throws CloneNotSupportedException Class listClass nodes getClass try List clonedNodes List listClass newInstance clonedNodes addAll nodes nodes clonedNodes catch IllegalAccessException throw new CloneNotSupportedException listClass getName catch InstantiationException throw new Error public int hashCode return nodes hashCode public boolean equals Object return instanceof NodeList NodeList nodes equals nodes false public NodeList selectNodes String xpathString return new NodeList XPathCache getXPath xpathString applyTo nodes false public boolean add Object return nodes add public void add int index Object nodes add index public boolean addAll Collection return nodes addAll public boolean addAll int index Collection return nodes addAll index public void clear nodes clear public boolean contains Object return nodes contains public boolean containsAll Collection return nodes containsAll public Object get int index return nodes get index public int indexOf Object return nodes indexOf public boolean isEmpty return nodes isEmpty public Iterator iterator return nodes iterator public int lastIndexOf Object return nodes lastIndexOf public ListIterator listIterator return nodes listIterator public ListIterator listIterator int index return nodes listIterator index public Object remove int index return nodes remove index public boolean remove Object return nodes remove public boolean removeAll Collection return nodes removeAll public boolean retainAll Collection return nodes retainAll public Object set int index Object return nodes set index public int size return nodes size public List subList int fromIndex int toIndex return new NodeList nodes subList fromIndex toIndex public Object toArray return nodes toArray public Object toArray Object return nodes toArray private static final class AttributeXMLOutputter extends XMLOutputter public void output Attribute attribute Writer out throws IOException out write out write attribute getQualifiedName out write out write out write escapeAttributeEntities attribute getValue out write public class ASTGENode extends SimpleNode public ASTGENode int id super id public ASTGENode Parser int id super id public Object jjtAccept ParserVisitor visitor Object data return visitor visit this data public boolean evaluate InternalContextAdapter context throws MethodInvocationException Object left jjtGetChild value context Object right jjtGetChild value context if left null right null rsvc error left null jjtGetChild left null literal context getCurrentTemplateName getLine getColumn return false if left instanceof Integer right instanceof Integer rsvc error left instanceof Integer left instanceof Integer left getClass right getClass context getCurrentTemplateName getLine getColumn return false return Integer left intValue Integer right intValue public Object value InternalContextAdapter context throws MethodInvocationException boolean val evaluate context return val Boolean TRUE Boolean FALSE public class Runtime implements RuntimeConstants public synchronized static void init throws Exception RuntimeSingleton init public static void setProperty String key Object value RuntimeSingleton setProperty key value public static void setConfiguration ExtendedProperties configuration RuntimeSingleton setConfiguration configuration public static void addProperty String key Object value RuntimeSingleton addProperty key value public static void clearProperty String key RuntimeSingleton clearProperty key public static Object getProperty String key return RuntimeSingleton getProperty key public static void init Properties throws Exception RuntimeSingleton init public static void init String configurationFile throws Exception RuntimeSingleton init configurationFile public static SimpleNode parse Reader reader String templateName throws ParseException return RuntimeSingleton parse reader templateName public static SimpleNode parse Reader reader String templateName boolean dumpNamespace throws ParseException return RuntimeSingleton parse reader templateName dumpNamespace public static Template getTemplate String name throws ResourceNotFoundException ParseErrorException Exception return RuntimeSingleton getTemplate name public static Template getTemplate String name String encoding throws ResourceNotFoundException ParseErrorException Exception return RuntimeSingleton getTemplate name encoding public static ContentResource getContent String name throws ResourceNotFoundException ParseErrorException Exception return RuntimeSingleton getContent name public static ContentResource getContent String name String encoding throws ResourceNotFoundException ParseErrorException Exception return RuntimeSingleton getContent name encoding public static String getLoaderNameForResource String resourceName return RuntimeSingleton getLoaderNameForResource resourceName public static void warn Object message RuntimeSingleton warn message public static void info Object message RuntimeSingleton info message public static void error Object message RuntimeSingleton error message public static void debug Object message RuntimeSingleton debug message public static String getString String key String defaultValue return RuntimeSingleton getString key defaultValue public static Directive getVelocimacro String vmName String templateName return RuntimeSingleton getVelocimacro vmName templateName public static boolean addVelocimacro String name String macro String argArray String sourceTemplate return RuntimeSingleton addVelocimacro name macro argArray sourceTemplate public static boolean isVelocimacro String vmName String templateName return RuntimeSingleton isVelocimacro vmName templateName public static boolean dumpVMNamespace String namespace return RuntimeSingleton dumpVMNamespace namespace public static String getString String key return RuntimeSingleton getString key public static int getInt String key return RuntimeSingleton getInt key public static int getInt String key int defaultValue return RuntimeSingleton getInt key defaultValue public static boolean getBoolean String key boolean def return RuntimeSingleton getBoolean key def public static ExtendedProperties getConfiguration return RuntimeSingleton getConfiguration public class Token public int kind public int beginLine beginColumn endLine endColumn public String image public Token next public Token specialToken public final String toString return image public static final Token newToken int ofKind switch ofKind default return new Token public interface EventHandler class JJTParserState private java util Stack nodes private java util Stack marks private boolean node_created JJTParserState nodes new java util Stack marks new java util Stack sp mk boolean nodeCreated return node_created void reset nodes removeAllElements marks removeAllElements sp mk Node rootNode return Node nodes elementAt void pushNode Node nodes push sp Node popNode if sp mk mk Integer marks pop intValue return Node nodes pop Node peekNode return Node nodes peek int nodeArity return sp mk void clearNodeScope Node while sp mk popNode mk Integer marks pop intValue void openNodeScope Node marks push new Integer mk mk sp jjtOpen void closeNodeScope Node int num mk Integer marks pop intValue while num Node popNode jjtSetParent jjtAddChild num jjtClose pushNode node_created true void closeNodeScope Node boolean condition if condition int nodeArity mk Integer marks pop intValue while Node popNode jjtSetParent jjtAddChild jjtClose pushNode node_created true else mk Integer marks pop intValue node_created false public final class VelocityCharStream implements CharStream public static final boolean staticFlag false int bufsize int available int tokenBegin public int bufpos private int bufline private int bufcolumn private int column private int line private boolean prevCharIsCR false private boolean prevCharIsLF false private java io Reader inputStream private char buffer private int maxNextCharInd private int inBuf private final void ExpandBuff boolean wrapAround char newbuffer new char bufsize int newbufline new int bufsize int newbufcolumn new int bufsize try if wrapAround System arraycopy buffer tokenBegin newbuffer bufsize tokenBegin System arraycopy buffer newbuffer bufsize tokenBegin bufpos buffer newbuffer System arraycopy bufline tokenBegin newbufline bufsize tokenBegin System arraycopy bufline newbufline bufsize tokenBegin bufpos bufline newbufline System arraycopy bufcolumn tokenBegin newbufcolumn bufsize tokenBegin System arraycopy bufcolumn newbufcolumn bufsize tokenBegin bufpos bufcolumn newbufcolumn maxNextCharInd bufpos bufsize tokenBegin else System arraycopy buffer tokenBegin newbuffer bufsize tokenBegin buffer newbuffer System arraycopy bufline tokenBegin newbufline bufsize tokenBegin bufline newbufline System arraycopy bufcolumn tokenBegin newbufcolumn bufsize tokenBegin bufcolumn newbufcolumn maxNextCharInd bufpos tokenBegin catch Throwable throw new Error getMessage bufsize available bufsize tokenBegin private final void FillBuff throws java io IOException if maxNextCharInd available if available bufsize if tokenBegin bufpos maxNextCharInd available tokenBegin else if tokenBegin bufpos maxNextCharInd else ExpandBuff false else if available tokenBegin available bufsize else if tokenBegin available ExpandBuff true else available tokenBegin int try if inputStream read buffer maxNextCharInd available maxNextCharInd inputStream close throw new java io IOException else maxNextCharInd return catch java io IOException bufpos backup if tokenBegin tokenBegin bufpos throw public final char BeginToken throws java io IOException tokenBegin char readChar tokenBegin bufpos return private final void UpdateLineColumn char column if prevCharIsLF prevCharIsLF false line column else if prevCharIsCR prevCharIsCR false if prevCharIsLF true else line column switch case prevCharIsCR true break case prevCharIsLF true break case column column column break default break bufline bufpos line bufcolumn bufpos column public final char readChar throws java io IOException if inBuf inBuf return buffer bufpos bufsize bufpos bufpos if bufpos maxNextCharInd FillBuff char buffer bufpos UpdateLineColumn return public final int getColumn return bufcolumn bufpos public final int getLine return bufline bufpos public final int getEndColumn return bufcolumn bufpos public final int getEndLine return bufline bufpos public final int getBeginColumn return bufcolumn tokenBegin public final int getBeginLine return bufline tokenBegin public final void backup int amount inBuf amount if bufpos amount bufpos bufsize public VelocityCharStream java io Reader dstream int startline int startcolumn int buffersize inputStream dstream line startline column startcolumn available bufsize buffersize buffer new char buffersize bufline new int buffersize bufcolumn new int buffersize public VelocityCharStream java io Reader dstream int startline int startcolumn this dstream startline startcolumn public void ReInit java io Reader dstream int startline int startcolumn int buffersize inputStream dstream line startline column startcolumn if buffer null buffersize buffer length available bufsize buffersize buffer new char buffersize bufline new int buffersize bufcolumn new int buffersize prevCharIsLF prevCharIsCR false tokenBegin inBuf maxNextCharInd bufpos public void ReInit java io Reader dstream int startline int startcolumn ReInit dstream startline startcolumn public VelocityCharStream java io InputStream dstream int startline int startcolumn int buffersize this new java io InputStreamReader dstream startline startcolumn public VelocityCharStream java io InputStream dstream int startline int startcolumn this dstream startline startcolumn public void ReInit java io InputStream dstream int startline int startcolumn int buffersize ReInit new java io InputStreamReader dstream startline startcolumn public void ReInit java io InputStream dstream int startline int startcolumn ReInit dstream startline startcolumn public final String GetImage if bufpos tokenBegin return new String buffer tokenBegin bufpos tokenBegin else return new String buffer tokenBegin bufsize tokenBegin new String buffer bufpos public final char GetSuffix int len char ret new char len if bufpos len System arraycopy buffer bufpos len ret len else System arraycopy buffer bufsize len bufpos ret len bufpos System arraycopy buffer ret len bufpos bufpos return ret public void Done buffer null bufline null bufcolumn null public void adjustBeginLineColumn int newLine int newCol int start tokenBegin int len if bufpos tokenBegin len bufpos tokenBegin inBuf else len bufsize tokenBegin bufpos inBuf int int nextColDiff columnDiff while len bufline start bufsize bufline start bufsize bufline newLine nextColDiff columnDiff bufcolumn bufcolumn bufcolumn newCol columnDiff columnDiff nextColDiff if len bufline newLine bufcolumn newCol columnDiff while len if bufline start bufsize bufline start bufsize bufline newLine else bufline newLine line bufline column bufcolumn public class TemplateTestSuite extends TestSuite implements TemplateTestBase private Properties testProperties public TemplateTestSuite try Velocity setProperty Velocity FILE_RESOURCE_LOADER_PATH FILE_RESOURCE_LOADER_PATH Velocity setProperty Velocity RUNTIME_LOG_ERROR_STACKTRACE Velocity setProperty Velocity RUNTIME_LOG_WARN_STACKTRACE Velocity setProperty Velocity RUNTIME_LOG_INFO_STACKTRACE Velocity init testProperties new Properties testProperties load new FileInputStream TEST_CASE_PROPERTIES catch Exception System err println printStackTrace System exit addTemplateTestCases private void addTemplateTestCases String template for int template testProperties getProperty getTemplateTestKey if template null System out println template addTest new TemplateTestCase template else break private static final String getTemplateTestKey int nbr return nbr public class ASTVariable extends SimpleNode public ASTVariable int id super id public ASTVariable Parser int id super id public Object jjtAccept ParserVisitor visitor Object data return visitor visit this data public class ResourceCacheImpl implements ResourceCache protected Map cache new Hashtable protected RuntimeServices rsvc null public void initialize RuntimeServices rs rsvc rs rsvc info this getClass public Resource get Object key return Resource cache get key public Resource put Object key Resource value return Resource cache put key value public Resource remove Object key return Resource cache remove key public Iterator enumerateKeys return cache keySet iterator public class ContextSafetyTestCase extends BaseTestCase implements TemplateTestBase public ContextSafetyTestCase super try Velocity setProperty Velocity FILE_RESOURCE_LOADER_PATH FILE_RESOURCE_LOADER_PATH Velocity init catch Exception System err println printStackTrace System exit public static junit framework Test suite return new ContextSafetyTestCase public void runTest Vector new Vector addElement new String addElement new String addElement new String String strArray new String strArray strArray strArray VelocityContext context new VelocityContext try assureResultsDirectoryExists RESULT_DIR Template template RuntimeSingleton getTemplate getFileName null TMPL_FILE_EXT FileOutputStream fos1 new FileOutputStream getFileName RESULT_DIR RESULT_FILE_EXT FileOutputStream fos2 new FileOutputStream getFileName RESULT_DIR RESULT_FILE_EXT Writer writer1 new BufferedWriter new OutputStreamWriter fos1 Writer writer2 new BufferedWriter new OutputStreamWriter fos2 context put template merge context writer1 writer1 flush writer1 close context put strArray template merge context writer2 writer2 flush writer2 close if isMatch RESULT_DIR COMPARE_DIR RESULT_FILE_EXT CMP_FILE_EXT isMatch RESULT_DIR COMPARE_DIR RESULT_FILE_EXT CMP_FILE_EXT fail catch Exception fail getMessage public interface RuntimeServices extends RuntimeLogger public void init throws Exception public void setProperty String key Object value public void setConfiguration ExtendedProperties configuration public void addProperty String key Object value public void clearProperty String key public Object getProperty String key public void init Properties throws Exception public void init String configurationFile throws Exception public SimpleNode parse Reader reader String templateName throws ParseException public SimpleNode parse Reader reader String templateName boolean dumpNamespace throws ParseException public Template getTemplate String name throws ResourceNotFoundException ParseErrorException Exception public Template getTemplate String name String encoding throws ResourceNotFoundException ParseErrorException Exception public ContentResource getContent String name throws ResourceNotFoundException ParseErrorException Exception public ContentResource getContent String name String encoding throws ResourceNotFoundException ParseErrorException Exception public String getLoaderNameForResource String resourceName public String getString String key String defaultValue public Directive getVelocimacro String vmName String templateName public boolean addVelocimacro String name String macro String argArray String sourceTemplate public boolean isVelocimacro String vmName String templateName public boolean dumpVMNamespace String namespace public String getString String key public int getInt String key public int getInt String key int defaultValue public boolean getBoolean String key boolean def public ExtendedProperties getConfiguration public Object getApplicationAttribute Object key public Uberspect getUberspect public Introspector getIntrospector public abstract class Directive implements DirectiveConstants Cloneable private int line private int column protected RuntimeServices rsvc null public abstract String getName public abstract int getType public void setLocation int line int column this line line this column column public int getLine return line public int getColumn return column public void init RuntimeServices rs InternalContextAdapter context Node node throws Exception rsvc rs public abstract boolean render InternalContextAdapter context Writer writer Node node throws IOException ResourceNotFoundException ParseErrorException MethodInvocationException public class NullLogSystem implements LogSystem public NullLogSystem public void init RuntimeServices rs throws Exception public void logVelocityMessage int level String message public class Literal extends Directive String literalText public String getName return public int getType return BLOCK public void init RuntimeServices rs InternalContextAdapter context Node node throws Exception super init rs context node literalText node jjtGetChild literal public boolean render InternalContextAdapter context Writer writer Node node throws IOException writer write literalText return true public class AnakiaTask extends MatchingTask private SAXBuilder builder private File destDir null private File baseDir null private String style null private File styleFile null private long styleSheetLastModified private String projectAttribute null private File projectFile null private long projectFileLastModified private boolean lastModifiedCheck true private String extension private String templatePath null private File velocityPropertiesFile null private VelocityEngine ve new VelocityEngine public AnakiaTask builder new SAXBuilder builder setFactory new AnakiaJDOMFactory public void setBasedir File dir baseDir dir public void setDestdir File dir destDir dir public void setExtension String extension this extension extension public void setStyle String style this style style public void setProjectFile String projectAttribute this projectAttribute projectAttribute public void setTemplatePath File templatePath try this templatePath templatePath getCanonicalPath catch java io IOException ioe throw new BuildException ioe public void setVelocityPropertiesFile File velocityPropertiesFile this velocityPropertiesFile velocityPropertiesFile public void setLastModifiedCheck String lastmod if lastmod equalsIgnoreCase lastmod equalsIgnoreCase lastmod equalsIgnoreCase this lastModifiedCheck false public void execute throws BuildException DirectoryScanner scanner String list String dirs if baseDir null baseDir project resolveFile if destDir null String msg throw new BuildException msg if style null throw new BuildException if velocityPropertiesFile null velocityPropertiesFile new File if velocityPropertiesFile exists templatePath null throw new BuildException velocityPropertiesFile getAbsolutePath log destDir getAbsolutePath Project MSG_INFO if projectAttribute null projectAttribute length projectFile new File baseDir projectAttribute if projectFile exists projectFileLastModified projectFile lastModified else log projectFile getAbsolutePath Project MSG_INFO projectFile null Document projectDocument null try if velocityPropertiesFile exists ve init velocityPropertiesFile getAbsolutePath else if templatePath null templatePath length ve setProperty RuntimeConstants FILE_RESOURCE_LOADER_PATH templatePath ve init styleSheetLastModified ve getTemplate style getLastModified if projectFile null projectDocument builder build projectFile catch Exception log toString Project MSG_INFO throw new BuildException scanner getDirectoryScanner baseDir list scanner getIncludedFiles for int list length process baseDir list destDir projectDocument private void process File baseDir String xmlFile File destDir Document projectDocument throws BuildException File outFile null File inFile null Writer writer null try inFile new File baseDir xmlFile outFile new File destDir xmlFile substring xmlFile lastIndexOf extension if lastModifiedCheck false inFile lastModified outFile lastModified styleSheetLastModified outFile lastModified projectFileLastModified outFile lastModified ensureDirectoryFor outFile log xmlFile Project MSG_INFO Document root builder build inFile VelocityContext context new VelocityContext String encoding String ve getProperty RuntimeConstants OUTPUT_ENCODING if encoding null encoding length encoding equals encoding equals encoding OutputWrapper ow new OutputWrapper ow setEncoding encoding context put root getRootElement context put ow context put getRelativePath xmlFile context put new TreeWalker context put new XPathTool context put new Escape context put new java util Date if projectDocument null context put projectDocument getRootElement writer new BufferedWriter new OutputStreamWriter new FileOutputStream outFile encoding Template template ve getTemplate style template merge context writer log outFile Project MSG_INFO catch JDOMException if outFile null outFile delete if getCause null Throwable rootCause getCause if rootCause instanceof SAXParseException System out println System out println rootCause getMessage System out println SAXParseException rootCause getLineNumber SAXParseException rootCause getColumnNumber System out println else rootCause printStackTrace else printStackTrace catch Throwable if outFile null outFile delete printStackTrace finally if writer null try writer flush writer close catch Exception private String getRelativePath String file if file null file length return StringTokenizer st new StringTokenizer file int slashCount st countTokens StringBuffer sb new StringBuffer for int slashCount sb append if sb toString length return StringUtils chop sb toString else return private void ensureDirectoryFor File targetFile throws BuildException File directory new File targetFile getParent if directory exists if directory mkdirs throw new BuildException directory getAbsolutePath public class XPathTool public XPathTool public NodeList applyTo String xpathSpec Document doc return new NodeList XPathCache getXPath xpathSpec applyTo doc false public NodeList applyTo String xpathSpec Element elem return new NodeList XPathCache getXPath xpathSpec applyTo elem false public NodeList applyTo String xpathSpec List nodeSet return new NodeList XPathCache getXPath xpathSpec applyTo nodeSet false public class ASTText extends SimpleNode private char ctext public ASTText int id super id public ASTText Parser int id super id public Object jjtAccept ParserVisitor visitor Object data return visitor visit this data public Object init InternalContextAdapter context Object data throws Exception Token getFirstToken String text NodeUtils tokenLiteral ctext text toCharArray return data public boolean render InternalContextAdapter context Writer writer throws IOException writer write ctext return true public interface Node public void jjtOpen public void jjtClose public void jjtSetParent Node public Node jjtGetParent public void jjtAddChild Node int public Node jjtGetChild int public int jjtGetNumChildren public Object jjtAccept ParserVisitor visitor Object data public Object childrenAccept ParserVisitor visitor Object data public Token getFirstToken public Token getLastToken public int getType public Object init InternalContextAdapter context Object data throws Exception public boolean evaluate InternalContextAdapter context throws MethodInvocationException public Object value InternalContextAdapter context throws MethodInvocationException public boolean render InternalContextAdapter context Writer writer throws IOException MethodInvocationException ParseErrorException ResourceNotFoundException public Object execute Object InternalContextAdapter context throws MethodInvocationException public void setInfo int info public int getInfo public String literal public void setInvalid public boolean isInvalid public int getLine public int getColumn public class Info private int line private int column private String templateName public Info String tn int int templateName tn line column private Info public String getTemplateName return templateName public int getLine return line public int getColumn return column public class IntrospectorTestCase2 extends BaseTestCase IntrospectorTestCase2 super public IntrospectorTestCase2 String name super name public static junit framework Test suite return new IntrospectorTestCase2 public void runTest try Velocity init Method method String result Tester new Tester Object params new Foo new Foo method RuntimeSingleton getIntrospector getMethod Tester class params if method null fail result String method invoke params if result equals fail result method RuntimeSingleton getIntrospector getMethod Tester2 class params if method null fail catch Exception fail toString public interface Woogie public static class Bar implements Woogie int public static class Foo extends Bar int public static class Tester public static String find Woogie Object return public static String find Object Bar return public static String find Bar Bar return public static String find Object return public static String find Woogie return public static class Tester2 public static String find Woogie Object return public static String find Object Bar return public static String find Bar Object return public static String find Object return public static String find Woogie return public class IntrospectorTestCase3 extends BaseTestCase public IntrospectorTestCase3 String name super name public static Test suite return new TestSuite IntrospectorTestCase3 class public void testSimple throws Exception Method method String result String type MethodProvider mp new MethodProvider Object listIntInt new ArrayList new Integer new Integer Object listLongList new ArrayList new Long new ArrayList Object listLongInt new ArrayList new Long new Integer Object intInt new Integer new Integer Object longInt new Long new Integer Object longLong new Long new Long method RuntimeSingleton getIntrospector getMethod MethodProvider class listIntInt result String method invoke mp listIntInt assertTrue result equals method RuntimeSingleton getIntrospector getMethod MethodProvider class intInt result String method invoke mp intInt assertTrue result equals method RuntimeSingleton getIntrospector getMethod MethodProvider class longInt result String method invoke mp longInt assertTrue result equals method RuntimeSingleton getIntrospector getMethod MethodProvider class longLong result String method invoke mp longLong assertTrue result equals method RuntimeSingleton getIntrospector getMethod MethodProvider class listLongList result String method invoke mp listLongList assertTrue result equals Object oa null new Integer method RuntimeSingleton getIntrospector getMethod MethodProvider class oa result String method invoke mp oa assertTrue result equals public static class MethodProvider public String ii int int return public String lii List int int return public String lll List long List return public String lll List long int return public String lll List long return public String ll long long return public class ASTReference extends SimpleNode private static final int NORMAL_REFERENCE private static final int FORMAL_REFERENCE private static final int QUIET_REFERENCE private static final int RUNT private int referenceType private String nullString private String rootString private boolean escaped false private boolean computableReference true private String escPrefix private String morePrefix private String identifier private String literal null private int numChildren protected Info uberInfo public ASTReference int id super id public ASTReference Parser int id super id public Object jjtAccept ParserVisitor visitor Object data return visitor visit this data public Object init InternalContextAdapter context Object data throws Exception super init context data rootString getRoot numChildren jjtGetNumChildren if numChildren identifier jjtGetChild numChildren getFirstToken image uberInfo new Info context getCurrentTemplateName getLine getColumn return data public String getRootString return rootString public Object execute Object InternalContextAdapter context throws MethodInvocationException if referenceType RUNT return null Object result getVariableValue context rootString if result null return null try for int numChildren result jjtGetChild execute result context if result null return null return result catch MethodInvocationException mie rsvc error mie getMethodName rootString context getCurrentTemplateName this getLine this getColumn mie setReferenceName rootString throw mie public boolean render InternalContextAdapter context Writer writer throws IOException MethodInvocationException if referenceType RUNT writer write rootString return true Object value execute null context if escaped if value null writer write escPrefix writer write writer write nullString else writer write escPrefix writer write nullString return true EventCartridge ec context getEventCartridge if ec null value ec referenceInsert literal value if value null writer write escPrefix writer write escPrefix writer write morePrefix writer write nullString if referenceType QUIET_REFERENCE rsvc getBoolean RuntimeConstants RUNTIME_LOG_REFERENCE_LOG_INVALID true rsvc warn new ReferenceException context getCurrentTemplateName this return true else writer write escPrefix writer write morePrefix writer write value toString return true public boolean evaluate InternalContextAdapter context throws MethodInvocationException Object value execute null context if value null return false else if value instanceof Boolean if Boolean value booleanValue return true else return false else return true public Object value InternalContextAdapter context throws MethodInvocationException return computableReference execute null context null public boolean setValue InternalContextAdapter context Object value throws MethodInvocationException if jjtGetNumChildren context put rootString value return true Object result getVariableValue context rootString if result null rsvc error new ReferenceException context getCurrentTemplateName this return false for int numChildren result jjtGetChild execute result context if result null rsvc error new ReferenceException context getCurrentTemplateName this return false try VelPropertySet vs rsvc getUberspect getPropertySet result identifier value uberInfo if vs null return false vs invoke result value catch InvocationTargetException ite throw new MethodInvocationException identifier result getClass ite getTargetException getClass ite getTargetException identifier catch Exception rsvc error context getCurrentTemplateName this getLine this getColumn return false return true private String getRoot Token getFirstToken int slashbang image indexOf if slashbang int int len image length image indexOf if rsvc error computableReference false nullString image return nullString while len image charAt int start int count while len image charAt count computableReference false return nullString escaped false if image startsWith int int len image length while len image charAt if escaped true if escPrefix image substring image image substring int loc1 image lastIndexOf if loc1 morePrefix morePrefix image substring loc1 image image substring loc1 nullString literal if image startsWith referenceType QUIET_REFERENCE if escaped nullString if image startsWith return next image else return image substring else if image equals referenceType FORMAL_REFERENCE return next image else if image startsWith referenceType NORMAL_REFERENCE return image substring else referenceType RUNT return image public Object getVariableValue Context context String variable return context get variable public void setLiteral String literal if this literal null this literal literal public String literal if literal null return literal return super literal public class ASTNotNode extends SimpleNode public ASTNotNode int id super id public ASTNotNode Parser int id super id public Object jjtAccept ParserVisitor visitor Object data return visitor visit this data public boolean evaluate InternalContextAdapter context throws MethodInvocationException if jjtGetChild evaluate context return false else return true public Object value InternalContextAdapter context throws MethodInvocationException return jjtGetChild evaluate context Boolean FALSE Boolean TRUE public interface MethodExceptionEventHandler extends EventHandler public Object methodException Class claz String method Exception throws Exception public class GetExecutor extends AbstractExecutor private Object args new Object public GetExecutor RuntimeLogger Introspector ispect Class String key throws Exception rlog args key method ispect getMethod args public Object execute Object throws IllegalAccessException InvocationTargetException if method null return null return method invoke args public Object OLDexecute Object InternalContextAdapter context throws IllegalAccessException MethodInvocationException if method null return null try return method invoke args catch InvocationTargetException ite throw new MethodInvocationException args getClass ite getTargetException getClass ite getTargetException catch IllegalArgumentException iae return null public interface TemplateTestBase public final static String TMPL_FILE_EXT public final static String CMP_FILE_EXT public final static String RESULT_FILE_EXT public final static String FILE_RESOURCE_LOADER_PATH public final static String TEST_CASE_PROPERTIES FILE_RESOURCE_LOADER_PATH public final static String RESULT_DIR FILE_RESOURCE_LOADER_PATH public final static String COMPARE_DIR FILE_RESOURCE_LOADER_PATH public class ASTOrNode extends SimpleNode public ASTOrNode int id super id public ASTOrNode Parser int id super id public Object jjtAccept ParserVisitor visitor Object data return visitor visit this data public Object value InternalContextAdapter context throws MethodInvocationException return new Boolean evaluate context public boolean evaluate InternalContextAdapter context throws MethodInvocationException Node left jjtGetChild Node right jjtGetChild if left null left evaluate context return true if right null right evaluate context return true return false public class ExternalLoggerTest extends TestCase implements LogSystem private String logString null private VelocityEngine ve null public ExternalLoggerTest super try ve new VelocityEngine ve setProperty VelocityEngine RUNTIME_LOG_LOGSYSTEM this ve init catch Exception System err println System exit public void init RuntimeServices rs public static junit framework Test suite return new ExternalLoggerTest public void runTest logString null String testString ve warn testString if logString null logString equals VelocityEngine WARN_PREFIX testString fail public void logVelocityMessage int level String message String out switch level case LogSystem DEBUG_ID out VelocityEngine DEBUG_PREFIX break case LogSystem INFO_ID out VelocityEngine INFO_PREFIX break case LogSystem WARN_ID out VelocityEngine WARN_PREFIX break case LogSystem ERROR_ID out VelocityEngine ERROR_PREFIX break default out VelocityEngine UNKNOWN_PREFIX break logString out message public class BaseTestCase extends TestCase private Perl5Util perl new Perl5Util public BaseTestCase String name super name protected static String getFileName String dir String base String ext StringBuffer buf new StringBuffer if dir null buf append dir append buf append base append append ext return buf toString protected static void assureResultsDirectoryExists String resultsDirectory File dir new File resultsDirectory if dir exists RuntimeSingleton info if dir mkdirs RuntimeSingleton info else String errMsg RuntimeSingleton warn errMsg fail errMsg protected String normalizeNewlines String source return perl substitute source protected boolean isMatch String resultsDir String compareDir String baseFileName String resultExt String compareExt throws Exception String result StringUtils fileContentsToString getFileName resultsDir baseFileName resultExt String compare StringUtils fileContentsToString getFileName compareDir baseFileName compareExt return normalizeNewlines result equals normalizeNewlines compare protected static final String getTestCaseName String StringBuffer name new StringBuffer name append Character toTitleCase charAt name append substring length toLowerCase return name toString public class Log4JLogSystem implements LogSystem private RuntimeServices rsvc null protected Category logger null protected Layout layout null private String logfile public Log4JLogSystem public void init RuntimeServices rs rsvc rs logfile rsvc getString RuntimeConstants RUNTIME_LOG try internalInit logVelocityMessage logfile catch Exception System out println private void internalInit throws Exception logger Category getInstance logger setAdditivity false logger setPriority Priority DEBUG String pattern rsvc getString RuntimeConstants LOGSYSTEM_LOG4J_PATTERN if pattern null pattern length pattern layout new PatternLayout pattern configureFile configureRemote configureSyslog configureEmail private void configureFile throws Exception int backupFiles rsvc getInt RuntimeConstants LOGSYSTEM_LOG4J_FILE_BACKUPS int fileSize rsvc getInt RuntimeConstants LOGSYSTEM_LOG4J_FILE_SIZE Appender appender new RollingFileAppender layout logfile true RollingFileAppender appender setMaxBackupIndex backupFiles if fileSize RollingFileAppender appender setMaximumFileSize fileSize logger addAppender appender private void configureRemote throws Exception String remoteHost rsvc getString RuntimeConstants LOGSYSTEM_LOG4J_REMOTE_HOST int remotePort rsvc getInt RuntimeConstants LOGSYSTEM_LOG4J_REMOTE_PORT if remoteHost null remoteHost trim equals remotePort return Appender appender new SocketAppender remoteHost remotePort logger addAppender appender private void configureSyslog throws Exception String syslogHost rsvc getString RuntimeConstants LOGSYSTEM_LOG4J_SYSLOGD_HOST String syslogFacility rsvc getString RuntimeConstants LOGSYSTEM_LOG4J_SYSLOGD_FACILITY if syslogHost null syslogHost trim equals syslogFacility null return Appender appender new SyslogAppender SyslogAppender appender setLayout layout SyslogAppender appender setSyslogHost syslogHost SyslogAppender appender setFacility syslogFacility logger addAppender appender private void configureEmail throws Exception String smtpHost rsvc getString RuntimeConstants LOGSYSTEM_LOG4J_EMAIL_SERVER String emailFrom rsvc getString RuntimeConstants LOGSYSTEM_LOG4J_EMAIL_FROM String emailTo rsvc getString RuntimeConstants LOGSYSTEM_LOG4J_EMAIL_TO String emailSubject rsvc getString RuntimeConstants LOGSYSTEM_LOG4J_EMAIL_SUBJECT String bufferSize rsvc getString RuntimeConstants LOGSYSTEM_LOG4J_EMAIL_BUFFER_SIZE if smtpHost null smtpHost trim equals emailFrom null smtpHost trim equals emailTo null emailTo trim equals emailSubject null emailSubject trim equals bufferSize null bufferSize trim equals return SMTPAppender appender new SMTPAppender appender setSMTPHost smtpHost appender setFrom emailFrom appender setTo emailTo appender setSubject emailSubject appender setBufferSize Integer parseInt bufferSize appender setLayout layout appender activateOptions logger addAppender appender public void logVelocityMessage int level String message switch level case LogSystem WARN_ID logger warn message break case LogSystem INFO_ID logger info message break case LogSystem DEBUG_ID logger debug message break case LogSystem ERROR_ID logger error message break default logger debug message break protected void finalize throws Throwable shutdown public void shutdown Enumeration appenders logger getAllAppenders while appenders hasMoreElements Appender appender Appender appenders nextElement appender close public class ASTIntegerRange extends SimpleNode public ASTIntegerRange int id super id public ASTIntegerRange Parser int id super id public Object jjtAccept ParserVisitor visitor Object data return visitor visit this data public Object value InternalContextAdapter context throws MethodInvocationException Object left jjtGetChild value context Object right jjtGetChild value context if left null right null rsvc error left null context getCurrentTemplateName getLine getColumn return null if left instanceof Integer right instanceof Integer rsvc error left instanceof Integer context getCurrentTemplateName getLine getColumn return null int Integer left intValue int Integer right intValue int num Math abs num int delta ArrayList foo new ArrayList int val for int num foo add new Integer val val delta return foo public class ResourceManagerImpl implements ResourceManager public static final int RESOURCE_TEMPLATE public static final int RESOURCE_CONTENT private static final String RESOURCE_LOADER_IDENTIFIER protected ResourceCache globalCache null protected ArrayList resourceLoaders new ArrayList private ArrayList sourceInitializerList new ArrayList private Hashtable sourceInitializerMap new Hashtable private boolean resourceLoaderInitializersActive false private boolean logWhenFound true protected RuntimeServices rsvc null public void initialize RuntimeServices rs throws Exception rsvc rs rsvc info this getClass ResourceLoader resourceLoader assembleResourceLoaderInitializers for int sourceInitializerList size ExtendedProperties configuration ExtendedProperties sourceInitializerList get String loaderClass configuration getString if loaderClass null rsvc error configuration getString RESOURCE_LOADER_IDENTIFIER continue resourceLoader ResourceLoaderFactory getLoader rsvc loaderClass resourceLoader commonInit rsvc configuration resourceLoader init configuration resourceLoaders add resourceLoader logWhenFound rsvc getBoolean RuntimeConstants RESOURCE_MANAGER_LOGWHENFOUND true String claz rsvc getString RuntimeConstants RESOURCE_MANAGER_CACHE_CLASS Object null if claz null claz length try Class forName claz newInstance catch ClassNotFoundException cnfe String err claz rsvc error err null if instanceof ResourceCache String err claz rsvc error err null if null new ResourceCacheImpl globalCache ResourceCache globalCache initialize rsvc rsvc info private void assembleResourceLoaderInitializers if resourceLoaderInitializersActive return Vector resourceLoaderNames rsvc getConfiguration getVector RuntimeConstants RESOURCE_LOADER for int resourceLoaderNames size String loaderID resourceLoaderNames get RuntimeConstants RESOURCE_LOADER ExtendedProperties loaderConfiguration rsvc getConfiguration subset loaderID if loaderConfiguration null rsvc warn resourceLoaderNames get continue loaderConfiguration setProperty RESOURCE_LOADER_IDENTIFIER resourceLoaderNames get sourceInitializerList add loaderConfiguration resourceLoaderInitializersActive true public Resource getResource String resourceName int resourceType String encoding throws ResourceNotFoundException ParseErrorException Exception Resource resource globalCache get resourceName if resource null try refreshResource resource encoding catch ResourceNotFoundException rnfe globalCache remove resourceName return getResource resourceName resourceType encoding catch ParseErrorException pee rsvc error pee throw pee catch Exception eee rsvc error eee throw eee else try resource loadResource resourceName resourceType encoding if resource getResourceLoader isCachingOn globalCache put resourceName resource catch ResourceNotFoundException rnfe2 rsvc error resourceName throw rnfe2 catch ParseErrorException pee rsvc error pee throw pee catch Exception ee rsvc error ee throw ee return resource protected Resource loadResource String resourceName int resourceType String encoding throws ResourceNotFoundException ParseErrorException Exception Resource resource ResourceFactory getResource resourceName resourceType resource setRuntimeServices rsvc resource setName resourceName resource setEncoding encoding ResourceLoader resourceLoader null for int resourceLoaders size resourceLoader ResourceLoader resourceLoaders get resource setResourceLoader resourceLoader try if resource process if logWhenFound rsvc info resourceName resourceLoader getClassName howOldItWas resourceLoader getLastModified resource break catch ResourceNotFoundException rnfe if resource getData null throw new ResourceNotFoundException resourceName resource setLastModified howOldItWas resource setModificationCheckInterval resourceLoader getModificationCheckInterval resource touch return resource protected void refreshResource Resource resource String encoding throws ResourceNotFoundException ParseErrorException Exception if resource requiresChecking resource touch if resource isSourceModified if resource getEncoding equals encoding rsvc error resource getName resource getEncoding encoding resource setEncoding encoding long howOldItWas resource getResourceLoader getLastModified resource resource process resource setLastModified howOldItWas public Resource getResource String resourceName int resourceType throws ResourceNotFoundException ParseErrorException Exception return getResource resourceName resourceType RuntimeConstants ENCODING_DEFAULT public String getLoaderNameForResource String resourceName ResourceLoader resourceLoader null for int resourceLoaders size resourceLoader ResourceLoader resourceLoaders get InputStream is null try is resourceLoader getResourceStream resourceName if is null return resourceLoader getClass toString catch ResourceNotFoundException finally if is null try is close catch IOException ioe return null public class ParseException extends Exception public ParseException Token currentTokenVal int expectedTokenSequencesVal String tokenImageVal super specialConstructor true currentToken currentTokenVal expectedTokenSequences expectedTokenSequencesVal tokenImage tokenImageVal public ParseException super specialConstructor false public ParseException String message super message specialConstructor false protected boolean specialConstructor public Token currentToken public int expectedTokenSequences public String tokenImage public String getMessage if specialConstructor return super getMessage String expected int maxSize for int expectedTokenSequences length if maxSize expectedTokenSequences length maxSize expectedTokenSequences length for int expectedTokenSequences length expected tokenImage expectedTokenSequences if expectedTokenSequences expectedTokenSequences length expected expected eol String retval Token tok currentToken next for int maxSize if retval if tok kind retval tokenImage break retval add_escapes tok image tok tok next retval currentToken next beginLine currentToken next beginColumn retval eol if expectedTokenSequences length retval eol else retval eol retval expected return retval protected String eol System getProperty protected String add_escapes String str StringBuffer retval new StringBuffer char ch for int str length switch str charAt case continue case retval append continue case retval append continue case retval append continue case retval append continue case retval append continue case retval append continue case retval append continue case retval append continue default if ch str charAt ch String Integer toString ch retval append substring length length else retval append ch continue return retval toString public class AnakiaTestCase extends BaseTestCase private static final String COMPARE_DIR private static final String RESULTS_DIR private static final String FILE_EXT public AnakiaTestCase super public static junit framework Test suite return new AnakiaTestCase public void runTest try assureResultsDirectoryExists RESULTS_DIR if isMatch RESULTS_DIR COMPARE_DIR FILE_EXT FILE_EXT fail else System out println catch Exception public class ResourceFactory public static Resource getResource String resourceName int resourceType Resource resource null switch resourceType case ResourceManager RESOURCE_TEMPLATE resource new Template break case ResourceManager RESOURCE_CONTENT resource new ContentResource break return resource public class ASTEQNode extends SimpleNode public ASTEQNode int id super id public ASTEQNode Parser int id super id public Object jjtAccept ParserVisitor visitor Object data return visitor visit this data public boolean evaluate InternalContextAdapter context throws MethodInvocationException Object left jjtGetChild value context Object right jjtGetChild value context if left null right null rsvc error left null jjtGetChild left null literal context getCurrentTemplateName getLine getColumn return false if left getClass equals right getClass return left equals right else rsvc error left getClass right getClass context getCurrentTemplateName getLine getColumn return false public Object value InternalContextAdapter context throws MethodInvocationException boolean val evaluate context return val Boolean TRUE Boolean FALSE public class EncodingTestCase extends BaseTestCase implements TemplateTestBase public EncodingTestCase super try Velocity setProperty Velocity FILE_RESOURCE_LOADER_PATH FILE_RESOURCE_LOADER_PATH Velocity setProperty Velocity INPUT_ENCODING Velocity init catch Exception System err println printStackTrace System exit public static junit framework Test suite return new EncodingTestCase public void runTest VelocityContext context new VelocityContext try assureResultsDirectoryExists RESULT_DIR Template template Velocity getTemplate getFileName null TMPL_FILE_EXT FileOutputStream fos new FileOutputStream getFileName RESULT_DIR RESULT_FILE_EXT Writer writer new BufferedWriter new OutputStreamWriter fos template merge context writer writer flush writer close if isMatch RESULT_DIR COMPARE_DIR RESULT_FILE_EXT CMP_FILE_EXT fail template Velocity getTemplate getFileName null TMPL_FILE_EXT fos new FileOutputStream getFileName RESULT_DIR RESULT_FILE_EXT writer new BufferedWriter new OutputStreamWriter fos template merge context writer writer flush writer close if isMatch RESULT_DIR COMPARE_DIR RESULT_FILE_EXT CMP_FILE_EXT fail template Velocity getTemplate getFileName null TMPL_FILE_EXT fos new FileOutputStream getFileName RESULT_DIR RESULT_FILE_EXT writer new BufferedWriter new OutputStreamWriter fos template merge context writer writer flush writer close if isMatch RESULT_DIR COMPARE_DIR RESULT_FILE_EXT CMP_FILE_EXT fail template Velocity getTemplate getFileName null TMPL_FILE_EXT fos new FileOutputStream getFileName RESULT_DIR RESULT_FILE_EXT writer new BufferedWriter new OutputStreamWriter fos template merge context writer writer flush writer close if isMatch RESULT_DIR COMPARE_DIR RESULT_FILE_EXT CMP_FILE_EXT fail catch Exception fail getMessage public class RuntimeSingleton implements RuntimeConstants private static RuntimeInstance ri new RuntimeInstance public synchronized static void init throws Exception ri init public static RuntimeServices getRuntimeServices return ri public static void setProperty String key Object value ri setProperty key value public static void setConfiguration ExtendedProperties configuration ri setConfiguration configuration public static void addProperty String key Object value ri addProperty key value public static void clearProperty String key ri clearProperty key public static Object getProperty String key return ri getProperty key public static void init Properties throws Exception ri init public static void init String configurationFile throws Exception ri init configurationFile private static Parser createNewParser return ri createNewParser public static SimpleNode parse Reader reader String templateName throws ParseException return ri parse reader templateName public static SimpleNode parse Reader reader String templateName boolean dumpNamespace throws ParseException return ri parse reader templateName dumpNamespace public static Template getTemplate String name throws ResourceNotFoundException ParseErrorException Exception return ri getTemplate name public static Template getTemplate String name String encoding throws ResourceNotFoundException ParseErrorException Exception return ri getTemplate name encoding public static ContentResource getContent String name throws ResourceNotFoundException ParseErrorException Exception return ri getContent name public static ContentResource getContent String name String encoding throws ResourceNotFoundException ParseErrorException Exception return ri getContent name encoding public static String getLoaderNameForResource String resourceName return ri getLoaderNameForResource resourceName public static void warn Object message ri warn message public static void info Object message ri info message public static void error Object message ri error message public static void debug Object message ri debug message public static String getString String key String defaultValue return ri getString key defaultValue public static Directive getVelocimacro String vmName String templateName return ri getVelocimacro vmName templateName public static boolean addVelocimacro String name String macro String argArray String sourceTemplate return ri addVelocimacro name macro argArray sourceTemplate public static boolean isVelocimacro String vmName String templateName return ri isVelocimacro vmName templateName public static boolean dumpVMNamespace String namespace return ri dumpVMNamespace namespace public static String getString String key return ri getString key public static int getInt String key return ri getInt key public static int getInt String key int defaultValue return ri getInt key defaultValue public static boolean getBoolean String key boolean def return ri getBoolean key def public static ExtendedProperties getConfiguration return ri getConfiguration public static Introspector getIntrospector return ri getIntrospector public static Object getApplicationAttribute Object key return ri getApplicationAttribute key public static Uberspect getUberspect return ri getUberspect public static RuntimeInstance getRuntimeInstance return ri public class IntrospectionCacheData public Object thingy public Class contextData public class ASTComment extends SimpleNode private static final char ZILCH toCharArray private char carr public ASTComment int id super id public ASTComment Parser int id super id public Object jjtAccept ParserVisitor visitor Object data return visitor visit this data public Object init InternalContextAdapter context Object data throws Exception Token getFirstToken int loc1 image indexOf int loc2 image indexOf if loc1 loc2 carr ZILCH else carr image substring loc1 loc2 loc1 toCharArray return data public boolean render InternalContextAdapter context Writer writer throws IOException MethodInvocationException ParseErrorException ResourceNotFoundException writer write carr return true public interface VelPropertyGet public Object invoke Object throws Exception public boolean isCacheable public String getMethodName public interface Uberspect public void init throws Exception public Iterator getIterator Object obj Info info throws Exception public VelMethod getMethod Object obj String method Object args Info info throws Exception public VelPropertyGet getPropertyGet Object obj String identifier Info info throws Exception public VelPropertySet getPropertySet Object obj String identifier Object arg Info info throws Exception public class TexenClasspathTestCase extends BaseTestCase private static final String RESULTS_DIR private static final String COMPARE_DIR public TexenClasspathTestCase super public static junit framework Test suite return new TexenClasspathTestCase protected void setUp public void runTest try assureResultsDirectoryExists RESULTS_DIR if isMatch RESULTS_DIR COMPARE_DIR isMatch RESULTS_DIR COMPARE_DIR isMatch RESULTS_DIR COMPARE_DIR isMatch RESULTS_DIR COMPARE_DIR isMatch RESULTS_DIR COMPARE_DIR fail catch Exception public class ASTTrue extends SimpleNode private static Boolean value Boolean TRUE public ASTTrue int id super id public ASTTrue Parser int id super id public Object jjtAccept ParserVisitor visitor Object data return visitor visit this data public boolean evaluate InternalContextAdapter context return true public Object value InternalContextAdapter context return value public class ClassloaderChangeTest extends TestCase implements LogSystem private VelocityEngine ve null private boolean sawCacheDump false private static String OUTPUT public ClassloaderChangeTest super try ve new VelocityEngine ve setProperty VelocityEngine RUNTIME_LOG_LOGSYSTEM this ve init catch Exception System err println System exit public void init RuntimeServices rs public static junit framework Test suite return new ClassloaderChangeTest public void runTest sawCacheDump false try VelocityContext vc new VelocityContext Object foo null TestClassloader cl new TestClassloader Class fooclass cl loadClass foo fooclass newInstance vc put foo StringWriter writer new StringWriter ve evaluate vc writer if writer toString equals OUTPUT fail cl new TestClassloader fooclass cl loadClass foo fooclass newInstance vc put foo writer new StringWriter ve evaluate vc writer if writer toString equals OUTPUT fail catch Exception ee System out println ee if sawCacheDump fail public void logVelocityMessage int level String message if message equals Introspector CACHEDUMP_MSG sawCacheDump true class TestClassloader extends ClassLoader private final static String testclass private Class fooClass null public TestClassloader try File new File testclass byte barr new byte int length FileInputStream fis new FileInputStream fis read barr fis close fooClass defineClass barr barr length catch Exception System out println public Class findClass String name return fooClass public interface CharStream char readChar throws java io IOException int getColumn int getLine int getEndColumn int getEndLine int getBeginColumn int getBeginLine void backup int amount char BeginToken throws java io IOException String GetImage char GetSuffix int len void Done 